---
title: "Figure xxx and associated supplementary material"
output:
  pdf_document: default
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: console
---
```{r, echo=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(fig.width = 15, fig.height = 17, echo = FALSE, results = "hide", warning = FALSE, message = FALSE)
```


```{r}
library(Metrics)
library(tidyverse)
library(reshape2)
library(scales)
library(ggpubr)
library(EpiDISH)
library(stringr)
library(grid)

tcga_deconv <- read.table("/mnt/SERVER-CRCT-STORAGE/CRCT21/Private/julien/gemdecan/data/all_deconvolutions/all_deconvolutions_all_TCGA.txt", header = T)
Aran_all_facs <- read.csv("/mnt/SERVER-CRCT-STORAGE/CRCT21/Private/Julien/gemdecan/data/facs/Aran_facs.csv", sep = "\t")
HE_all_TCGA <- read.csv("/mnt/SERVER-CRCT-STORAGE/CRCT21/Private/Julien/gemdecan/data/HE_fractions.csv", row.names = 1)

tcga_deconv$Samples <- tcga_deconv$Samples %>%
  str_remove_all(., ".01A*") %>%
  str_replace_all(., "-", ".")

# REMOVE NON UNIQUE SAMPLES IN TCGA CBX AND DECONV
tcga_deconv <- tcga_deconv %>%
  group_by(Samples) %>%
  summarise_all(mean) %>%
  as.data.frame()

HE_all_TCGA$ParticipantBarcode <- HE_all_TCGA$ParticipantBarcode %>% str_replace_all(., "-", ".")

Aran_all_facs$Sample_ID <- Aran_all_facs$Sample_ID %>%
  str_remove_all(., ".01A.*") %>%
  str_replace_all(., "-", ".")

```

## COAD 

```{r}

COAD_methy_decon <- read.table("/mnt/SERVER-CRCT-STORAGE/CRCT21/Private/Julien/gemdecan/data/meth/COAD.txt", sep = "\t", header = T)

Facs_COAD <- Aran_all_facs[Aran_all_facs$Cancer_type == "COAD", ]

HE_COAD <- HE_all_TCGA[HE_all_TCGA$Study == "COAD", ]

Facs_COAD_modif <- Facs_COAD[Facs_COAD$CPE != "NaN", ]

Comm_samples <- Reduce(intersect, list(HE_COAD$ParticipantBarcode, Facs_COAD_modif$Sample_ID, tcga_deconv$Samples, rownames(COAD_methy_decon)))

Facs_COAD_modif <- Facs_COAD_modif %>% .[.$Sample_ID %in% Comm_samples, ]

HE_COAD_modif <- HE_COAD %>%
  .[.$ParticipantBarcode %in% Comm_samples, ] %>%
  .[order(.$ParticipantBarcode), ]

COAD_methy_decon <- COAD_methy_decon[Comm_samples, ] %>% 
  rownames_to_column() 
COAD_methy_decon <- COAD_methy_decon[order(COAD_methy_decon$rowname), ]
rownames(COAD_methy_decon) <- COAD_methy_decon$rowname
COAD_methy_decon <- COAD_methy_decon[,-1]

COAD_RNA_decon <- tcga_deconv %>% filter(Samples %in% Comm_samples)

###################################
##### Estimating Tumor Purity #####
###################################


COAD_BPRNACan_decon <- COAD_RNA_decon %>% select(colnames(COAD_RNA_decon)[grepl("Epidish_BPRNACan_", colnames(COAD_RNA_decon))])
colnames(COAD_BPRNACan_decon) <- colnames(COAD_BPRNACan_decon) %>% str_remove_all("Epidish_BPRNACan_")

a <- cbind(COAD_BPRNACan_decon$cancer, Facs_COAD_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_COAD_BPRNACan <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "COAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0.8, 1.2), breaks = seq(0.0, 1.2, 0.1)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.42, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(COAD_BPRNACan_decon$cancer), as.matrix(Facs_COAD_modif$CPE))$est, 2), "~','", "~italic(P)<", round(cor.test(as.matrix(COAD_BPRNACan_decon$cancer), as.matrix(Facs_COAD_modif$CPE))$p.value, 14)), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.15, label = paste("RMSE =", round(sqrt(mean((as.matrix(COAD_BPRNACan_decon$cancer) - as.matrix(Facs_COAD_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 1.1, label = paste("n = ", nrow(COAD_BPRNACan_decon)), size = 4)


COAD_BPRNACanProMet_decon <- COAD_RNA_decon %>% select(colnames(COAD_RNA_decon)[grepl("Epidish_BPRNACanProMet_", colnames(COAD_RNA_decon))])
colnames(COAD_BPRNACanProMet_decon) <- colnames(COAD_BPRNACanProMet_decon) %>% str_remove_all("Epidish_BPRNACanProMet_")

a <- cbind(COAD_BPRNACanProMet_decon$cancer, Facs_COAD_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_COAD_BPRNACanProMet <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "COAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0.8, 1.2), breaks = seq(0.0, 1.2, 0.1)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.45, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(COAD_BPRNACanProMet_decon$cancer), as.matrix(Facs_COAD_modif$CPE))$est, 2), "~','", "~italic(P)<", round(cor.test(as.matrix(COAD_BPRNACanProMet_decon$cancer), as.matrix(Facs_COAD_modif$CPE))$p.value, 14)), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.15, label = paste("RMSE =", round(sqrt(mean((as.matrix(COAD_BPRNACanProMet_decon$cancer) - as.matrix(Facs_COAD_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 1.1, label = paste("n = ", nrow(COAD_BPRNACanProMet_decon)), size = 4)


COAD_BPRNACan3DProMet_decon <- COAD_RNA_decon %>% select(colnames(COAD_RNA_decon)[grepl("Epidish_BPRNACan3DProMet_", colnames(COAD_RNA_decon))])
colnames(COAD_BPRNACan3DProMet_decon) <- colnames(COAD_BPRNACan3DProMet_decon) %>% str_remove_all("Epidish_BPRNACan3DProMet_")


a <- cbind(COAD_BPRNACan3DProMet_decon$cancer, Facs_COAD_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_COAD_BPRNACan3DProMet <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "COAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0.8, 1.2), breaks = seq(0.0, 1.2, 0.1)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.52, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(COAD_BPRNACan3DProMet_decon$cancer), as.matrix(Facs_COAD_modif$CPE))$est, 2), "~','", "~italic(P)<", round(cor.test(as.matrix(COAD_BPRNACan3DProMet_decon$cancer), as.matrix(Facs_COAD_modif$CPE))$p.value, 14)), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.15, label = paste("RMSE =", round(sqrt(mean((as.matrix(COAD_BPRNACan3DProMet_decon$cancer) - as.matrix(Facs_COAD_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 1.1, label = paste("n = ", nrow(COAD_BPRNACan3DProMet_decon)), size = 4)

###### Methylation part

a <- cbind(COAD_methy_decon$cancer, Facs_COAD_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_COAD_BPmetCan <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "COAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0, 1.2), breaks = seq(0.0, 1.2, 0.2)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.45, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(COAD_methy_decon$cancer), as.matrix(Facs_COAD_modif$CPE))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.05, label = paste("RMSE =", round(sqrt(mean((as.matrix(COAD_methy_decon$cancer) - as.matrix(Facs_COAD_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 0.9, label = paste("n = ", nrow(COAD_methy_decon)), size = 4)


###############################################################
##### Estimating Lymphocytes, Macrophages and Neutrophils #####
###############################################################

##### RNA expression Part #####

#### lymph

lymph_COAD_BPRNACan <- COAD_BPRNACan_decon$B + COAD_BPRNACan_decon$CD4 + COAD_BPRNACan_decon$CD8 + COAD_BPRNACan_decon$NK

a <- cbind(lymph_COAD_BPRNACan, HE_COAD_modif$Lymphocytes)
colnames(a) <- c("lymph_fractions", "HE")

Fig_COAD_lymph_BPRNACan <- ggscatter(data.frame(a), x = "HE", y = "lymph_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "COAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.08)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.235, y = 0.08, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_COAD_BPRNACan), as.matrix(HE_COAD_modif$Lymphocytes))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.07, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_COAD_BPRNACan) - as.matrix(HE_COAD_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.06, label = paste("n = ", nrow(COAD_methy_decon)), size = 4)



lymph_COAD_BPRNACanProMet <- COAD_BPRNACanProMet_decon$B + COAD_BPRNACanProMet_decon$CD4 + COAD_BPRNACanProMet_decon$CD8 + COAD_BPRNACanProMet_decon$NK

a <- cbind(lymph_COAD_BPRNACanProMet, HE_COAD_modif$Lymphocytes)
colnames(a) <- c("lymph_fractions", "HE")

Fig_COAD_lymph_BPRNACanProMet <- ggscatter(data.frame(a), x = "HE", y = "lymph_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "COAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.08)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.235, y = 0.08, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_COAD_BPRNACanProMet), as.matrix(HE_COAD_modif$Lymphocytes))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(lymph_COAD_BPRNACanProMet), as.matrix(HE_COAD_modif$Lymphocytes))$p.value, 13)), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.07, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_COAD_BPRNACanProMet) - as.matrix(HE_COAD_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.06, label = paste("n = ", nrow(COAD_BPRNACanProMet_decon)), size = 4)


lymph_COAD_BPRNACan3DProMet <- COAD_BPRNACan3DProMet_decon$B + COAD_BPRNACan3DProMet_decon$CD4 + COAD_BPRNACan3DProMet_decon$CD8 + COAD_BPRNACan3DProMet_decon$NK

a <- cbind(lymph_COAD_BPRNACan3DProMet, HE_COAD_modif$Lymphocytes)
colnames(a) <- c("lymph_fractions", "HE")

Fig_COAD_lymph_BPRNACan3DProMet <- ggscatter(data.frame(a), x = "HE", y = "lymph_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "COAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.08)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.235, y = 0.08, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_COAD_BPRNACan3DProMet), as.matrix(HE_COAD_modif$Lymphocytes))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(lymph_COAD_BPRNACan3DProMet), as.matrix(HE_COAD_modif$Lymphocytes))$p.value, 13)), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.07, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_COAD_BPRNACan3DProMet) - as.matrix(HE_COAD_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.06, label = paste("n = ", nrow(COAD_BPRNACanProMet_decon)), size = 4)


#### Macro

Macro_COAD_BPRNACan <- COAD_BPRNACan_decon$M0 + COAD_BPRNACan_decon$M1 + COAD_BPRNACan_decon$M2 + COAD_BPRNACan_decon$Mono

a <- cbind(Macro_COAD_BPRNACan, HE_COAD_modif$Macrophages)
colnames(a) <- c("Macro_fractions", "HE")

Fig_COAD_Macro_BPRNACan <- ggscatter(data.frame(a), x = "HE", y = "Macro_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "COAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.4)) + scale_y_continuous(name = NULL, limits = c(0, 0.06)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.175, y = 0.06, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_COAD_BPRNACan), as.matrix(HE_COAD_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.11, y = 0.0526, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_COAD_BPRNACan) - as.matrix(HE_COAD_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.08, y = 0.045, label = paste("n = ", nrow(COAD_BPRNACan_decon)), size = 4)



Macro_COAD_BPRNACanProMet <- COAD_BPRNACanProMet_decon$M0 + COAD_BPRNACanProMet_decon$M1 + COAD_BPRNACanProMet_decon$M2 + COAD_BPRNACanProMet_decon$Mono

a <- cbind(Macro_COAD_BPRNACanProMet, HE_COAD_modif$Macrophages)
colnames(a) <- c("Macro_fractions", "HE")

Fig_COAD_Macro_BPRNACanProMet <- ggscatter(data.frame(a), x = "HE", y = "Macro_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "COAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.4)) + scale_y_continuous(name = NULL, limits = c(0, 0.06)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.185, y = 0.06, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_COAD_BPRNACanProMet), as.matrix(HE_COAD_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.11, y = 0.0526, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_COAD_BPRNACanProMet) - as.matrix(HE_COAD_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.08, y = 0.045, label = paste("n = ", nrow(COAD_BPRNACan_decon)), size = 4)

Macro_COAD_BPRNACan3DProMet <- COAD_BPRNACan3DProMet_decon$M0 + COAD_BPRNACan3DProMet_decon$M1 + COAD_BPRNACan3DProMet_decon$M2 + COAD_BPRNACan3DProMet_decon$Mono

a <- cbind(Macro_COAD_BPRNACan3DProMet, HE_COAD_modif$Macrophages)
colnames(a) <- c("Macro_fractions", "HE")

Fig_COAD_Macro_BPRNACan3DProMet <- ggscatter(data.frame(a), x = "HE", y = "Macro_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "COAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.4)) + scale_y_continuous(name = NULL, limits = c(0, 0.06)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.185, y = 0.06, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_COAD_BPRNACan3DProMet), as.matrix(HE_COAD_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.11, y = 0.0526, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_COAD_BPRNACan3DProMet) - as.matrix(HE_COAD_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.08, y = 0.045, label = paste("n = ", nrow(COAD_BPRNACan_decon)), size = 4)

#### Neutrophis

a <- cbind(COAD_BPRNACan_decon$Neu, HE_COAD_modif$Neutrophils)
colnames(a) <- c("Neu_fractions", "HE")

Fig_COAD_Neu_BPRNACan <- ggscatter(data.frame(a), x = "HE", y = "Neu_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "COAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.006)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.015, y = 0.006, label = paste("italic(r)==", round(cor.test(as.matrix(COAD_BPRNACan_decon$Neu), as.matrix(HE_COAD_modif$Neutrophils))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.009, y = 0.00525, label = paste("RMSE =", round(sqrt(mean((as.matrix(COAD_BPRNACan_decon$Neu) - as.matrix(HE_COAD_modif$Neutrophils))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.0065, y = 0.0046, label = paste("n = ", nrow(COAD_BPRNACan_decon)), size = 4)


a <- cbind(COAD_BPRNACanProMet_decon$Neu, HE_COAD_modif$Neutrophils)
colnames(a) <- c("Neu_fractions", "HE")

Fig_COAD_Neu_BPRNACanProMet <- ggscatter(data.frame(a[-155, ]), x = "HE", y = "Neu_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "COAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.006)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.015, y = 0.006, label = paste("italic(r)==", round(cor.test(as.matrix(COAD_BPRNACanProMet_decon$Neu), as.matrix(HE_COAD_modif$Neutrophils))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.0105, y = 0.00525, label = paste("RMSE =", round(sqrt(mean((as.matrix(COAD_BPRNACanProMet_decon$Neu) - as.matrix(HE_COAD_modif$Neutrophils))^2, na.rm = T)), 5)), parse = F, size = 4) + annotate("text", x = 0.0065, y = 0.0046, label = paste("n = ", nrow(COAD_BPRNACan_decon)), size = 4)


a <- cbind(COAD_BPRNACan3DProMet_decon$Neu, HE_COAD_modif$Neutrophils)
colnames(a) <- c("Neu_fractions", "HE")

Fig_COAD_Neu_BPRNACan3DProMet <- ggscatter(data.frame(a), x = "HE", y = "Neu_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "COAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.008)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.015, y = 0.008, label = paste("italic(r)==", round(cor.test(as.matrix(COAD_BPRNACan3DProMet_decon$Neu), as.matrix(HE_COAD_modif$Neutrophils))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(COAD_BPRNACan3DProMet_decon$Neu), as.matrix(HE_COAD_modif$Neutrophils))$p.value, 15)), parse = TRUE, size = 4) + annotate("text", x = 0.0105, y = 0.007, label = paste("RMSE =", round(sqrt(mean((as.matrix(COAD_BPRNACan3DProMet_decon$Neu) - as.matrix(HE_COAD_modif$Neutrophils))^2, na.rm = T)), 3)), parse = F, size = 4) + annotate("text", x = 0.0065, y = 0.006, label = paste("n = ", nrow(COAD_BPRNACan_decon)), size = 4)

##### DNA methylation Part #####

#### lympho

lymph_methy <- COAD_methy_decon$B + COAD_methy_decon$CD4 + COAD_methy_decon$CD8 + COAD_methy_decon$Treg + COAD_methy_decon$NK

a <- cbind(lymph_methy, HE_COAD_modif$Lymphocytes)
colnames(a) <- c("lymph_methy", "HE_lympho")

Fig_COAD_lymph_BPmetCan <- ggscatter(data.frame(a), x = "HE_lympho", y = "lymph_methy", size = 2, add.params = list(color = "black"), color = "chocolate", title = "COAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_methy), as.matrix(HE_COAD_modif$Lymphocytes))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_methy) - as.matrix(HE_COAD_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(COAD_methy_decon)), size = 4)


#### Macro

Macro_Methy <- COAD_methy_decon$M0 + COAD_methy_decon$M1 + COAD_methy_decon$M2 + COAD_methy_decon$Mono

a <- cbind(Macro_Methy, HE_COAD_modif$Macrophages)
colnames(a) <- c("Macro_Methy", "HE_macro")

Fig_COAD_Macro_BPmetCan <- ggscatter(data.frame(a), x = "HE_macro", y = "Macro_Methy", size = 2, add.params = list(color = "black"), color = "chocolate", title = "COAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_Methy), as.matrix(HE_COAD_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_Methy) - as.matrix(HE_COAD_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(COAD_methy_decon)), size = 4)

#### Neu

a <- cbind(COAD_methy_decon$Neu, HE_COAD_modif$Neutrophils)
colnames(a) <- c("Neu_Methy", "HE_neu")

Fig_COAD_Neu_BPmetCan <- ggscatter(data.frame(a), x = "HE_neu", y = "Neu_Methy", size = 2, add.params = list(color = "black"), color = "chocolate", title = "COAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.8)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.0135, y = 0.8, label = paste("italic(r)==", round(cor.test(as.matrix(COAD_methy_decon$Neu), as.matrix(HE_COAD_modif$Neutrophils))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(COAD_methy_decon$Neu), as.matrix(HE_COAD_modif$Neutrophils))$p.value, 10)), parse = TRUE, size = 4) + annotate("text", x = 0.0085, y = 0.7, label = paste("RMSE =", round(sqrt(mean((as.matrix(COAD_methy_decon$Neu) - as.matrix(HE_COAD_modif$Neutrophils))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.0057, y = 0.6, label = paste("n = ", nrow(COAD_methy_decon)), size = 4)


##### Correlation between DNA methylation and expression deconvolution #####

## Tumor purity

a <- cbind(COAD_BPRNACan_decon$cancer, COAD_methy_decon$cancer)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_COAD_TM_BPRNACan_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", size = 2, add.params = list(color = "black"), color = "chocolate", title = "COAD") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL, limits = c(0, 1)) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", label.x = 0, label.y = 1, size = 6)

a <- cbind(COAD_BPRNACanProMet_decon$cancer, COAD_methy_decon$cancer)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_COAD_TM_BPRNACanProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", size = 2, add.params = list(color = "black"), color = "chocolate", title = "COAD") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL, limits = c(0, 1)) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", label.x = 0, label.y = 1, size = 6)

a <- cbind(COAD_BPRNACan3DProMet_decon$cancer, COAD_methy_decon$cancer)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_COAD_TM_BPRNACan3DProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", size = 2, add.params = list(color = "black"), color = "chocolate", title = "COAD") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL, limits = c(0, 1)) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", label.x = 0, label.y = 1, size = 6)


## Lymphcytes

a <- cbind(lymph_COAD_BPRNACan, lymph_methy)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_COAD_lymph_BPRNACan_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "COAD") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")

a <- cbind(lymph_COAD_BPRNACanProMet, lymph_methy)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_COAD_lymph_BPRNACanProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "COAD") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")

a <- cbind(lymph_COAD_BPRNACan3DProMet, lymph_methy)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_COAD_lymph_BPRNACan3DProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "COAD") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")


## Macrophages

a <- cbind(Macro_COAD_BPRNACan, Macro_Methy)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_COAD_macro_BPRNACan_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "COAD") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")


a <- cbind(Macro_COAD_BPRNACanProMet, Macro_Methy)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_COAD_macro_BPRNACanProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "COAD") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")

a <- cbind(Macro_COAD_BPRNACan3DProMet, Macro_Methy)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_COAD_macro_BPRNACan3DProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "COAD") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")


## Netrophils

a <- cbind(COAD_BPRNACan_decon$Neu, COAD_methy_decon$Neu)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_COAD_Neu_BPRNACan_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "COAD") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")


a <- cbind(COAD_BPRNACanProMet_decon$Neu, COAD_methy_decon$Neu)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_COAD_Neu_BPRNACanProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "COAD") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")

a <- cbind(COAD_BPRNACan3DProMet_decon$Neu, COAD_methy_decon$Neu)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_COAD_Neu_BPRNACan3DProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "COAD") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")



###############################################
###### average of Methylation and RNAseq ######
###############################################

#### Tumor purity

a <- cbind(rowMeans(cbind(COAD_BPRNACan_decon$cancer, COAD_methy_decon$cancer)), Facs_COAD_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_COAD_BPRNACan_avrage <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "COAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0, 1.2), breaks = seq(0.0, 1.2, 0.2)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.45, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(rowMeans(cbind(COAD_BPRNACan_decon$cancer, COAD_methy_decon$cancer))), as.matrix(Facs_COAD_modif$CPE))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.05, label = paste("RMSE =", round(sqrt(mean((as.matrix(rowMeans(cbind(COAD_BPRNACan_decon$cancer, COAD_methy_decon$cancer))) - as.matrix(Facs_COAD_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 0.9, label = paste("n = ", nrow(COAD_BPRNACan_decon)), size = 4)


a <- cbind(rowMeans(cbind(COAD_BPRNACanProMet_decon$cancer, COAD_methy_decon$cancer)), Facs_COAD_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_COAD_BPRNACanProMet_avrage <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "COAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0, 1.2), breaks = seq(0.0, 1.2, 0.2)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.45, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(rowMeans(cbind(COAD_BPRNACanProMet_decon$cancer, COAD_methy_decon$cancer))), as.matrix(Facs_COAD_modif$CPE))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.05, label = paste("RMSE =", round(sqrt(mean((as.matrix(rowMeans(cbind(COAD_BPRNACanProMet_decon$cancer, COAD_methy_decon$cancer))) - as.matrix(Facs_COAD_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 0.9, label = paste("n = ", nrow(COAD_BPRNACan_decon)), size = 4)


a <- cbind(rowMeans(cbind(COAD_BPRNACan3DProMet_decon$cancer, COAD_methy_decon$cancer)), Facs_COAD_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_COAD_BPRNACan3DProMet_avrage <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "COAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0, 1.2), breaks = seq(0.0, 1.2, 0.2)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.45, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(rowMeans(cbind(COAD_BPRNACan3DProMet_decon$cancer, COAD_methy_decon$cancer))), as.matrix(Facs_COAD_modif$CPE))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.05, label = paste("RMSE =", round(sqrt(mean((as.matrix(rowMeans(cbind(COAD_BPRNACan3DProMet_decon$cancer, COAD_methy_decon$cancer))) - as.matrix(Facs_COAD_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 0.9, label = paste("n = ", nrow(COAD_BPRNACan_decon)), size = 4)


#### Lymphocytes

lymph_COAD_BPRNACan_avr <- rowMeans(cbind(COAD_BPRNACan_decon$B + COAD_BPRNACan_decon$NK + COAD_BPRNACan_decon$CD4 + COAD_BPRNACan_decon$CD8, COAD_methy_decon$B + COAD_methy_decon$CD4 + COAD_methy_decon$CD8 + COAD_methy_decon$NK + COAD_methy_decon$Treg))

a <- cbind(lymph_COAD_BPRNACan_avr, HE_COAD_modif$Lymphocytes)
colnames(a) <- c("Cancer_cell_fractions", "Lymphocytes")

Fig_COAD_lymph_BPRNACan_avrage <- ggscatter(data.frame(a), x = "Lymphocytes", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "COAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_COAD_BPRNACan_avr), as.matrix(HE_COAD_modif$Lymphocytes))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_COAD_BPRNACan_avr) - as.matrix(HE_COAD_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(COAD_methy_decon)), size = 4)


lymph_COAD_BPRNACanProMet_avr <- rowMeans(cbind(COAD_BPRNACanProMet_decon$B + COAD_BPRNACanProMet_decon$NK + COAD_BPRNACanProMet_decon$CD4 + COAD_BPRNACanProMet_decon$CD8, COAD_methy_decon$B + COAD_methy_decon$CD4 + COAD_methy_decon$CD8 + COAD_methy_decon$NK + COAD_methy_decon$Treg))

a <- cbind(lymph_COAD_BPRNACanProMet_avr, HE_COAD_modif$Lymphocytes)
colnames(a) <- c("Cancer_cell_fractions", "Lymphocytes")

Fig_COAD_lymph_BPRNACanProMet_avrage <- ggscatter(data.frame(a), x = "Lymphocytes", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "COAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_COAD_BPRNACanProMet_avr), as.matrix(HE_COAD_modif$Lymphocytes))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_COAD_BPRNACanProMet_avr) - as.matrix(HE_COAD_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(COAD_methy_decon)), size = 4)

lymph_COAD_BPRNACan3DProMet_avr <- rowMeans(cbind(COAD_BPRNACan3DProMet_decon$B + COAD_BPRNACan3DProMet_decon$NK + COAD_BPRNACan3DProMet_decon$CD4 + COAD_BPRNACan3DProMet_decon$CD8, COAD_methy_decon$B + COAD_methy_decon$CD4 + COAD_methy_decon$CD8 + COAD_methy_decon$NK + COAD_methy_decon$Treg))

a <- cbind(lymph_COAD_BPRNACan3DProMet_avr, HE_COAD_modif$Lymphocytes)
colnames(a) <- c("Cancer_cell_fractions", "Lymphocytes")

Fig_COAD_lymph_BPRNACan3DProMet_avrage <- ggscatter(data.frame(a), x = "Lymphocytes", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "COAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_COAD_BPRNACan3DProMet_avr), as.matrix(HE_COAD_modif$Lymphocytes))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_COAD_BPRNACan3DProMet_avr) - as.matrix(HE_COAD_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(COAD_methy_decon)), size = 4)

#### Macrophages

Macro_COAD_BPRNACan_avr <- rowMeans(cbind(COAD_BPRNACan_decon$M0 + COAD_BPRNACan_decon$M1 + COAD_BPRNACan_decon$M2 + COAD_BPRNACan_decon$Mono, COAD_methy_decon$M0 + COAD_methy_decon$M1 + COAD_methy_decon$M2 + COAD_methy_decon$Mono))

a <- cbind(Macro_COAD_BPRNACan_avr, HE_COAD_modif$Macrophages)
colnames(a) <- c("Cancer_cell_fractions", "Macrophages")

Fig_COAD_Macro_BPRNACan_avrage <- ggscatter(data.frame(a), x = "Macrophages", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "COAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_COAD_BPRNACan_avr), as.matrix(HE_COAD_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_COAD_BPRNACan_avr) - as.matrix(HE_COAD_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(COAD_methy_decon)), size = 4)

Macro_COAD_BPRNACanProMet_avr <- rowMeans(cbind(COAD_BPRNACanProMet_decon$M0 + COAD_BPRNACanProMet_decon$M1 + COAD_BPRNACanProMet_decon$M2 + COAD_BPRNACanProMet_decon$Mono, COAD_methy_decon$M0 + COAD_methy_decon$M1 + COAD_methy_decon$M2 + COAD_methy_decon$Mono))

a <- cbind(Macro_COAD_BPRNACanProMet_avr, HE_COAD_modif$Macrophages)
colnames(a) <- c("Cancer_cell_fractions", "Macrophages")

Fig_COAD_Macro_BPRNACanProMet_avrage <- ggscatter(data.frame(a), x = "Macrophages", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "COAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_COAD_BPRNACanProMet_avr), as.matrix(HE_COAD_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_COAD_BPRNACanProMet_avr) - as.matrix(HE_COAD_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(COAD_methy_decon)), size = 4)


Macro_COAD_BPRNACan3DProMet_avr <- rowMeans(cbind(COAD_BPRNACan3DProMet_decon$M0 + COAD_BPRNACan3DProMet_decon$M1 + COAD_BPRNACan3DProMet_decon$M2 + COAD_BPRNACan3DProMet_decon$Mono, COAD_methy_decon$M0 + COAD_methy_decon$M1 + COAD_methy_decon$M2 + COAD_methy_decon$Mono))

a <- cbind(Macro_COAD_BPRNACan3DProMet_avr, HE_COAD_modif$Macrophages)
colnames(a) <- c("Cancer_cell_fractions", "Macrophages")

Fig_COAD_Macro_BPRNACan3DProMet_avrage <- ggscatter(data.frame(a), x = "Macrophages", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "COAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_COAD_BPRNACan3DProMet_avr), as.matrix(HE_COAD_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_COAD_BPRNACan3DProMet_avr) - as.matrix(HE_COAD_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(COAD_methy_decon)), size = 4)


#### Neutrophils

a <- cbind(rowMeans(cbind(COAD_BPRNACan_decon$Neu, COAD_methy_decon$Neu)), HE_COAD_modif$Neutrophils)
colnames(a) <- c("Cancer_cell_fractions", "Neutrophils")

Fig_COAD_Neu_BPRNACan_avrage <- ggscatter(data.frame(a), x = "Neutrophils", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "COAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.4)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.012, y = 0.4, label = paste("italic(r)==", round(cor.test(as.matrix(rowMeans(cbind(COAD_BPRNACan_decon$Neu, COAD_methy_decon$Neu))), as.matrix(HE_COAD_modif$Neutrophils))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(rowMeans(cbind(COAD_BPRNACan_decon$Neu, COAD_methy_decon$Neu))), as.matrix(HE_COAD_modif$Neutrophils))$p.value, 9)), parse = TRUE, size = 4) + annotate("text", x = 0.008, y = 0.35, label = paste("RMSE =", round(sqrt(mean((as.matrix(rowMeans(cbind(COAD_BPRNACan_decon$Neu, COAD_methy_decon$Neu))) - as.matrix(HE_COAD_modif$Neutrophils))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.0051, y = 0.3, label = paste("n = ", nrow(COAD_methy_decon)), size = 4)

a <- cbind(rowMeans(cbind(COAD_BPRNACanProMet_decon$Neu, COAD_methy_decon$Neu)), HE_COAD_modif$Neutrophils)
colnames(a) <- c("Cancer_cell_fractions", "Neutrophils")

Fig_COAD_Neu_BPRNACanProMet_avrage <- ggscatter(data.frame(a), x = "Neutrophils", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "COAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.4)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.012, y = 0.4, label = paste("italic(r)==", round(cor.test(as.matrix(rowMeans(cbind(COAD_BPRNACanProMet_decon$Neu, COAD_methy_decon$Neu))), as.matrix(HE_COAD_modif$Neutrophils))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(rowMeans(cbind(COAD_BPRNACanProMet_decon$Neu, COAD_methy_decon$Neu))), as.matrix(HE_COAD_modif$Neutrophils))$p.value, 9)), parse = TRUE, size = 4) + annotate("text", x = 0.008, y = 0.35, label = paste("RMSE =", round(sqrt(mean((as.matrix(rowMeans(cbind(COAD_BPRNACanProMet_decon$Neu, COAD_methy_decon$Neu))) - as.matrix(HE_COAD_modif$Neutrophils))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.0051, y = 0.3, label = paste("n = ", nrow(COAD_methy_decon)), size = 4)

a <- cbind(rowMeans(cbind(COAD_BPRNACan3DProMet_decon$Neu, COAD_methy_decon$Neu)), HE_COAD_modif$Neutrophils)
colnames(a) <- c("Cancer_cell_fractions", "Neutrophils")

Fig_COAD_Neu_BPRNACan3DProMet_avrage <- ggscatter(data.frame(a), x = "Neutrophils", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "COAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.4)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.012, y = 0.4, label = paste("italic(r)==", round(cor.test(as.matrix(rowMeans(cbind(COAD_BPRNACan3DProMet_decon$Neu, COAD_methy_decon$Neu))), as.matrix(HE_COAD_modif$Neutrophils))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(rowMeans(cbind(COAD_BPRNACan3DProMet_decon$Neu, COAD_methy_decon$Neu))), as.matrix(HE_COAD_modif$Neutrophils))$p.value, 9)), parse = TRUE, size = 4) + annotate("text", x = 0.008, y = 0.35, label = paste("RMSE =", round(sqrt(mean((as.matrix(rowMeans(cbind(COAD_BPRNACan3DProMet_decon$Neu, COAD_methy_decon$Neu))) - as.matrix(HE_COAD_modif$Neutrophils))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.0051, y = 0.3, label = paste("n = ", nrow(COAD_methy_decon)), size = 4)
```

```{r}
#### BPRNACan3D

Lym_COAD_3DRNA <- cbind(lymph_COAD_BPRNACan3DProMet, HE_COAD_modif$Lymphocytes)
colnames(Lym_COAD_3DRNA) <- c("Cancer_cell_fractions", "Lymphocytes")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((lymph_COAD_BPRNACan3DProMet - HE_COAD_modif$Lymphocytes)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Lym_COAD_3DRNA <- ggplot(as.data.frame(Lym_COAD_3DRNA), aes(x = Lymphocytes, y = Cancer_cell_fractions)) +
  geom_point(colour = c("darkslategrey")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"BPRNACan3D") +
  scale_x_continuous(name = NULL, limits = c(0, max(Lym_COAD_3DRNA))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Lym_COAD_3DRNA))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)

Macro_COAD_3DRNA <- cbind(Macro_COAD_BPRNACan3DProMet, HE_COAD_modif$Macrophages)
colnames(Macro_COAD_3DRNA) <- c("Cancer_cell_fractions", "Macrophages")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((Macro_COAD_BPRNACan3DProMet - HE_COAD_modif$Macrophages)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Macro_COAD_3DRNA <- ggplot(as.data.frame(Macro_COAD_3DRNA), aes(x = Macrophages, y = Cancer_cell_fractions)) +
  geom_point(colour = c("coral")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"BPRNACan3D") +
  scale_x_continuous(name = NULL, limits = c(0, max(Macro_COAD_3DRNA))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Macro_COAD_3DRNA))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)


Neu_COAD_3DRNA <- cbind(COAD_BPRNACan3DProMet_decon$Neu, HE_COAD_modif$Neutrophils)
colnames(Neu_COAD_3DRNA) <- c("Cancer_cell_fractions", "Neutrophils")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((COAD_BPRNACan3DProMet_decon$Neu - HE_COAD_modif$Neutrophils)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Neu_COAD_3DRNA <- ggplot(as.data.frame(Neu_COAD_3DRNA), aes(x = Neutrophils, y = Cancer_cell_fractions)) +
  geom_point(colour = c("green")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"BPRNACan3D") +
  scale_x_continuous(name = NULL, limits = c(0, max(Neu_COAD_3DRNA))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Neu_COAD_3DRNA))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)


#### BPmetCan

#### lympho

Lym_COAD_methy <- cbind(lymph_methy, HE_COAD_modif$Lymphocytes)
colnames(Lym_COAD_methy) <- c("Cancer_cell_fractions", "Lymphocytes")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((Lym_COAD_methy - HE_COAD_modif$Lymphocytes)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Lym_COAD_BPmetCan <- ggplot(as.data.frame(Lym_COAD_methy), aes(x = Lymphocytes, y = Cancer_cell_fractions)) +
  geom_point(colour = c("darkslategrey")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"BPmetCan") +
  scale_x_continuous(name = NULL, limits = c(0, max(Lym_COAD_methy))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Lym_COAD_methy))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)

#### Macro

Macro_Methy <- COAD_methy_decon$M0 + COAD_methy_decon$M1 + COAD_methy_decon$M2 + COAD_methy_decon$Mono

Macro_COAD_methy <- cbind(Macro_Methy, HE_COAD_modif$Macrophages)
colnames(Macro_COAD_methy) <- c("Cancer_cell_fractions", "Macrophages")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((Macro_COAD_methy - HE_COAD_modif$Macrophages)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Macro_COAD_BPmetCan <- ggplot(as.data.frame(Macro_COAD_methy), aes(x = Macrophages, y = Cancer_cell_fractions)) +
  geom_point(colour = c("coral")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"BPmetCan") +
  scale_x_continuous(name = NULL, limits = c(0, max(Macro_Methy))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Macro_Methy))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)


#### Neu

Neu_COAD_methy <- cbind(COAD_methy_decon$Neu, HE_COAD_modif$Neutrophils)
colnames(Neu_COAD_methy) <- c("Cancer_cell_fractions", "Neutrophils")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((COAD_methy_decon$Neu - HE_COAD_modif$Neutrophils)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Neu_COAD_BPmetCan <- ggplot(as.data.frame(Neu_COAD_methy), aes(x = Neutrophils, y = Cancer_cell_fractions)) +
  geom_point(colour = c("green")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"BPmetCan") + 
  scale_x_continuous(name = NULL, limits = c(0, max(Neu_COAD_methy))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Neu_COAD_methy))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)



#### avrg

Lym_COAD_avrg <- cbind(lymph_COAD_BPRNACan_avr, HE_COAD_modif$Lymphocytes)
colnames(Lym_COAD_avrg) <- c("Cancer_cell_fractions", "Lymphocytes")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((lymph_COAD_BPRNACan_avr - HE_COAD_modif$Lymphocytes)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Lym_COAD_avrg <- ggplot(as.data.frame(Lym_COAD_avrg), aes(x = Lymphocytes, y = Cancer_cell_fractions)) +
  geom_point(colour = c("darkslategrey")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"Meth + RNA") + 
  scale_x_continuous(name = NULL, limits = c(0, max(Lym_COAD_avrg))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Lym_COAD_avrg))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)


Macro_COAD_avrg <- cbind(Macro_COAD_BPRNACan_avr, HE_COAD_modif$Macrophages)
colnames(Macro_COAD_avrg) <- c("Cancer_cell_fractions", "Macrophages")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((Macro_COAD_BPRNACan_avr - HE_COAD_modif$Macrophages)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Macro_COAD_avrg <- ggplot(as.data.frame(Macro_COAD_avrg), aes(x = Macrophages, y = Cancer_cell_fractions)) +
  geom_point(colour = c("coral")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"Meth + RNA") +
  scale_x_continuous(name = NULL, limits = c(0, max(Macro_COAD_avrg))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Macro_COAD_avrg))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)

Neu_COAD_avrg <- cbind(rowMeans(cbind(COAD_BPRNACan_decon$Neu, COAD_methy_decon$Neu)), HE_COAD_modif$Neutrophils)
colnames(Neu_COAD_avrg) <- c("Cancer_cell_fractions", "Neutrophils")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean(rowMeans(cbind(COAD_BPRNACan_decon$Neu, COAD_methy_decon$Neu) - HE_COAD_modif$Neutrophils)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Neu_COAD_avrg <- ggplot(as.data.frame(Neu_COAD_avrg), aes(x = Neutrophils, y = Cancer_cell_fractions)) +
  geom_point(colour = c("green")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"Meth + RNA") + 
  scale_x_continuous(name = NULL, limits = c(0, max(Neu_COAD_avrg))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Neu_COAD_avrg))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)



lymph = ggarrange(fig_Lym_COAD_3DRNA, fig_Lym_COAD_BPmetCan, fig_Lym_COAD_avrg, ncol = 3, nrow = 1, labels = "a", font.label = list(size = 20, color = "black"), align = "hv")
neutro = ggarrange(fig_Neu_COAD_3DRNA, fig_Neu_COAD_BPmetCan, fig_Neu_COAD_avrg, ncol = 3, nrow = 1, labels = "b", font.label = list(size = 20, color = "black"), align = "hv")
macro = ggarrange(fig_Macro_COAD_3DRNA, fig_Macro_COAD_BPmetCan, fig_Macro_COAD_avrg, ncol = 3, nrow = 1, labels = "c", font.label = list(size = 20, color = "black"), align = "hv")


All_COAD <- ggarrange(lymph, neutro, macro, ncol = 1, nrow = 3, font.label = list(size = 20, color = "black"), align = "hv")


All_COAD <- annotate_figure(All_COAD,
  left = text_grob("Estimated fractions", color = "black", size = 20, rot = 90),
  bottom = text_grob("H&E estimates", color = "black", size = 20)
  
)

All_COAD
```
RNA, methylation, and averaged values of correlation across a : lymphocytes, b: neutrophils, c : macrophages, using the BPRNACan3D and BPMetCan signatures on EpiDish.

## LUAD

```{r}

LUAD_methy_decon <- read.table("/mnt/SERVER-CRCT-STORAGE/CRCT21/Private/Julien/gemdecan/data/meth/LUAD.txt", sep = "\t", header = T)

Facs_LUAD <- Aran_all_facs[Aran_all_facs$Cancer_type == "LUAD", ]

HE_LUAD <- HE_all_TCGA[HE_all_TCGA$Study == "LUAD", ]

Facs_LUAD_modif <- Facs_LUAD[Facs_LUAD$CPE != "NaN", ]

Comm_samples <- Reduce(intersect, list(HE_LUAD$ParticipantBarcode, Facs_LUAD_modif$Sample_ID, tcga_deconv$Samples, rownames(LUAD_methy_decon)))

Facs_LUAD_modif <- Facs_LUAD_modif %>% .[.$Sample_ID %in% Comm_samples, ]

HE_LUAD_modif <- HE_LUAD %>%
  .[.$ParticipantBarcode %in% Comm_samples, ] %>%
  .[order(.$ParticipantBarcode), ]

LUAD_methy_decon <- LUAD_methy_decon[Comm_samples, ] %>% 
  rownames_to_column() 
LUAD_methy_decon <- LUAD_methy_decon[order(LUAD_methy_decon$rowname), ]
rownames(LUAD_methy_decon) <- LUAD_methy_decon$rowname
LUAD_methy_decon <- LUAD_methy_decon[,-1]

LUAD_RNA_decon <- tcga_deconv %>% filter(Samples %in% Comm_samples)

###################################
##### Estimating Tumor Purity #####
###################################


LUAD_BPRNACan_decon <- LUAD_RNA_decon %>% select(colnames(LUAD_RNA_decon)[grepl("Epidish_BPRNACan_", colnames(LUAD_RNA_decon))])
colnames(LUAD_BPRNACan_decon) <- colnames(LUAD_BPRNACan_decon) %>% str_remove_all("Epidish_BPRNACan_")

a <- cbind(LUAD_BPRNACan_decon$cancer, Facs_LUAD_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_LUAD_BPRNACan <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0.8, 1.2), breaks = seq(0.0, 1.2, 0.1)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.42, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(LUAD_BPRNACan_decon$cancer), as.matrix(Facs_LUAD_modif$CPE))$est, 2), "~','", "~italic(P)<", round(cor.test(as.matrix(LUAD_BPRNACan_decon$cancer), as.matrix(Facs_LUAD_modif$CPE))$p.value, 14)), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.15, label = paste("RMSE =", round(sqrt(mean((as.matrix(LUAD_BPRNACan_decon$cancer) - as.matrix(Facs_LUAD_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 1.1, label = paste("n = ", nrow(LUAD_BPRNACan_decon)), size = 4)


LUAD_BPRNACanProMet_decon <- LUAD_RNA_decon %>% select(colnames(LUAD_RNA_decon)[grepl("Epidish_BPRNACanProMet_", colnames(LUAD_RNA_decon))])
colnames(LUAD_BPRNACanProMet_decon) <- colnames(LUAD_BPRNACanProMet_decon) %>% str_remove_all("Epidish_BPRNACanProMet_")

a <- cbind(LUAD_BPRNACanProMet_decon$cancer, Facs_LUAD_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_LUAD_BPRNACanProMet <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0.8, 1.2), breaks = seq(0.0, 1.2, 0.1)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.45, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(LUAD_BPRNACanProMet_decon$cancer), as.matrix(Facs_LUAD_modif$CPE))$est, 2), "~','", "~italic(P)<", round(cor.test(as.matrix(LUAD_BPRNACanProMet_decon$cancer), as.matrix(Facs_LUAD_modif$CPE))$p.value, 14)), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.15, label = paste("RMSE =", round(sqrt(mean((as.matrix(LUAD_BPRNACanProMet_decon$cancer) - as.matrix(Facs_LUAD_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 1.1, label = paste("n = ", nrow(LUAD_BPRNACanProMet_decon)), size = 4)


LUAD_BPRNACan3DProMet_decon <- LUAD_RNA_decon %>% select(colnames(LUAD_RNA_decon)[grepl("Epidish_BPRNACan3DProMet_", colnames(LUAD_RNA_decon))])
colnames(LUAD_BPRNACan3DProMet_decon) <- colnames(LUAD_BPRNACan3DProMet_decon) %>% str_remove_all("Epidish_BPRNACan3DProMet_")


a <- cbind(LUAD_BPRNACan3DProMet_decon$cancer, Facs_LUAD_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_LUAD_BPRNACan3DProMet <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0.8, 1.2), breaks = seq(0.0, 1.2, 0.1)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.52, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(LUAD_BPRNACan3DProMet_decon$cancer), as.matrix(Facs_LUAD_modif$CPE))$est, 2), "~','", "~italic(P)<", round(cor.test(as.matrix(LUAD_BPRNACan3DProMet_decon$cancer), as.matrix(Facs_LUAD_modif$CPE))$p.value, 14)), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.15, label = paste("RMSE =", round(sqrt(mean((as.matrix(LUAD_BPRNACan3DProMet_decon$cancer) - as.matrix(Facs_LUAD_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 1.1, label = paste("n = ", nrow(LUAD_BPRNACan3DProMet_decon)), size = 4)

###### Methylation part

a <- cbind(LUAD_methy_decon$cancer, Facs_LUAD_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_LUAD_BPmetCan <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0, 1.2), breaks = seq(0.0, 1.2, 0.2)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.45, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(LUAD_methy_decon$cancer), as.matrix(Facs_LUAD_modif$CPE))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.05, label = paste("RMSE =", round(sqrt(mean((as.matrix(LUAD_methy_decon$cancer) - as.matrix(Facs_LUAD_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 0.9, label = paste("n = ", nrow(LUAD_methy_decon)), size = 4)


###############################################################
##### Estimating Lymphocytes, Macrophages and Neutrophils #####
###############################################################

##### RNA expression Part #####

#### lymph

lymph_LUAD_BPRNACan <- LUAD_BPRNACan_decon$B + LUAD_BPRNACan_decon$CD4 + LUAD_BPRNACan_decon$CD8 + LUAD_BPRNACan_decon$NK

a <- cbind(lymph_LUAD_BPRNACan, HE_LUAD_modif$Lymphocytes)
colnames(a) <- c("lymph_fractions", "HE")

Fig_LUAD_lymph_BPRNACan <- ggscatter(data.frame(a), x = "HE", y = "lymph_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.08)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.235, y = 0.08, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_LUAD_BPRNACan), as.matrix(HE_LUAD_modif$Lymphocytes))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.07, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_LUAD_BPRNACan) - as.matrix(HE_LUAD_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.06, label = paste("n = ", nrow(LUAD_methy_decon)), size = 4)



lymph_LUAD_BPRNACanProMet <- LUAD_BPRNACanProMet_decon$B + LUAD_BPRNACanProMet_decon$CD4 + LUAD_BPRNACanProMet_decon$CD8 + LUAD_BPRNACanProMet_decon$NK

a <- cbind(lymph_LUAD_BPRNACanProMet, HE_LUAD_modif$Lymphocytes)
colnames(a) <- c("lymph_fractions", "HE")

Fig_LUAD_lymph_BPRNACanProMet <- ggscatter(data.frame(a), x = "HE", y = "lymph_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.08)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.235, y = 0.08, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_LUAD_BPRNACanProMet), as.matrix(HE_LUAD_modif$Lymphocytes))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(lymph_LUAD_BPRNACanProMet), as.matrix(HE_LUAD_modif$Lymphocytes))$p.value, 13)), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.07, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_LUAD_BPRNACanProMet) - as.matrix(HE_LUAD_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.06, label = paste("n = ", nrow(LUAD_BPRNACanProMet_decon)), size = 4)


lymph_LUAD_BPRNACan3DProMet <- LUAD_BPRNACan3DProMet_decon$B + LUAD_BPRNACan3DProMet_decon$CD4 + LUAD_BPRNACan3DProMet_decon$CD8 + LUAD_BPRNACan3DProMet_decon$NK

a <- cbind(lymph_LUAD_BPRNACan3DProMet, HE_LUAD_modif$Lymphocytes)
colnames(a) <- c("lymph_fractions", "HE")

Fig_LUAD_lymph_BPRNACan3DProMet <- ggscatter(data.frame(a), x = "HE", y = "lymph_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.08)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.235, y = 0.08, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_LUAD_BPRNACan3DProMet), as.matrix(HE_LUAD_modif$Lymphocytes))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(lymph_LUAD_BPRNACan3DProMet), as.matrix(HE_LUAD_modif$Lymphocytes))$p.value, 13)), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.07, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_LUAD_BPRNACan3DProMet) - as.matrix(HE_LUAD_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.06, label = paste("n = ", nrow(LUAD_BPRNACanProMet_decon)), size = 4)


#### Macro

Macro_LUAD_BPRNACan <- LUAD_BPRNACan_decon$M0 + LUAD_BPRNACan_decon$M1 + LUAD_BPRNACan_decon$M2 + LUAD_BPRNACan_decon$Mono

a <- cbind(Macro_LUAD_BPRNACan, HE_LUAD_modif$Macrophages)
colnames(a) <- c("Macro_fractions", "HE")

Fig_LUAD_Macro_BPRNACan <- ggscatter(data.frame(a), x = "HE", y = "Macro_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.4)) + scale_y_continuous(name = NULL, limits = c(0, 0.06)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.175, y = 0.06, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_LUAD_BPRNACan), as.matrix(HE_LUAD_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.11, y = 0.0526, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_LUAD_BPRNACan) - as.matrix(HE_LUAD_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.08, y = 0.045, label = paste("n = ", nrow(LUAD_BPRNACan_decon)), size = 4)



Macro_LUAD_BPRNACanProMet <- LUAD_BPRNACanProMet_decon$M0 + LUAD_BPRNACanProMet_decon$M1 + LUAD_BPRNACanProMet_decon$M2 + LUAD_BPRNACanProMet_decon$Mono

a <- cbind(Macro_LUAD_BPRNACanProMet, HE_LUAD_modif$Macrophages)
colnames(a) <- c("Macro_fractions", "HE")

Fig_LUAD_Macro_BPRNACanProMet <- ggscatter(data.frame(a), x = "HE", y = "Macro_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.4)) + scale_y_continuous(name = NULL, limits = c(0, 0.06)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.185, y = 0.06, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_LUAD_BPRNACanProMet), as.matrix(HE_LUAD_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.11, y = 0.0526, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_LUAD_BPRNACanProMet) - as.matrix(HE_LUAD_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.08, y = 0.045, label = paste("n = ", nrow(LUAD_BPRNACan_decon)), size = 4)

Macro_LUAD_BPRNACan3DProMet <- LUAD_BPRNACan3DProMet_decon$M0 + LUAD_BPRNACan3DProMet_decon$M1 + LUAD_BPRNACan3DProMet_decon$M2 + LUAD_BPRNACan3DProMet_decon$Mono

a <- cbind(Macro_LUAD_BPRNACan3DProMet, HE_LUAD_modif$Macrophages)
colnames(a) <- c("Macro_fractions", "HE")

Fig_LUAD_Macro_BPRNACan3DProMet <- ggscatter(data.frame(a), x = "HE", y = "Macro_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.4)) + scale_y_continuous(name = NULL, limits = c(0, 0.06)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.185, y = 0.06, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_LUAD_BPRNACan3DProMet), as.matrix(HE_LUAD_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.11, y = 0.0526, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_LUAD_BPRNACan3DProMet) - as.matrix(HE_LUAD_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.08, y = 0.045, label = paste("n = ", nrow(LUAD_BPRNACan_decon)), size = 4)

#### Neutrophis

a <- cbind(LUAD_BPRNACan_decon$Neu, HE_LUAD_modif$Neutrophils)
colnames(a) <- c("Neu_fractions", "HE")

Fig_LUAD_Neu_BPRNACan <- ggscatter(data.frame(a), x = "HE", y = "Neu_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.006)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.015, y = 0.006, label = paste("italic(r)==", round(cor.test(as.matrix(LUAD_BPRNACan_decon$Neu), as.matrix(HE_LUAD_modif$Neutrophils))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.009, y = 0.00525, label = paste("RMSE =", round(sqrt(mean((as.matrix(LUAD_BPRNACan_decon$Neu) - as.matrix(HE_LUAD_modif$Neutrophils))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.0065, y = 0.0046, label = paste("n = ", nrow(LUAD_BPRNACan_decon)), size = 4)


a <- cbind(LUAD_BPRNACanProMet_decon$Neu, HE_LUAD_modif$Neutrophils)
colnames(a) <- c("Neu_fractions", "HE")

Fig_LUAD_Neu_BPRNACanProMet <- ggscatter(data.frame(a[-155, ]), x = "HE", y = "Neu_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.006)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.015, y = 0.006, label = paste("italic(r)==", round(cor.test(as.matrix(LUAD_BPRNACanProMet_decon$Neu), as.matrix(HE_LUAD_modif$Neutrophils))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.0105, y = 0.00525, label = paste("RMSE =", round(sqrt(mean((as.matrix(LUAD_BPRNACanProMet_decon$Neu) - as.matrix(HE_LUAD_modif$Neutrophils))^2, na.rm = T)), 5)), parse = F, size = 4) + annotate("text", x = 0.0065, y = 0.0046, label = paste("n = ", nrow(LUAD_BPRNACan_decon)), size = 4)


a <- cbind(LUAD_BPRNACan3DProMet_decon$Neu, HE_LUAD_modif$Neutrophils)
colnames(a) <- c("Neu_fractions", "HE")

Fig_LUAD_Neu_BPRNACan3DProMet <- ggscatter(data.frame(a), x = "HE", y = "Neu_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.008)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.015, y = 0.008, label = paste("italic(r)==", round(cor.test(as.matrix(LUAD_BPRNACan3DProMet_decon$Neu), as.matrix(HE_LUAD_modif$Neutrophils))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(LUAD_BPRNACan3DProMet_decon$Neu), as.matrix(HE_LUAD_modif$Neutrophils))$p.value, 15)), parse = TRUE, size = 4) + annotate("text", x = 0.0105, y = 0.007, label = paste("RMSE =", round(sqrt(mean((as.matrix(LUAD_BPRNACan3DProMet_decon$Neu) - as.matrix(HE_LUAD_modif$Neutrophils))^2, na.rm = T)), 3)), parse = F, size = 4) + annotate("text", x = 0.0065, y = 0.006, label = paste("n = ", nrow(LUAD_BPRNACan_decon)), size = 4)

##### DNA methylation Part #####

#### lympho

lymph_methy <- LUAD_methy_decon$B + LUAD_methy_decon$CD4 + LUAD_methy_decon$CD8 + LUAD_methy_decon$Treg + LUAD_methy_decon$NK

a <- cbind(lymph_methy, HE_LUAD_modif$Lymphocytes)
colnames(a) <- c("lymph_methy", "HE_lympho")

Fig_LUAD_lymph_BPmetCan <- ggscatter(data.frame(a), x = "HE_lympho", y = "lymph_methy", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_methy), as.matrix(HE_LUAD_modif$Lymphocytes))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_methy) - as.matrix(HE_LUAD_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(LUAD_methy_decon)), size = 4)


#### Macro

Macro_Methy <- LUAD_methy_decon$M0 + LUAD_methy_decon$M1 + LUAD_methy_decon$M2 + LUAD_methy_decon$Mono

a <- cbind(Macro_Methy, HE_LUAD_modif$Macrophages)
colnames(a) <- c("Macro_Methy", "HE_macro")

Fig_LUAD_Macro_BPmetCan <- ggscatter(data.frame(a), x = "HE_macro", y = "Macro_Methy", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_Methy), as.matrix(HE_LUAD_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_Methy) - as.matrix(HE_LUAD_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(LUAD_methy_decon)), size = 4)

#### Neu

a <- cbind(LUAD_methy_decon$Neu, HE_LUAD_modif$Neutrophils)
colnames(a) <- c("Neu_Methy", "HE_neu")

Fig_LUAD_Neu_BPmetCan <- ggscatter(data.frame(a), x = "HE_neu", y = "Neu_Methy", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.8)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.0135, y = 0.8, label = paste("italic(r)==", round(cor.test(as.matrix(LUAD_methy_decon$Neu), as.matrix(HE_LUAD_modif$Neutrophils))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(LUAD_methy_decon$Neu), as.matrix(HE_LUAD_modif$Neutrophils))$p.value, 10)), parse = TRUE, size = 4) + annotate("text", x = 0.0085, y = 0.7, label = paste("RMSE =", round(sqrt(mean((as.matrix(LUAD_methy_decon$Neu) - as.matrix(HE_LUAD_modif$Neutrophils))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.0057, y = 0.6, label = paste("n = ", nrow(LUAD_methy_decon)), size = 4)


##### Correlation between DNA methylation and expression deconvolution #####

## Tumor purity

a <- cbind(LUAD_BPRNACan_decon$cancer, LUAD_methy_decon$cancer)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_LUAD_TM_BPRNACan_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUAD") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL, limits = c(0, 1)) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", label.x = 0, label.y = 1, size = 6)

a <- cbind(LUAD_BPRNACanProMet_decon$cancer, LUAD_methy_decon$cancer)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_LUAD_TM_BPRNACanProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUAD") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL, limits = c(0, 1)) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", label.x = 0, label.y = 1, size = 6)

a <- cbind(LUAD_BPRNACan3DProMet_decon$cancer, LUAD_methy_decon$cancer)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_LUAD_TM_BPRNACan3DProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUAD") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL, limits = c(0, 1)) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", label.x = 0, label.y = 1, size = 6)


## Lymphcytes

a <- cbind(lymph_LUAD_BPRNACan, lymph_methy)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_LUAD_lymph_BPRNACan_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUAD") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")

a <- cbind(lymph_LUAD_BPRNACanProMet, lymph_methy)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_LUAD_lymph_BPRNACanProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUAD") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")

a <- cbind(lymph_LUAD_BPRNACan3DProMet, lymph_methy)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_LUAD_lymph_BPRNACan3DProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUAD") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")


## Macrophages

a <- cbind(Macro_LUAD_BPRNACan, Macro_Methy)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_LUAD_macro_BPRNACan_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUAD") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")


a <- cbind(Macro_LUAD_BPRNACanProMet, Macro_Methy)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_LUAD_macro_BPRNACanProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUAD") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")

a <- cbind(Macro_LUAD_BPRNACan3DProMet, Macro_Methy)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_LUAD_macro_BPRNACan3DProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUAD") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")


## Netrophils

a <- cbind(LUAD_BPRNACan_decon$Neu, LUAD_methy_decon$Neu)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_LUAD_Neu_BPRNACan_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUAD") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")


a <- cbind(LUAD_BPRNACanProMet_decon$Neu, LUAD_methy_decon$Neu)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_LUAD_Neu_BPRNACanProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUAD") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")

a <- cbind(LUAD_BPRNACan3DProMet_decon$Neu, LUAD_methy_decon$Neu)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_LUAD_Neu_BPRNACan3DProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUAD") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")



###############################################
###### average of Methylation and RNAseq ######
###############################################

#### Tumor purity

a <- cbind(rowMeans(cbind(LUAD_BPRNACan_decon$cancer, LUAD_methy_decon$cancer)), Facs_LUAD_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_LUAD_BPRNACan_avrage <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0, 1.2), breaks = seq(0.0, 1.2, 0.2)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.45, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(rowMeans(cbind(LUAD_BPRNACan_decon$cancer, LUAD_methy_decon$cancer))), as.matrix(Facs_LUAD_modif$CPE))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.05, label = paste("RMSE =", round(sqrt(mean((as.matrix(rowMeans(cbind(LUAD_BPRNACan_decon$cancer, LUAD_methy_decon$cancer))) - as.matrix(Facs_LUAD_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 0.9, label = paste("n = ", nrow(LUAD_BPRNACan_decon)), size = 4)


a <- cbind(rowMeans(cbind(LUAD_BPRNACanProMet_decon$cancer, LUAD_methy_decon$cancer)), Facs_LUAD_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_LUAD_BPRNACanProMet_avrage <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0, 1.2), breaks = seq(0.0, 1.2, 0.2)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.45, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(rowMeans(cbind(LUAD_BPRNACanProMet_decon$cancer, LUAD_methy_decon$cancer))), as.matrix(Facs_LUAD_modif$CPE))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.05, label = paste("RMSE =", round(sqrt(mean((as.matrix(rowMeans(cbind(LUAD_BPRNACanProMet_decon$cancer, LUAD_methy_decon$cancer))) - as.matrix(Facs_LUAD_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 0.9, label = paste("n = ", nrow(LUAD_BPRNACan_decon)), size = 4)


a <- cbind(rowMeans(cbind(LUAD_BPRNACan3DProMet_decon$cancer, LUAD_methy_decon$cancer)), Facs_LUAD_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_LUAD_BPRNACan3DProMet_avrage <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0, 1.2), breaks = seq(0.0, 1.2, 0.2)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.45, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(rowMeans(cbind(LUAD_BPRNACan3DProMet_decon$cancer, LUAD_methy_decon$cancer))), as.matrix(Facs_LUAD_modif$CPE))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.05, label = paste("RMSE =", round(sqrt(mean((as.matrix(rowMeans(cbind(LUAD_BPRNACan3DProMet_decon$cancer, LUAD_methy_decon$cancer))) - as.matrix(Facs_LUAD_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 0.9, label = paste("n = ", nrow(LUAD_BPRNACan_decon)), size = 4)


#### Lymphocytes

lymph_LUAD_BPRNACan_avr <- rowMeans(cbind(LUAD_BPRNACan_decon$B + LUAD_BPRNACan_decon$NK + LUAD_BPRNACan_decon$CD4 + LUAD_BPRNACan_decon$CD8, LUAD_methy_decon$B + LUAD_methy_decon$CD4 + LUAD_methy_decon$CD8 + LUAD_methy_decon$NK + LUAD_methy_decon$Treg))

a <- cbind(lymph_LUAD_BPRNACan_avr, HE_LUAD_modif$Lymphocytes)
colnames(a) <- c("Cancer_cell_fractions", "Lymphocytes")

Fig_LUAD_lymph_BPRNACan_avrage <- ggscatter(data.frame(a), x = "Lymphocytes", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_LUAD_BPRNACan_avr), as.matrix(HE_LUAD_modif$Lymphocytes))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_LUAD_BPRNACan_avr) - as.matrix(HE_LUAD_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(LUAD_methy_decon)), size = 4)


lymph_LUAD_BPRNACanProMet_avr <- rowMeans(cbind(LUAD_BPRNACanProMet_decon$B + LUAD_BPRNACanProMet_decon$NK + LUAD_BPRNACanProMet_decon$CD4 + LUAD_BPRNACanProMet_decon$CD8, LUAD_methy_decon$B + LUAD_methy_decon$CD4 + LUAD_methy_decon$CD8 + LUAD_methy_decon$NK + LUAD_methy_decon$Treg))

a <- cbind(lymph_LUAD_BPRNACanProMet_avr, HE_LUAD_modif$Lymphocytes)
colnames(a) <- c("Cancer_cell_fractions", "Lymphocytes")

Fig_LUAD_lymph_BPRNACanProMet_avrage <- ggscatter(data.frame(a), x = "Lymphocytes", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_LUAD_BPRNACanProMet_avr), as.matrix(HE_LUAD_modif$Lymphocytes))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_LUAD_BPRNACanProMet_avr) - as.matrix(HE_LUAD_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(LUAD_methy_decon)), size = 4)

lymph_LUAD_BPRNACan3DProMet_avr <- rowMeans(cbind(LUAD_BPRNACan3DProMet_decon$B + LUAD_BPRNACan3DProMet_decon$NK + LUAD_BPRNACan3DProMet_decon$CD4 + LUAD_BPRNACan3DProMet_decon$CD8, LUAD_methy_decon$B + LUAD_methy_decon$CD4 + LUAD_methy_decon$CD8 + LUAD_methy_decon$NK + LUAD_methy_decon$Treg))

a <- cbind(lymph_LUAD_BPRNACan3DProMet_avr, HE_LUAD_modif$Lymphocytes)
colnames(a) <- c("Cancer_cell_fractions", "Lymphocytes")

Fig_LUAD_lymph_BPRNACan3DProMet_avrage <- ggscatter(data.frame(a), x = "Lymphocytes", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_LUAD_BPRNACan3DProMet_avr), as.matrix(HE_LUAD_modif$Lymphocytes))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_LUAD_BPRNACan3DProMet_avr) - as.matrix(HE_LUAD_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(LUAD_methy_decon)), size = 4)

#### Macrophages

Macro_LUAD_BPRNACan_avr <- rowMeans(cbind(LUAD_BPRNACan_decon$M0 + LUAD_BPRNACan_decon$M1 + LUAD_BPRNACan_decon$M2 + LUAD_BPRNACan_decon$Mono, LUAD_methy_decon$M0 + LUAD_methy_decon$M1 + LUAD_methy_decon$M2 + LUAD_methy_decon$Mono))

a <- cbind(Macro_LUAD_BPRNACan_avr, HE_LUAD_modif$Macrophages)
colnames(a) <- c("Cancer_cell_fractions", "Macrophages")

Fig_LUAD_Macro_BPRNACan_avrage <- ggscatter(data.frame(a), x = "Macrophages", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_LUAD_BPRNACan_avr), as.matrix(HE_LUAD_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_LUAD_BPRNACan_avr) - as.matrix(HE_LUAD_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(LUAD_methy_decon)), size = 4)

Macro_LUAD_BPRNACanProMet_avr <- rowMeans(cbind(LUAD_BPRNACanProMet_decon$M0 + LUAD_BPRNACanProMet_decon$M1 + LUAD_BPRNACanProMet_decon$M2 + LUAD_BPRNACanProMet_decon$Mono, LUAD_methy_decon$M0 + LUAD_methy_decon$M1 + LUAD_methy_decon$M2 + LUAD_methy_decon$Mono))

a <- cbind(Macro_LUAD_BPRNACanProMet_avr, HE_LUAD_modif$Macrophages)
colnames(a) <- c("Cancer_cell_fractions", "Macrophages")

Fig_LUAD_Macro_BPRNACanProMet_avrage <- ggscatter(data.frame(a), x = "Macrophages", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_LUAD_BPRNACanProMet_avr), as.matrix(HE_LUAD_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_LUAD_BPRNACanProMet_avr) - as.matrix(HE_LUAD_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(LUAD_methy_decon)), size = 4)


Macro_LUAD_BPRNACan3DProMet_avr <- rowMeans(cbind(LUAD_BPRNACan3DProMet_decon$M0 + LUAD_BPRNACan3DProMet_decon$M1 + LUAD_BPRNACan3DProMet_decon$M2 + LUAD_BPRNACan3DProMet_decon$Mono, LUAD_methy_decon$M0 + LUAD_methy_decon$M1 + LUAD_methy_decon$M2 + LUAD_methy_decon$Mono))

a <- cbind(Macro_LUAD_BPRNACan3DProMet_avr, HE_LUAD_modif$Macrophages)
colnames(a) <- c("Cancer_cell_fractions", "Macrophages")

Fig_LUAD_Macro_BPRNACan3DProMet_avrage <- ggscatter(data.frame(a), x = "Macrophages", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_LUAD_BPRNACan3DProMet_avr), as.matrix(HE_LUAD_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_LUAD_BPRNACan3DProMet_avr) - as.matrix(HE_LUAD_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(LUAD_methy_decon)), size = 4)


#### Neutrophils

a <- cbind(rowMeans(cbind(LUAD_BPRNACan_decon$Neu, LUAD_methy_decon$Neu)), HE_LUAD_modif$Neutrophils)
colnames(a) <- c("Cancer_cell_fractions", "Neutrophils")

Fig_LUAD_Neu_BPRNACan_avrage <- ggscatter(data.frame(a), x = "Neutrophils", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.4)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.012, y = 0.4, label = paste("italic(r)==", round(cor.test(as.matrix(rowMeans(cbind(LUAD_BPRNACan_decon$Neu, LUAD_methy_decon$Neu))), as.matrix(HE_LUAD_modif$Neutrophils))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(rowMeans(cbind(LUAD_BPRNACan_decon$Neu, LUAD_methy_decon$Neu))), as.matrix(HE_LUAD_modif$Neutrophils))$p.value, 9)), parse = TRUE, size = 4) + annotate("text", x = 0.008, y = 0.35, label = paste("RMSE =", round(sqrt(mean((as.matrix(rowMeans(cbind(LUAD_BPRNACan_decon$Neu, LUAD_methy_decon$Neu))) - as.matrix(HE_LUAD_modif$Neutrophils))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.0051, y = 0.3, label = paste("n = ", nrow(LUAD_methy_decon)), size = 4)

a <- cbind(rowMeans(cbind(LUAD_BPRNACanProMet_decon$Neu, LUAD_methy_decon$Neu)), HE_LUAD_modif$Neutrophils)
colnames(a) <- c("Cancer_cell_fractions", "Neutrophils")

Fig_LUAD_Neu_BPRNACanProMet_avrage <- ggscatter(data.frame(a), x = "Neutrophils", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.4)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.012, y = 0.4, label = paste("italic(r)==", round(cor.test(as.matrix(rowMeans(cbind(LUAD_BPRNACanProMet_decon$Neu, LUAD_methy_decon$Neu))), as.matrix(HE_LUAD_modif$Neutrophils))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(rowMeans(cbind(LUAD_BPRNACanProMet_decon$Neu, LUAD_methy_decon$Neu))), as.matrix(HE_LUAD_modif$Neutrophils))$p.value, 9)), parse = TRUE, size = 4) + annotate("text", x = 0.008, y = 0.35, label = paste("RMSE =", round(sqrt(mean((as.matrix(rowMeans(cbind(LUAD_BPRNACanProMet_decon$Neu, LUAD_methy_decon$Neu))) - as.matrix(HE_LUAD_modif$Neutrophils))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.0051, y = 0.3, label = paste("n = ", nrow(LUAD_methy_decon)), size = 4)

a <- cbind(rowMeans(cbind(LUAD_BPRNACan3DProMet_decon$Neu, LUAD_methy_decon$Neu)), HE_LUAD_modif$Neutrophils)
colnames(a) <- c("Cancer_cell_fractions", "Neutrophils")

Fig_LUAD_Neu_BPRNACan3DProMet_avrage <- ggscatter(data.frame(a), x = "Neutrophils", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.4)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.012, y = 0.4, label = paste("italic(r)==", round(cor.test(as.matrix(rowMeans(cbind(LUAD_BPRNACan3DProMet_decon$Neu, LUAD_methy_decon$Neu))), as.matrix(HE_LUAD_modif$Neutrophils))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(rowMeans(cbind(LUAD_BPRNACan3DProMet_decon$Neu, LUAD_methy_decon$Neu))), as.matrix(HE_LUAD_modif$Neutrophils))$p.value, 9)), parse = TRUE, size = 4) + annotate("text", x = 0.008, y = 0.35, label = paste("RMSE =", round(sqrt(mean((as.matrix(rowMeans(cbind(LUAD_BPRNACan3DProMet_decon$Neu, LUAD_methy_decon$Neu))) - as.matrix(HE_LUAD_modif$Neutrophils))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.0051, y = 0.3, label = paste("n = ", nrow(LUAD_methy_decon)), size = 4)
```

```{r}
#### BPRNACan3D

Lym_LUAD_3DRNA <- cbind(lymph_LUAD_BPRNACan3DProMet, HE_LUAD_modif$Lymphocytes)
colnames(Lym_LUAD_3DRNA) <- c("Cancer_cell_fractions", "Lymphocytes")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((lymph_LUAD_BPRNACan3DProMet - HE_LUAD_modif$Lymphocytes)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Lym_LUAD_3DRNA <- ggplot(as.data.frame(Lym_LUAD_3DRNA), aes(x = Lymphocytes, y = Cancer_cell_fractions)) +
  geom_point(colour = c("darkslategrey")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"BPRNACan3D") +
  scale_x_continuous(name = NULL, limits = c(0, max(Lym_LUAD_3DRNA))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Lym_LUAD_3DRNA))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)

Macro_LUAD_3DRNA <- cbind(Macro_LUAD_BPRNACan3DProMet, HE_LUAD_modif$Macrophages)
colnames(Macro_LUAD_3DRNA) <- c("Cancer_cell_fractions", "Macrophages")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((Macro_LUAD_BPRNACan3DProMet - HE_LUAD_modif$Macrophages)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Macro_LUAD_3DRNA <- ggplot(as.data.frame(Macro_LUAD_3DRNA), aes(x = Macrophages, y = Cancer_cell_fractions)) +
  geom_point(colour = c("coral")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"BPRNACan3D") +
  scale_x_continuous(name = NULL, limits = c(0, max(Macro_LUAD_3DRNA))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Macro_LUAD_3DRNA))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)


Neu_LUAD_3DRNA <- cbind(LUAD_BPRNACan3DProMet_decon$Neu, HE_LUAD_modif$Neutrophils)
colnames(Neu_LUAD_3DRNA) <- c("Cancer_cell_fractions", "Neutrophils")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((LUAD_BPRNACan3DProMet_decon$Neu - HE_LUAD_modif$Neutrophils)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Neu_LUAD_3DRNA <- ggplot(as.data.frame(Neu_LUAD_3DRNA), aes(x = Neutrophils, y = Cancer_cell_fractions)) +
  geom_point(colour = c("green")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"BPRNACan3D") +
  scale_x_continuous(name = NULL, limits = c(0, max(Neu_LUAD_3DRNA))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Neu_LUAD_3DRNA))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)


#### BPmetCan

#### lympho

Lym_LUAD_methy <- cbind(lymph_methy, HE_LUAD_modif$Lymphocytes)
colnames(Lym_LUAD_methy) <- c("Cancer_cell_fractions", "Lymphocytes")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((Lym_LUAD_methy - HE_LUAD_modif$Lymphocytes)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Lym_LUAD_BPmetCan <- ggplot(as.data.frame(Lym_LUAD_methy), aes(x = Lymphocytes, y = Cancer_cell_fractions)) +
  geom_point(colour = c("darkslategrey")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"BPmetCan") +
  scale_x_continuous(name = NULL, limits = c(0, max(Lym_LUAD_methy))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Lym_LUAD_methy))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)

#### Macro

Macro_Methy <- LUAD_methy_decon$M0 + LUAD_methy_decon$M1 + LUAD_methy_decon$M2 + LUAD_methy_decon$Mono

Macro_LUAD_methy <- cbind(Macro_Methy, HE_LUAD_modif$Macrophages)
colnames(Macro_LUAD_methy) <- c("Cancer_cell_fractions", "Macrophages")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((Macro_LUAD_methy - HE_LUAD_modif$Macrophages)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Macro_LUAD_BPmetCan <- ggplot(as.data.frame(Macro_LUAD_methy), aes(x = Macrophages, y = Cancer_cell_fractions)) +
  geom_point(colour = c("coral")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"BPmetCan") +
  scale_x_continuous(name = NULL, limits = c(0, max(Macro_Methy))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Macro_Methy))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)


#### Neu

Neu_LUAD_methy <- cbind(LUAD_methy_decon$Neu, HE_LUAD_modif$Neutrophils)
colnames(Neu_LUAD_methy) <- c("Cancer_cell_fractions", "Neutrophils")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((LUAD_methy_decon$Neu - HE_LUAD_modif$Neutrophils)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Neu_LUAD_BPmetCan <- ggplot(as.data.frame(Neu_LUAD_methy), aes(x = Neutrophils, y = Cancer_cell_fractions)) +
  geom_point(colour = c("green")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"BPmetCan") + 
  scale_x_continuous(name = NULL, limits = c(0, max(Neu_LUAD_methy))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Neu_LUAD_methy))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)



#### avrg

Lym_LUAD_avrg <- cbind(lymph_LUAD_BPRNACan_avr, HE_LUAD_modif$Lymphocytes)
colnames(Lym_LUAD_avrg) <- c("Cancer_cell_fractions", "Lymphocytes")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((lymph_LUAD_BPRNACan_avr - HE_LUAD_modif$Lymphocytes)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Lym_LUAD_avrg <- ggplot(as.data.frame(Lym_LUAD_avrg), aes(x = Lymphocytes, y = Cancer_cell_fractions)) +
  geom_point(colour = c("darkslategrey")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"Meth + RNA") + 
  scale_x_continuous(name = NULL, limits = c(0, max(Lym_LUAD_avrg))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Lym_LUAD_avrg))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)


Macro_LUAD_avrg <- cbind(Macro_LUAD_BPRNACan_avr, HE_LUAD_modif$Macrophages)
colnames(Macro_LUAD_avrg) <- c("Cancer_cell_fractions", "Macrophages")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((Macro_LUAD_BPRNACan_avr - HE_LUAD_modif$Macrophages)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Macro_LUAD_avrg <- ggplot(as.data.frame(Macro_LUAD_avrg), aes(x = Macrophages, y = Cancer_cell_fractions)) +
  geom_point(colour = c("coral")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"Meth + RNA") +
  scale_x_continuous(name = NULL, limits = c(0, max(Macro_LUAD_avrg))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Macro_LUAD_avrg))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)

Neu_LUAD_avrg <- cbind(rowMeans(cbind(LUAD_BPRNACan_decon$Neu, LUAD_methy_decon$Neu)), HE_LUAD_modif$Neutrophils)
colnames(Neu_LUAD_avrg) <- c("Cancer_cell_fractions", "Neutrophils")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean(rowMeans(cbind(LUAD_BPRNACan_decon$Neu, LUAD_methy_decon$Neu) - HE_LUAD_modif$Neutrophils)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Neu_LUAD_avrg <- ggplot(as.data.frame(Neu_LUAD_avrg), aes(x = Neutrophils, y = Cancer_cell_fractions)) +
  geom_point(colour = c("green")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"Meth + RNA") + 
  scale_x_continuous(name = NULL, limits = c(0, max(Neu_LUAD_avrg))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Neu_LUAD_avrg))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)



lymph = ggarrange(fig_Lym_LUAD_3DRNA, fig_Lym_LUAD_BPmetCan, fig_Lym_LUAD_avrg, ncol = 3, nrow = 1, labels = "a", font.label = list(size = 20, color = "black"), align = "hv")
neutro = ggarrange(fig_Neu_LUAD_3DRNA, fig_Neu_LUAD_BPmetCan, fig_Neu_LUAD_avrg, ncol = 3, nrow = 1, labels = "b", font.label = list(size = 20, color = "black"), align = "hv")
macro = ggarrange(fig_Macro_LUAD_3DRNA, fig_Macro_LUAD_BPmetCan, fig_Macro_LUAD_avrg, ncol = 3, nrow = 1, labels = "c", font.label = list(size = 20, color = "black"), align = "hv")


All_LUAD <- ggarrange(lymph, neutro, macro, ncol = 1, nrow = 3, font.label = list(size = 20, color = "black"), align = "hv")


All_LUAD <- annotate_figure(All_LUAD,
  left = text_grob("Estimated fractions", color = "black", size = 20, rot = 90),
  bottom = text_grob("H&E estimates", color = "black", size = 20)
  
)

All_LUAD
```
RNA, methylation, and averaged values of correlation across a : lymphocytes, b: neutrophils, c : macrophages, using the BPRNACan3D and BPMetCan signatures on EpiDish.

## LUSC

```{r}

LUSC_methy_decon <- read.table("/mnt/SERVER-CRCT-STORAGE/CRCT21/Private/Julien/gemdecan/data/meth/LUSC.txt", sep = "\t", header = T)

Facs_LUSC <- Aran_all_facs[Aran_all_facs$Cancer_type == "LUSC", ]

HE_LUSC <- HE_all_TCGA[HE_all_TCGA$Study == "LUSC", ]

Facs_LUSC_modif <- Facs_LUSC[Facs_LUSC$CPE != "NaN", ]

Comm_samples <- Reduce(intersect, list(HE_LUSC$ParticipantBarcode, Facs_LUSC_modif$Sample_ID, tcga_deconv$Samples, rownames(LUSC_methy_decon)))

Facs_LUSC_modif <- Facs_LUSC_modif %>% .[.$Sample_ID %in% Comm_samples, ]

HE_LUSC_modif <- HE_LUSC %>%
  .[.$ParticipantBarcode %in% Comm_samples, ] %>%
  .[order(.$ParticipantBarcode), ]

LUSC_methy_decon <- LUSC_methy_decon[Comm_samples, ] %>% 
  rownames_to_column() 
LUSC_methy_decon <- LUSC_methy_decon[order(LUSC_methy_decon$rowname), ]
rownames(LUSC_methy_decon) <- LUSC_methy_decon$rowname
LUSC_methy_decon <- LUSC_methy_decon[,-1]

LUSC_RNA_decon <- tcga_deconv %>% filter(Samples %in% Comm_samples)

###################################
##### Estimating Tumor Purity #####
###################################


LUSC_BPRNACan_decon <- LUSC_RNA_decon %>% select(colnames(LUSC_RNA_decon)[grepl("Epidish_BPRNACan_", colnames(LUSC_RNA_decon))])
colnames(LUSC_BPRNACan_decon) <- colnames(LUSC_BPRNACan_decon) %>% str_remove_all("Epidish_BPRNACan_")

a <- cbind(LUSC_BPRNACan_decon$cancer, Facs_LUSC_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_LUSC_BPRNACan <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUSC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0.8, 1.2), breaks = seq(0.0, 1.2, 0.1)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.42, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(LUSC_BPRNACan_decon$cancer), as.matrix(Facs_LUSC_modif$CPE))$est, 2), "~','", "~italic(P)<", round(cor.test(as.matrix(LUSC_BPRNACan_decon$cancer), as.matrix(Facs_LUSC_modif$CPE))$p.value, 14)), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.15, label = paste("RMSE =", round(sqrt(mean((as.matrix(LUSC_BPRNACan_decon$cancer) - as.matrix(Facs_LUSC_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 1.1, label = paste("n = ", nrow(LUSC_BPRNACan_decon)), size = 4)


LUSC_BPRNACanProMet_decon <- LUSC_RNA_decon %>% select(colnames(LUSC_RNA_decon)[grepl("Epidish_BPRNACanProMet_", colnames(LUSC_RNA_decon))])
colnames(LUSC_BPRNACanProMet_decon) <- colnames(LUSC_BPRNACanProMet_decon) %>% str_remove_all("Epidish_BPRNACanProMet_")

a <- cbind(LUSC_BPRNACanProMet_decon$cancer, Facs_LUSC_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_LUSC_BPRNACanProMet <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUSC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0.8, 1.2), breaks = seq(0.0, 1.2, 0.1)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.45, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(LUSC_BPRNACanProMet_decon$cancer), as.matrix(Facs_LUSC_modif$CPE))$est, 2), "~','", "~italic(P)<", round(cor.test(as.matrix(LUSC_BPRNACanProMet_decon$cancer), as.matrix(Facs_LUSC_modif$CPE))$p.value, 14)), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.15, label = paste("RMSE =", round(sqrt(mean((as.matrix(LUSC_BPRNACanProMet_decon$cancer) - as.matrix(Facs_LUSC_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 1.1, label = paste("n = ", nrow(LUSC_BPRNACanProMet_decon)), size = 4)


LUSC_BPRNACan3DProMet_decon <- LUSC_RNA_decon %>% select(colnames(LUSC_RNA_decon)[grepl("Epidish_BPRNACan3DProMet_", colnames(LUSC_RNA_decon))])
colnames(LUSC_BPRNACan3DProMet_decon) <- colnames(LUSC_BPRNACan3DProMet_decon) %>% str_remove_all("Epidish_BPRNACan3DProMet_")


a <- cbind(LUSC_BPRNACan3DProMet_decon$cancer, Facs_LUSC_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_LUSC_BPRNACan3DProMet <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUSC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0.8, 1.2), breaks = seq(0.0, 1.2, 0.1)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.52, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(LUSC_BPRNACan3DProMet_decon$cancer), as.matrix(Facs_LUSC_modif$CPE))$est, 2), "~','", "~italic(P)<", round(cor.test(as.matrix(LUSC_BPRNACan3DProMet_decon$cancer), as.matrix(Facs_LUSC_modif$CPE))$p.value, 14)), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.15, label = paste("RMSE =", round(sqrt(mean((as.matrix(LUSC_BPRNACan3DProMet_decon$cancer) - as.matrix(Facs_LUSC_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 1.1, label = paste("n = ", nrow(LUSC_BPRNACan3DProMet_decon)), size = 4)

###### Methylation part

a <- cbind(LUSC_methy_decon$cancer, Facs_LUSC_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_LUSC_BPmetCan <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUSC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0, 1.2), breaks = seq(0.0, 1.2, 0.2)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.45, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(LUSC_methy_decon$cancer), as.matrix(Facs_LUSC_modif$CPE))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.05, label = paste("RMSE =", round(sqrt(mean((as.matrix(LUSC_methy_decon$cancer) - as.matrix(Facs_LUSC_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 0.9, label = paste("n = ", nrow(LUSC_methy_decon)), size = 4)


###############################################################
##### Estimating Lymphocytes, Macrophages and Neutrophils #####
###############################################################

##### RNA expression Part #####

#### lymph

lymph_LUSC_BPRNACan <- LUSC_BPRNACan_decon$B + LUSC_BPRNACan_decon$CD4 + LUSC_BPRNACan_decon$CD8 + LUSC_BPRNACan_decon$NK

a <- cbind(lymph_LUSC_BPRNACan, HE_LUSC_modif$Lymphocytes)
colnames(a) <- c("lymph_fractions", "HE")

Fig_LUSC_lymph_BPRNACan <- ggscatter(data.frame(a), x = "HE", y = "lymph_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUSC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.08)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.235, y = 0.08, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_LUSC_BPRNACan), as.matrix(HE_LUSC_modif$Lymphocytes))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.07, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_LUSC_BPRNACan) - as.matrix(HE_LUSC_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.06, label = paste("n = ", nrow(LUSC_methy_decon)), size = 4)



lymph_LUSC_BPRNACanProMet <- LUSC_BPRNACanProMet_decon$B + LUSC_BPRNACanProMet_decon$CD4 + LUSC_BPRNACanProMet_decon$CD8 + LUSC_BPRNACanProMet_decon$NK

a <- cbind(lymph_LUSC_BPRNACanProMet, HE_LUSC_modif$Lymphocytes)
colnames(a) <- c("lymph_fractions", "HE")

Fig_LUSC_lymph_BPRNACanProMet <- ggscatter(data.frame(a), x = "HE", y = "lymph_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUSC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.08)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.235, y = 0.08, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_LUSC_BPRNACanProMet), as.matrix(HE_LUSC_modif$Lymphocytes))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(lymph_LUSC_BPRNACanProMet), as.matrix(HE_LUSC_modif$Lymphocytes))$p.value, 13)), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.07, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_LUSC_BPRNACanProMet) - as.matrix(HE_LUSC_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.06, label = paste("n = ", nrow(LUSC_BPRNACanProMet_decon)), size = 4)


lymph_LUSC_BPRNACan3DProMet <- LUSC_BPRNACan3DProMet_decon$B + LUSC_BPRNACan3DProMet_decon$CD4 + LUSC_BPRNACan3DProMet_decon$CD8 + LUSC_BPRNACan3DProMet_decon$NK

a <- cbind(lymph_LUSC_BPRNACan3DProMet, HE_LUSC_modif$Lymphocytes)
colnames(a) <- c("lymph_fractions", "HE")

Fig_LUSC_lymph_BPRNACan3DProMet <- ggscatter(data.frame(a), x = "HE", y = "lymph_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUSC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.08)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.235, y = 0.08, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_LUSC_BPRNACan3DProMet), as.matrix(HE_LUSC_modif$Lymphocytes))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(lymph_LUSC_BPRNACan3DProMet), as.matrix(HE_LUSC_modif$Lymphocytes))$p.value, 13)), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.07, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_LUSC_BPRNACan3DProMet) - as.matrix(HE_LUSC_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.06, label = paste("n = ", nrow(LUSC_BPRNACanProMet_decon)), size = 4)


#### Macro

Macro_LUSC_BPRNACan <- LUSC_BPRNACan_decon$M0 + LUSC_BPRNACan_decon$M1 + LUSC_BPRNACan_decon$M2 + LUSC_BPRNACan_decon$Mono

a <- cbind(Macro_LUSC_BPRNACan, HE_LUSC_modif$Macrophages)
colnames(a) <- c("Macro_fractions", "HE")

Fig_LUSC_Macro_BPRNACan <- ggscatter(data.frame(a), x = "HE", y = "Macro_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUSC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.4)) + scale_y_continuous(name = NULL, limits = c(0, 0.06)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.175, y = 0.06, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_LUSC_BPRNACan), as.matrix(HE_LUSC_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.11, y = 0.0526, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_LUSC_BPRNACan) - as.matrix(HE_LUSC_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.08, y = 0.045, label = paste("n = ", nrow(LUSC_BPRNACan_decon)), size = 4)



Macro_LUSC_BPRNACanProMet <- LUSC_BPRNACanProMet_decon$M0 + LUSC_BPRNACanProMet_decon$M1 + LUSC_BPRNACanProMet_decon$M2 + LUSC_BPRNACanProMet_decon$Mono

a <- cbind(Macro_LUSC_BPRNACanProMet, HE_LUSC_modif$Macrophages)
colnames(a) <- c("Macro_fractions", "HE")

Fig_LUSC_Macro_BPRNACanProMet <- ggscatter(data.frame(a), x = "HE", y = "Macro_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUSC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.4)) + scale_y_continuous(name = NULL, limits = c(0, 0.06)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.185, y = 0.06, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_LUSC_BPRNACanProMet), as.matrix(HE_LUSC_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.11, y = 0.0526, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_LUSC_BPRNACanProMet) - as.matrix(HE_LUSC_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.08, y = 0.045, label = paste("n = ", nrow(LUSC_BPRNACan_decon)), size = 4)

Macro_LUSC_BPRNACan3DProMet <- LUSC_BPRNACan3DProMet_decon$M0 + LUSC_BPRNACan3DProMet_decon$M1 + LUSC_BPRNACan3DProMet_decon$M2 + LUSC_BPRNACan3DProMet_decon$Mono

a <- cbind(Macro_LUSC_BPRNACan3DProMet, HE_LUSC_modif$Macrophages)
colnames(a) <- c("Macro_fractions", "HE")

Fig_LUSC_Macro_BPRNACan3DProMet <- ggscatter(data.frame(a), x = "HE", y = "Macro_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUSC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.4)) + scale_y_continuous(name = NULL, limits = c(0, 0.06)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.185, y = 0.06, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_LUSC_BPRNACan3DProMet), as.matrix(HE_LUSC_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.11, y = 0.0526, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_LUSC_BPRNACan3DProMet) - as.matrix(HE_LUSC_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.08, y = 0.045, label = paste("n = ", nrow(LUSC_BPRNACan_decon)), size = 4)

#### Neutrophis

a <- cbind(LUSC_BPRNACan_decon$Neu, HE_LUSC_modif$Neutrophils)
colnames(a) <- c("Neu_fractions", "HE")

Fig_LUSC_Neu_BPRNACan <- ggscatter(data.frame(a), x = "HE", y = "Neu_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUSC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.006)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.015, y = 0.006, label = paste("italic(r)==", round(cor.test(as.matrix(LUSC_BPRNACan_decon$Neu), as.matrix(HE_LUSC_modif$Neutrophils))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.009, y = 0.00525, label = paste("RMSE =", round(sqrt(mean((as.matrix(LUSC_BPRNACan_decon$Neu) - as.matrix(HE_LUSC_modif$Neutrophils))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.0065, y = 0.0046, label = paste("n = ", nrow(LUSC_BPRNACan_decon)), size = 4)


a <- cbind(LUSC_BPRNACanProMet_decon$Neu, HE_LUSC_modif$Neutrophils)
colnames(a) <- c("Neu_fractions", "HE")

Fig_LUSC_Neu_BPRNACanProMet <- ggscatter(data.frame(a[-155, ]), x = "HE", y = "Neu_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUSC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.006)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.015, y = 0.006, label = paste("italic(r)==", round(cor.test(as.matrix(LUSC_BPRNACanProMet_decon$Neu), as.matrix(HE_LUSC_modif$Neutrophils))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.0105, y = 0.00525, label = paste("RMSE =", round(sqrt(mean((as.matrix(LUSC_BPRNACanProMet_decon$Neu) - as.matrix(HE_LUSC_modif$Neutrophils))^2, na.rm = T)), 5)), parse = F, size = 4) + annotate("text", x = 0.0065, y = 0.0046, label = paste("n = ", nrow(LUSC_BPRNACan_decon)), size = 4)


a <- cbind(LUSC_BPRNACan3DProMet_decon$Neu, HE_LUSC_modif$Neutrophils)
colnames(a) <- c("Neu_fractions", "HE")

Fig_LUSC_Neu_BPRNACan3DProMet <- ggscatter(data.frame(a), x = "HE", y = "Neu_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUSC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.008)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.015, y = 0.008, label = paste("italic(r)==", round(cor.test(as.matrix(LUSC_BPRNACan3DProMet_decon$Neu), as.matrix(HE_LUSC_modif$Neutrophils))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(LUSC_BPRNACan3DProMet_decon$Neu), as.matrix(HE_LUSC_modif$Neutrophils))$p.value, 15)), parse = TRUE, size = 4) + annotate("text", x = 0.0105, y = 0.007, label = paste("RMSE =", round(sqrt(mean((as.matrix(LUSC_BPRNACan3DProMet_decon$Neu) - as.matrix(HE_LUSC_modif$Neutrophils))^2, na.rm = T)), 3)), parse = F, size = 4) + annotate("text", x = 0.0065, y = 0.006, label = paste("n = ", nrow(LUSC_BPRNACan_decon)), size = 4)

##### DNA methylation Part #####

#### lympho

lymph_methy <- LUSC_methy_decon$B + LUSC_methy_decon$CD4 + LUSC_methy_decon$CD8 + LUSC_methy_decon$Treg + LUSC_methy_decon$NK

a <- cbind(lymph_methy, HE_LUSC_modif$Lymphocytes)
colnames(a) <- c("lymph_methy", "HE_lympho")

Fig_LUSC_lymph_BPmetCan <- ggscatter(data.frame(a), x = "HE_lympho", y = "lymph_methy", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUSC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_methy), as.matrix(HE_LUSC_modif$Lymphocytes))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_methy) - as.matrix(HE_LUSC_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(LUSC_methy_decon)), size = 4)


#### Macro

Macro_Methy <- LUSC_methy_decon$M0 + LUSC_methy_decon$M1 + LUSC_methy_decon$M2 + LUSC_methy_decon$Mono

a <- cbind(Macro_Methy, HE_LUSC_modif$Macrophages)
colnames(a) <- c("Macro_Methy", "HE_macro")

Fig_LUSC_Macro_BPmetCan <- ggscatter(data.frame(a), x = "HE_macro", y = "Macro_Methy", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUSC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_Methy), as.matrix(HE_LUSC_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_Methy) - as.matrix(HE_LUSC_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(LUSC_methy_decon)), size = 4)

#### Neu

a <- cbind(LUSC_methy_decon$Neu, HE_LUSC_modif$Neutrophils)
colnames(a) <- c("Neu_Methy", "HE_neu")

Fig_LUSC_Neu_BPmetCan <- ggscatter(data.frame(a), x = "HE_neu", y = "Neu_Methy", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUSC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.8)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.0135, y = 0.8, label = paste("italic(r)==", round(cor.test(as.matrix(LUSC_methy_decon$Neu), as.matrix(HE_LUSC_modif$Neutrophils))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(LUSC_methy_decon$Neu), as.matrix(HE_LUSC_modif$Neutrophils))$p.value, 10)), parse = TRUE, size = 4) + annotate("text", x = 0.0085, y = 0.7, label = paste("RMSE =", round(sqrt(mean((as.matrix(LUSC_methy_decon$Neu) - as.matrix(HE_LUSC_modif$Neutrophils))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.0057, y = 0.6, label = paste("n = ", nrow(LUSC_methy_decon)), size = 4)


##### Correlation between DNA methylation and expression deconvolution #####

## Tumor purity

a <- cbind(LUSC_BPRNACan_decon$cancer, LUSC_methy_decon$cancer)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_LUSC_TM_BPRNACan_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUSC") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL, limits = c(0, 1)) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", label.x = 0, label.y = 1, size = 6)

a <- cbind(LUSC_BPRNACanProMet_decon$cancer, LUSC_methy_decon$cancer)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_LUSC_TM_BPRNACanProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUSC") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL, limits = c(0, 1)) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", label.x = 0, label.y = 1, size = 6)

a <- cbind(LUSC_BPRNACan3DProMet_decon$cancer, LUSC_methy_decon$cancer)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_LUSC_TM_BPRNACan3DProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUSC") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL, limits = c(0, 1)) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", label.x = 0, label.y = 1, size = 6)


## Lymphcytes

a <- cbind(lymph_LUSC_BPRNACan, lymph_methy)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_LUSC_lymph_BPRNACan_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUSC") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")

a <- cbind(lymph_LUSC_BPRNACanProMet, lymph_methy)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_LUSC_lymph_BPRNACanProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUSC") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")

a <- cbind(lymph_LUSC_BPRNACan3DProMet, lymph_methy)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_LUSC_lymph_BPRNACan3DProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUSC") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")


## Macrophages

a <- cbind(Macro_LUSC_BPRNACan, Macro_Methy)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_LUSC_macro_BPRNACan_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUSC") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")


a <- cbind(Macro_LUSC_BPRNACanProMet, Macro_Methy)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_LUSC_macro_BPRNACanProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUSC") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")

a <- cbind(Macro_LUSC_BPRNACan3DProMet, Macro_Methy)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_LUSC_macro_BPRNACan3DProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUSC") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")


## Netrophils

a <- cbind(LUSC_BPRNACan_decon$Neu, LUSC_methy_decon$Neu)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_LUSC_Neu_BPRNACan_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUSC") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")


a <- cbind(LUSC_BPRNACanProMet_decon$Neu, LUSC_methy_decon$Neu)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_LUSC_Neu_BPRNACanProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUSC") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")

a <- cbind(LUSC_BPRNACan3DProMet_decon$Neu, LUSC_methy_decon$Neu)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_LUSC_Neu_BPRNACan3DProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUSC") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")



###############################################
###### average of Methylation and RNAseq ######
###############################################

#### Tumor purity

a <- cbind(rowMeans(cbind(LUSC_BPRNACan_decon$cancer, LUSC_methy_decon$cancer)), Facs_LUSC_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_LUSC_BPRNACan_avrage <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUSC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0, 1.2), breaks = seq(0.0, 1.2, 0.2)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.45, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(rowMeans(cbind(LUSC_BPRNACan_decon$cancer, LUSC_methy_decon$cancer))), as.matrix(Facs_LUSC_modif$CPE))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.05, label = paste("RMSE =", round(sqrt(mean((as.matrix(rowMeans(cbind(LUSC_BPRNACan_decon$cancer, LUSC_methy_decon$cancer))) - as.matrix(Facs_LUSC_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 0.9, label = paste("n = ", nrow(LUSC_BPRNACan_decon)), size = 4)


a <- cbind(rowMeans(cbind(LUSC_BPRNACanProMet_decon$cancer, LUSC_methy_decon$cancer)), Facs_LUSC_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_LUSC_BPRNACanProMet_avrage <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUSC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0, 1.2), breaks = seq(0.0, 1.2, 0.2)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.45, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(rowMeans(cbind(LUSC_BPRNACanProMet_decon$cancer, LUSC_methy_decon$cancer))), as.matrix(Facs_LUSC_modif$CPE))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.05, label = paste("RMSE =", round(sqrt(mean((as.matrix(rowMeans(cbind(LUSC_BPRNACanProMet_decon$cancer, LUSC_methy_decon$cancer))) - as.matrix(Facs_LUSC_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 0.9, label = paste("n = ", nrow(LUSC_BPRNACan_decon)), size = 4)


a <- cbind(rowMeans(cbind(LUSC_BPRNACan3DProMet_decon$cancer, LUSC_methy_decon$cancer)), Facs_LUSC_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_LUSC_BPRNACan3DProMet_avrage <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUSC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0, 1.2), breaks = seq(0.0, 1.2, 0.2)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.45, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(rowMeans(cbind(LUSC_BPRNACan3DProMet_decon$cancer, LUSC_methy_decon$cancer))), as.matrix(Facs_LUSC_modif$CPE))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.05, label = paste("RMSE =", round(sqrt(mean((as.matrix(rowMeans(cbind(LUSC_BPRNACan3DProMet_decon$cancer, LUSC_methy_decon$cancer))) - as.matrix(Facs_LUSC_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 0.9, label = paste("n = ", nrow(LUSC_BPRNACan_decon)), size = 4)


#### Lymphocytes

lymph_LUSC_BPRNACan_avr <- rowMeans(cbind(LUSC_BPRNACan_decon$B + LUSC_BPRNACan_decon$NK + LUSC_BPRNACan_decon$CD4 + LUSC_BPRNACan_decon$CD8, LUSC_methy_decon$B + LUSC_methy_decon$CD4 + LUSC_methy_decon$CD8 + LUSC_methy_decon$NK + LUSC_methy_decon$Treg))

a <- cbind(lymph_LUSC_BPRNACan_avr, HE_LUSC_modif$Lymphocytes)
colnames(a) <- c("Cancer_cell_fractions", "Lymphocytes")

Fig_LUSC_lymph_BPRNACan_avrage <- ggscatter(data.frame(a), x = "Lymphocytes", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUSC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_LUSC_BPRNACan_avr), as.matrix(HE_LUSC_modif$Lymphocytes))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_LUSC_BPRNACan_avr) - as.matrix(HE_LUSC_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(LUSC_methy_decon)), size = 4)


lymph_LUSC_BPRNACanProMet_avr <- rowMeans(cbind(LUSC_BPRNACanProMet_decon$B + LUSC_BPRNACanProMet_decon$NK + LUSC_BPRNACanProMet_decon$CD4 + LUSC_BPRNACanProMet_decon$CD8, LUSC_methy_decon$B + LUSC_methy_decon$CD4 + LUSC_methy_decon$CD8 + LUSC_methy_decon$NK + LUSC_methy_decon$Treg))

a <- cbind(lymph_LUSC_BPRNACanProMet_avr, HE_LUSC_modif$Lymphocytes)
colnames(a) <- c("Cancer_cell_fractions", "Lymphocytes")

Fig_LUSC_lymph_BPRNACanProMet_avrage <- ggscatter(data.frame(a), x = "Lymphocytes", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUSC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_LUSC_BPRNACanProMet_avr), as.matrix(HE_LUSC_modif$Lymphocytes))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_LUSC_BPRNACanProMet_avr) - as.matrix(HE_LUSC_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(LUSC_methy_decon)), size = 4)

lymph_LUSC_BPRNACan3DProMet_avr <- rowMeans(cbind(LUSC_BPRNACan3DProMet_decon$B + LUSC_BPRNACan3DProMet_decon$NK + LUSC_BPRNACan3DProMet_decon$CD4 + LUSC_BPRNACan3DProMet_decon$CD8, LUSC_methy_decon$B + LUSC_methy_decon$CD4 + LUSC_methy_decon$CD8 + LUSC_methy_decon$NK + LUSC_methy_decon$Treg))

a <- cbind(lymph_LUSC_BPRNACan3DProMet_avr, HE_LUSC_modif$Lymphocytes)
colnames(a) <- c("Cancer_cell_fractions", "Lymphocytes")

Fig_LUSC_lymph_BPRNACan3DProMet_avrage <- ggscatter(data.frame(a), x = "Lymphocytes", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUSC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_LUSC_BPRNACan3DProMet_avr), as.matrix(HE_LUSC_modif$Lymphocytes))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_LUSC_BPRNACan3DProMet_avr) - as.matrix(HE_LUSC_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(LUSC_methy_decon)), size = 4)

#### Macrophages

Macro_LUSC_BPRNACan_avr <- rowMeans(cbind(LUSC_BPRNACan_decon$M0 + LUSC_BPRNACan_decon$M1 + LUSC_BPRNACan_decon$M2 + LUSC_BPRNACan_decon$Mono, LUSC_methy_decon$M0 + LUSC_methy_decon$M1 + LUSC_methy_decon$M2 + LUSC_methy_decon$Mono))

a <- cbind(Macro_LUSC_BPRNACan_avr, HE_LUSC_modif$Macrophages)
colnames(a) <- c("Cancer_cell_fractions", "Macrophages")

Fig_LUSC_Macro_BPRNACan_avrage <- ggscatter(data.frame(a), x = "Macrophages", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUSC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_LUSC_BPRNACan_avr), as.matrix(HE_LUSC_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_LUSC_BPRNACan_avr) - as.matrix(HE_LUSC_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(LUSC_methy_decon)), size = 4)

Macro_LUSC_BPRNACanProMet_avr <- rowMeans(cbind(LUSC_BPRNACanProMet_decon$M0 + LUSC_BPRNACanProMet_decon$M1 + LUSC_BPRNACanProMet_decon$M2 + LUSC_BPRNACanProMet_decon$Mono, LUSC_methy_decon$M0 + LUSC_methy_decon$M1 + LUSC_methy_decon$M2 + LUSC_methy_decon$Mono))

a <- cbind(Macro_LUSC_BPRNACanProMet_avr, HE_LUSC_modif$Macrophages)
colnames(a) <- c("Cancer_cell_fractions", "Macrophages")

Fig_LUSC_Macro_BPRNACanProMet_avrage <- ggscatter(data.frame(a), x = "Macrophages", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUSC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_LUSC_BPRNACanProMet_avr), as.matrix(HE_LUSC_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_LUSC_BPRNACanProMet_avr) - as.matrix(HE_LUSC_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(LUSC_methy_decon)), size = 4)


Macro_LUSC_BPRNACan3DProMet_avr <- rowMeans(cbind(LUSC_BPRNACan3DProMet_decon$M0 + LUSC_BPRNACan3DProMet_decon$M1 + LUSC_BPRNACan3DProMet_decon$M2 + LUSC_BPRNACan3DProMet_decon$Mono, LUSC_methy_decon$M0 + LUSC_methy_decon$M1 + LUSC_methy_decon$M2 + LUSC_methy_decon$Mono))

a <- cbind(Macro_LUSC_BPRNACan3DProMet_avr, HE_LUSC_modif$Macrophages)
colnames(a) <- c("Cancer_cell_fractions", "Macrophages")

Fig_LUSC_Macro_BPRNACan3DProMet_avrage <- ggscatter(data.frame(a), x = "Macrophages", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUSC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_LUSC_BPRNACan3DProMet_avr), as.matrix(HE_LUSC_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_LUSC_BPRNACan3DProMet_avr) - as.matrix(HE_LUSC_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(LUSC_methy_decon)), size = 4)


#### Neutrophils

a <- cbind(rowMeans(cbind(LUSC_BPRNACan_decon$Neu, LUSC_methy_decon$Neu)), HE_LUSC_modif$Neutrophils)
colnames(a) <- c("Cancer_cell_fractions", "Neutrophils")

Fig_LUSC_Neu_BPRNACan_avrage <- ggscatter(data.frame(a), x = "Neutrophils", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUSC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.4)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.012, y = 0.4, label = paste("italic(r)==", round(cor.test(as.matrix(rowMeans(cbind(LUSC_BPRNACan_decon$Neu, LUSC_methy_decon$Neu))), as.matrix(HE_LUSC_modif$Neutrophils))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(rowMeans(cbind(LUSC_BPRNACan_decon$Neu, LUSC_methy_decon$Neu))), as.matrix(HE_LUSC_modif$Neutrophils))$p.value, 9)), parse = TRUE, size = 4) + annotate("text", x = 0.008, y = 0.35, label = paste("RMSE =", round(sqrt(mean((as.matrix(rowMeans(cbind(LUSC_BPRNACan_decon$Neu, LUSC_methy_decon$Neu))) - as.matrix(HE_LUSC_modif$Neutrophils))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.0051, y = 0.3, label = paste("n = ", nrow(LUSC_methy_decon)), size = 4)

a <- cbind(rowMeans(cbind(LUSC_BPRNACanProMet_decon$Neu, LUSC_methy_decon$Neu)), HE_LUSC_modif$Neutrophils)
colnames(a) <- c("Cancer_cell_fractions", "Neutrophils")

Fig_LUSC_Neu_BPRNACanProMet_avrage <- ggscatter(data.frame(a), x = "Neutrophils", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUSC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.4)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.012, y = 0.4, label = paste("italic(r)==", round(cor.test(as.matrix(rowMeans(cbind(LUSC_BPRNACanProMet_decon$Neu, LUSC_methy_decon$Neu))), as.matrix(HE_LUSC_modif$Neutrophils))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(rowMeans(cbind(LUSC_BPRNACanProMet_decon$Neu, LUSC_methy_decon$Neu))), as.matrix(HE_LUSC_modif$Neutrophils))$p.value, 9)), parse = TRUE, size = 4) + annotate("text", x = 0.008, y = 0.35, label = paste("RMSE =", round(sqrt(mean((as.matrix(rowMeans(cbind(LUSC_BPRNACanProMet_decon$Neu, LUSC_methy_decon$Neu))) - as.matrix(HE_LUSC_modif$Neutrophils))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.0051, y = 0.3, label = paste("n = ", nrow(LUSC_methy_decon)), size = 4)

a <- cbind(rowMeans(cbind(LUSC_BPRNACan3DProMet_decon$Neu, LUSC_methy_decon$Neu)), HE_LUSC_modif$Neutrophils)
colnames(a) <- c("Cancer_cell_fractions", "Neutrophils")

Fig_LUSC_Neu_BPRNACan3DProMet_avrage <- ggscatter(data.frame(a), x = "Neutrophils", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "LUSC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.4)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.012, y = 0.4, label = paste("italic(r)==", round(cor.test(as.matrix(rowMeans(cbind(LUSC_BPRNACan3DProMet_decon$Neu, LUSC_methy_decon$Neu))), as.matrix(HE_LUSC_modif$Neutrophils))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(rowMeans(cbind(LUSC_BPRNACan3DProMet_decon$Neu, LUSC_methy_decon$Neu))), as.matrix(HE_LUSC_modif$Neutrophils))$p.value, 9)), parse = TRUE, size = 4) + annotate("text", x = 0.008, y = 0.35, label = paste("RMSE =", round(sqrt(mean((as.matrix(rowMeans(cbind(LUSC_BPRNACan3DProMet_decon$Neu, LUSC_methy_decon$Neu))) - as.matrix(HE_LUSC_modif$Neutrophils))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.0051, y = 0.3, label = paste("n = ", nrow(LUSC_methy_decon)), size = 4)
```

```{r}
#### BPRNACan3D

Lym_LUSC_3DRNA <- cbind(lymph_LUSC_BPRNACan3DProMet, HE_LUSC_modif$Lymphocytes)
colnames(Lym_LUSC_3DRNA) <- c("Cancer_cell_fractions", "Lymphocytes")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((lymph_LUSC_BPRNACan3DProMet - HE_LUSC_modif$Lymphocytes)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Lym_LUSC_3DRNA <- ggplot(as.data.frame(Lym_LUSC_3DRNA), aes(x = Lymphocytes, y = Cancer_cell_fractions)) +
  geom_point(colour = c("darkslategrey")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"BPRNACan3D") +
  scale_x_continuous(name = NULL, limits = c(0, max(Lym_LUSC_3DRNA))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Lym_LUSC_3DRNA))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)

Macro_LUSC_3DRNA <- cbind(Macro_LUSC_BPRNACan3DProMet, HE_LUSC_modif$Macrophages)
colnames(Macro_LUSC_3DRNA) <- c("Cancer_cell_fractions", "Macrophages")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((Macro_LUSC_BPRNACan3DProMet - HE_LUSC_modif$Macrophages)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Macro_LUSC_3DRNA <- ggplot(as.data.frame(Macro_LUSC_3DRNA), aes(x = Macrophages, y = Cancer_cell_fractions)) +
  geom_point(colour = c("coral")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"BPRNACan3D") +
  scale_x_continuous(name = NULL, limits = c(0, max(Macro_LUSC_3DRNA))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Macro_LUSC_3DRNA))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)


Neu_LUSC_3DRNA <- cbind(LUSC_BPRNACan3DProMet_decon$Neu, HE_LUSC_modif$Neutrophils)
colnames(Neu_LUSC_3DRNA) <- c("Cancer_cell_fractions", "Neutrophils")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((LUSC_BPRNACan3DProMet_decon$Neu - HE_LUSC_modif$Neutrophils)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Neu_LUSC_3DRNA <- ggplot(as.data.frame(Neu_LUSC_3DRNA), aes(x = Neutrophils, y = Cancer_cell_fractions)) +
  geom_point(colour = c("green")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"BPRNACan3D") +
  scale_x_continuous(name = NULL, limits = c(0, max(Neu_LUSC_3DRNA))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Neu_LUSC_3DRNA))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)


#### BPmetCan

#### lympho

Lym_LUSC_methy <- cbind(lymph_methy, HE_LUSC_modif$Lymphocytes)
colnames(Lym_LUSC_methy) <- c("Cancer_cell_fractions", "Lymphocytes")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((Lym_LUSC_methy - HE_LUSC_modif$Lymphocytes)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Lym_LUSC_BPmetCan <- ggplot(as.data.frame(Lym_LUSC_methy), aes(x = Lymphocytes, y = Cancer_cell_fractions)) +
  geom_point(colour = c("darkslategrey")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"BPmetCan") +
  scale_x_continuous(name = NULL, limits = c(0, max(Lym_LUSC_methy))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Lym_LUSC_methy))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)

#### Macro

Macro_Methy <- LUSC_methy_decon$M0 + LUSC_methy_decon$M1 + LUSC_methy_decon$M2 + LUSC_methy_decon$Mono

Macro_LUSC_methy <- cbind(Macro_Methy, HE_LUSC_modif$Macrophages)
colnames(Macro_LUSC_methy) <- c("Cancer_cell_fractions", "Macrophages")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((Macro_LUSC_methy - HE_LUSC_modif$Macrophages)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Macro_LUSC_BPmetCan <- ggplot(as.data.frame(Macro_LUSC_methy), aes(x = Macrophages, y = Cancer_cell_fractions)) +
  geom_point(colour = c("coral")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"BPmetCan") +
  scale_x_continuous(name = NULL, limits = c(0, max(Macro_Methy))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Macro_Methy))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)


#### Neu

Neu_LUSC_methy <- cbind(LUSC_methy_decon$Neu, HE_LUSC_modif$Neutrophils)
colnames(Neu_LUSC_methy) <- c("Cancer_cell_fractions", "Neutrophils")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((LUSC_methy_decon$Neu - HE_LUSC_modif$Neutrophils)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Neu_LUSC_BPmetCan <- ggplot(as.data.frame(Neu_LUSC_methy), aes(x = Neutrophils, y = Cancer_cell_fractions)) +
  geom_point(colour = c("green")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"BPmetCan") + 
  scale_x_continuous(name = NULL, limits = c(0, max(Neu_LUSC_methy))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Neu_LUSC_methy))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)



#### avrg

Lym_LUSC_avrg <- cbind(lymph_LUSC_BPRNACan_avr, HE_LUSC_modif$Lymphocytes)
colnames(Lym_LUSC_avrg) <- c("Cancer_cell_fractions", "Lymphocytes")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((lymph_LUSC_BPRNACan_avr - HE_LUSC_modif$Lymphocytes)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Lym_LUSC_avrg <- ggplot(as.data.frame(Lym_LUSC_avrg), aes(x = Lymphocytes, y = Cancer_cell_fractions)) +
  geom_point(colour = c("darkslategrey")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"Meth + RNA") + 
  scale_x_continuous(name = NULL, limits = c(0, max(Lym_LUSC_avrg))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Lym_LUSC_avrg))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)


Macro_LUSC_avrg <- cbind(Macro_LUSC_BPRNACan_avr, HE_LUSC_modif$Macrophages)
colnames(Macro_LUSC_avrg) <- c("Cancer_cell_fractions", "Macrophages")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((Macro_LUSC_BPRNACan_avr - HE_LUSC_modif$Macrophages)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Macro_LUSC_avrg <- ggplot(as.data.frame(Macro_LUSC_avrg), aes(x = Macrophages, y = Cancer_cell_fractions)) +
  geom_point(colour = c("coral")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"Meth + RNA") +
  scale_x_continuous(name = NULL, limits = c(0, max(Macro_LUSC_avrg))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Macro_LUSC_avrg))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)

Neu_LUSC_avrg <- cbind(rowMeans(cbind(LUSC_BPRNACan_decon$Neu, LUSC_methy_decon$Neu)), HE_LUSC_modif$Neutrophils)
colnames(Neu_LUSC_avrg) <- c("Cancer_cell_fractions", "Neutrophils")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean(rowMeans(cbind(LUSC_BPRNACan_decon$Neu, LUSC_methy_decon$Neu) - HE_LUSC_modif$Neutrophils)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Neu_LUSC_avrg <- ggplot(as.data.frame(Neu_LUSC_avrg), aes(x = Neutrophils, y = Cancer_cell_fractions)) +
  geom_point(colour = c("green")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"Meth + RNA") + 
  scale_x_continuous(name = NULL, limits = c(0, max(Neu_LUSC_avrg))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Neu_LUSC_avrg))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)



lymph = ggarrange(fig_Lym_LUSC_3DRNA, fig_Lym_LUSC_BPmetCan, fig_Lym_LUSC_avrg, ncol = 3, nrow = 1, labels = "a", font.label = list(size = 20, color = "black"), align = "hv")
neutro = ggarrange(fig_Neu_LUSC_3DRNA, fig_Neu_LUSC_BPmetCan, fig_Neu_LUSC_avrg, ncol = 3, nrow = 1, labels = "b", font.label = list(size = 20, color = "black"), align = "hv")
macro = ggarrange(fig_Macro_LUSC_3DRNA, fig_Macro_LUSC_BPmetCan, fig_Macro_LUSC_avrg, ncol = 3, nrow = 1, labels = "c", font.label = list(size = 20, color = "black"), align = "hv")


All_LUSC <- ggarrange(lymph, neutro, macro, ncol = 1, nrow = 3, font.label = list(size = 20, color = "black"), align = "hv")


All_LUSC <- annotate_figure(All_LUSC,
  left = text_grob("Estimated fractions", color = "black", size = 20, rot = 90),
  bottom = text_grob("H&E estimates", color = "black", size = 20)
  
)

All_LUSC
```
RNA, methylation, and averaged values of correlation across a : lymphocytes, b: neutrophils, c : macrophages, using the BPRNACan3D and BPMetCan signatures on EpiDish.

## PRAD 

```{r}

PRAD_methy_decon <- read.table("/mnt/SERVER-CRCT-STORAGE/CRCT21/Private/Julien/gemdecan/data/meth/PRAD.txt", sep = "\t", header = T)

Facs_PRAD <- Aran_all_facs[Aran_all_facs$Cancer_type == "PRAD", ]

HE_PRAD <- HE_all_TCGA[HE_all_TCGA$Study == "PRAD", ]

Facs_PRAD_modif <- Facs_PRAD[Facs_PRAD$CPE != "NaN", ]

Comm_samples <- Reduce(intersect, list(HE_PRAD$ParticipantBarcode, Facs_PRAD_modif$Sample_ID, tcga_deconv$Samples, rownames(PRAD_methy_decon)))

Facs_PRAD_modif <- Facs_PRAD_modif %>% .[.$Sample_ID %in% Comm_samples, ]

HE_PRAD_modif <- HE_PRAD %>%
  .[.$ParticipantBarcode %in% Comm_samples, ] %>%
  .[order(.$ParticipantBarcode), ]

PRAD_methy_decon <- PRAD_methy_decon[Comm_samples, ] %>% 
  rownames_to_column() 
PRAD_methy_decon <- PRAD_methy_decon[order(PRAD_methy_decon$rowname), ]
rownames(PRAD_methy_decon) <- PRAD_methy_decon$rowname
PRAD_methy_decon <- PRAD_methy_decon[,-1]

PRAD_RNA_decon <- tcga_deconv %>% filter(Samples %in% Comm_samples)

###################################
##### Estimating Tumor Purity #####
###################################


PRAD_BPRNACan_decon <- PRAD_RNA_decon %>% select(colnames(PRAD_RNA_decon)[grepl("Epidish_BPRNACan_", colnames(PRAD_RNA_decon))])
colnames(PRAD_BPRNACan_decon) <- colnames(PRAD_BPRNACan_decon) %>% str_remove_all("Epidish_BPRNACan_")

a <- cbind(PRAD_BPRNACan_decon$cancer, Facs_PRAD_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_PRAD_BPRNACan <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "PRAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0.8, 1.2), breaks = seq(0.0, 1.2, 0.1)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.42, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(PRAD_BPRNACan_decon$cancer), as.matrix(Facs_PRAD_modif$CPE))$est, 2), "~','", "~italic(P)<", round(cor.test(as.matrix(PRAD_BPRNACan_decon$cancer), as.matrix(Facs_PRAD_modif$CPE))$p.value, 14)), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.15, label = paste("RMSE =", round(sqrt(mean((as.matrix(PRAD_BPRNACan_decon$cancer) - as.matrix(Facs_PRAD_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 1.1, label = paste("n = ", nrow(PRAD_BPRNACan_decon)), size = 4)


PRAD_BPRNACanProMet_decon <- PRAD_RNA_decon %>% select(colnames(PRAD_RNA_decon)[grepl("Epidish_BPRNACanProMet_", colnames(PRAD_RNA_decon))])
colnames(PRAD_BPRNACanProMet_decon) <- colnames(PRAD_BPRNACanProMet_decon) %>% str_remove_all("Epidish_BPRNACanProMet_")

a <- cbind(PRAD_BPRNACanProMet_decon$cancer, Facs_PRAD_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_PRAD_BPRNACanProMet <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "PRAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0.8, 1.2), breaks = seq(0.0, 1.2, 0.1)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.45, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(PRAD_BPRNACanProMet_decon$cancer), as.matrix(Facs_PRAD_modif$CPE))$est, 2), "~','", "~italic(P)<", round(cor.test(as.matrix(PRAD_BPRNACanProMet_decon$cancer), as.matrix(Facs_PRAD_modif$CPE))$p.value, 14)), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.15, label = paste("RMSE =", round(sqrt(mean((as.matrix(PRAD_BPRNACanProMet_decon$cancer) - as.matrix(Facs_PRAD_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 1.1, label = paste("n = ", nrow(PRAD_BPRNACanProMet_decon)), size = 4)


PRAD_BPRNACan3DProMet_decon <- PRAD_RNA_decon %>% select(colnames(PRAD_RNA_decon)[grepl("Epidish_BPRNACan3DProMet_", colnames(PRAD_RNA_decon))])
colnames(PRAD_BPRNACan3DProMet_decon) <- colnames(PRAD_BPRNACan3DProMet_decon) %>% str_remove_all("Epidish_BPRNACan3DProMet_")


a <- cbind(PRAD_BPRNACan3DProMet_decon$cancer, Facs_PRAD_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_PRAD_BPRNACan3DProMet <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "PRAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0.8, 1.2), breaks = seq(0.0, 1.2, 0.1)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.52, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(PRAD_BPRNACan3DProMet_decon$cancer), as.matrix(Facs_PRAD_modif$CPE))$est, 2), "~','", "~italic(P)<", round(cor.test(as.matrix(PRAD_BPRNACan3DProMet_decon$cancer), as.matrix(Facs_PRAD_modif$CPE))$p.value, 14)), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.15, label = paste("RMSE =", round(sqrt(mean((as.matrix(PRAD_BPRNACan3DProMet_decon$cancer) - as.matrix(Facs_PRAD_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 1.1, label = paste("n = ", nrow(PRAD_BPRNACan3DProMet_decon)), size = 4)

###### Methylation part

a <- cbind(PRAD_methy_decon$cancer, Facs_PRAD_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_PRAD_BPmetCan <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "PRAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0, 1.2), breaks = seq(0.0, 1.2, 0.2)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.45, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(PRAD_methy_decon$cancer), as.matrix(Facs_PRAD_modif$CPE))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.05, label = paste("RMSE =", round(sqrt(mean((as.matrix(PRAD_methy_decon$cancer) - as.matrix(Facs_PRAD_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 0.9, label = paste("n = ", nrow(PRAD_methy_decon)), size = 4)


###############################################################
##### Estimating Lymphocytes, Macrophages and Neutrophils #####
###############################################################

##### RNA expression Part #####

#### lymph

lymph_PRAD_BPRNACan <- PRAD_BPRNACan_decon$B + PRAD_BPRNACan_decon$CD4 + PRAD_BPRNACan_decon$CD8 + PRAD_BPRNACan_decon$NK

a <- cbind(lymph_PRAD_BPRNACan, HE_PRAD_modif$Lymphocytes)
colnames(a) <- c("lymph_fractions", "HE")

Fig_PRAD_lymph_BPRNACan <- ggscatter(data.frame(a), x = "HE", y = "lymph_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "PRAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.08)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.235, y = 0.08, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_PRAD_BPRNACan), as.matrix(HE_PRAD_modif$Lymphocytes))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.07, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_PRAD_BPRNACan) - as.matrix(HE_PRAD_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.06, label = paste("n = ", nrow(PRAD_methy_decon)), size = 4)



lymph_PRAD_BPRNACanProMet <- PRAD_BPRNACanProMet_decon$B + PRAD_BPRNACanProMet_decon$CD4 + PRAD_BPRNACanProMet_decon$CD8 + PRAD_BPRNACanProMet_decon$NK

a <- cbind(lymph_PRAD_BPRNACanProMet, HE_PRAD_modif$Lymphocytes)
colnames(a) <- c("lymph_fractions", "HE")

Fig_PRAD_lymph_BPRNACanProMet <- ggscatter(data.frame(a), x = "HE", y = "lymph_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "PRAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.08)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.235, y = 0.08, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_PRAD_BPRNACanProMet), as.matrix(HE_PRAD_modif$Lymphocytes))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(lymph_PRAD_BPRNACanProMet), as.matrix(HE_PRAD_modif$Lymphocytes))$p.value, 13)), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.07, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_PRAD_BPRNACanProMet) - as.matrix(HE_PRAD_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.06, label = paste("n = ", nrow(PRAD_BPRNACanProMet_decon)), size = 4)


lymph_PRAD_BPRNACan3DProMet <- PRAD_BPRNACan3DProMet_decon$B + PRAD_BPRNACan3DProMet_decon$CD4 + PRAD_BPRNACan3DProMet_decon$CD8 + PRAD_BPRNACan3DProMet_decon$NK

a <- cbind(lymph_PRAD_BPRNACan3DProMet, HE_PRAD_modif$Lymphocytes)
colnames(a) <- c("lymph_fractions", "HE")

Fig_PRAD_lymph_BPRNACan3DProMet <- ggscatter(data.frame(a), x = "HE", y = "lymph_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "PRAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.08)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.235, y = 0.08, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_PRAD_BPRNACan3DProMet), as.matrix(HE_PRAD_modif$Lymphocytes))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(lymph_PRAD_BPRNACan3DProMet), as.matrix(HE_PRAD_modif$Lymphocytes))$p.value, 13)), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.07, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_PRAD_BPRNACan3DProMet) - as.matrix(HE_PRAD_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.06, label = paste("n = ", nrow(PRAD_BPRNACanProMet_decon)), size = 4)


#### Macro

Macro_PRAD_BPRNACan <- PRAD_BPRNACan_decon$M0 + PRAD_BPRNACan_decon$M1 + PRAD_BPRNACan_decon$M2 + PRAD_BPRNACan_decon$Mono

a <- cbind(Macro_PRAD_BPRNACan, HE_PRAD_modif$Macrophages)
colnames(a) <- c("Macro_fractions", "HE")

Fig_PRAD_Macro_BPRNACan <- ggscatter(data.frame(a), x = "HE", y = "Macro_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "PRAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.4)) + scale_y_continuous(name = NULL, limits = c(0, 0.06)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.175, y = 0.06, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_PRAD_BPRNACan), as.matrix(HE_PRAD_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.11, y = 0.0526, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_PRAD_BPRNACan) - as.matrix(HE_PRAD_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.08, y = 0.045, label = paste("n = ", nrow(PRAD_BPRNACan_decon)), size = 4)



Macro_PRAD_BPRNACanProMet <- PRAD_BPRNACanProMet_decon$M0 + PRAD_BPRNACanProMet_decon$M1 + PRAD_BPRNACanProMet_decon$M2 + PRAD_BPRNACanProMet_decon$Mono

a <- cbind(Macro_PRAD_BPRNACanProMet, HE_PRAD_modif$Macrophages)
colnames(a) <- c("Macro_fractions", "HE")

Fig_PRAD_Macro_BPRNACanProMet <- ggscatter(data.frame(a), x = "HE", y = "Macro_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "PRAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.4)) + scale_y_continuous(name = NULL, limits = c(0, 0.06)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.185, y = 0.06, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_PRAD_BPRNACanProMet), as.matrix(HE_PRAD_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.11, y = 0.0526, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_PRAD_BPRNACanProMet) - as.matrix(HE_PRAD_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.08, y = 0.045, label = paste("n = ", nrow(PRAD_BPRNACan_decon)), size = 4)

Macro_PRAD_BPRNACan3DProMet <- PRAD_BPRNACan3DProMet_decon$M0 + PRAD_BPRNACan3DProMet_decon$M1 + PRAD_BPRNACan3DProMet_decon$M2 + PRAD_BPRNACan3DProMet_decon$Mono

a <- cbind(Macro_PRAD_BPRNACan3DProMet, HE_PRAD_modif$Macrophages)
colnames(a) <- c("Macro_fractions", "HE")

Fig_PRAD_Macro_BPRNACan3DProMet <- ggscatter(data.frame(a), x = "HE", y = "Macro_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "PRAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.4)) + scale_y_continuous(name = NULL, limits = c(0, 0.06)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.185, y = 0.06, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_PRAD_BPRNACan3DProMet), as.matrix(HE_PRAD_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.11, y = 0.0526, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_PRAD_BPRNACan3DProMet) - as.matrix(HE_PRAD_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.08, y = 0.045, label = paste("n = ", nrow(PRAD_BPRNACan_decon)), size = 4)

#### Neutrophis

a <- cbind(PRAD_BPRNACan_decon$Neu, HE_PRAD_modif$Neutrophils)
colnames(a) <- c("Neu_fractions", "HE")

Fig_PRAD_Neu_BPRNACan <- ggscatter(data.frame(a), x = "HE", y = "Neu_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "PRAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.006)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.015, y = 0.006, label = paste("italic(r)==", round(cor.test(as.matrix(PRAD_BPRNACan_decon$Neu), as.matrix(HE_PRAD_modif$Neutrophils))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.009, y = 0.00525, label = paste("RMSE =", round(sqrt(mean((as.matrix(PRAD_BPRNACan_decon$Neu) - as.matrix(HE_PRAD_modif$Neutrophils))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.0065, y = 0.0046, label = paste("n = ", nrow(PRAD_BPRNACan_decon)), size = 4)


a <- cbind(PRAD_BPRNACanProMet_decon$Neu, HE_PRAD_modif$Neutrophils)
colnames(a) <- c("Neu_fractions", "HE")

Fig_PRAD_Neu_BPRNACanProMet <- ggscatter(data.frame(a[-155, ]), x = "HE", y = "Neu_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "PRAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.006)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.015, y = 0.006, label = paste("italic(r)==", round(cor.test(as.matrix(PRAD_BPRNACanProMet_decon$Neu), as.matrix(HE_PRAD_modif$Neutrophils))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.0105, y = 0.00525, label = paste("RMSE =", round(sqrt(mean((as.matrix(PRAD_BPRNACanProMet_decon$Neu) - as.matrix(HE_PRAD_modif$Neutrophils))^2, na.rm = T)), 5)), parse = F, size = 4) + annotate("text", x = 0.0065, y = 0.0046, label = paste("n = ", nrow(PRAD_BPRNACan_decon)), size = 4)


a <- cbind(PRAD_BPRNACan3DProMet_decon$Neu, HE_PRAD_modif$Neutrophils)
colnames(a) <- c("Neu_fractions", "HE")

Fig_PRAD_Neu_BPRNACan3DProMet <- ggscatter(data.frame(a), x = "HE", y = "Neu_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "PRAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.008)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.015, y = 0.008, label = paste("italic(r)==", round(cor.test(as.matrix(PRAD_BPRNACan3DProMet_decon$Neu), as.matrix(HE_PRAD_modif$Neutrophils))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(PRAD_BPRNACan3DProMet_decon$Neu), as.matrix(HE_PRAD_modif$Neutrophils))$p.value, 15)), parse = TRUE, size = 4) + annotate("text", x = 0.0105, y = 0.007, label = paste("RMSE =", round(sqrt(mean((as.matrix(PRAD_BPRNACan3DProMet_decon$Neu) - as.matrix(HE_PRAD_modif$Neutrophils))^2, na.rm = T)), 3)), parse = F, size = 4) + annotate("text", x = 0.0065, y = 0.006, label = paste("n = ", nrow(PRAD_BPRNACan_decon)), size = 4)

##### DNA methylation Part #####

#### lympho

lymph_methy <- PRAD_methy_decon$B + PRAD_methy_decon$CD4 + PRAD_methy_decon$CD8 + PRAD_methy_decon$Treg + PRAD_methy_decon$NK

a <- cbind(lymph_methy, HE_PRAD_modif$Lymphocytes)
colnames(a) <- c("lymph_methy", "HE_lympho")

Fig_PRAD_lymph_BPmetCan <- ggscatter(data.frame(a), x = "HE_lympho", y = "lymph_methy", size = 2, add.params = list(color = "black"), color = "chocolate", title = "PRAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_methy), as.matrix(HE_PRAD_modif$Lymphocytes))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_methy) - as.matrix(HE_PRAD_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(PRAD_methy_decon)), size = 4)


#### Macro

Macro_Methy <- PRAD_methy_decon$M0 + PRAD_methy_decon$M1 + PRAD_methy_decon$M2 + PRAD_methy_decon$Mono

a <- cbind(Macro_Methy, HE_PRAD_modif$Macrophages)
colnames(a) <- c("Macro_Methy", "HE_macro")

Fig_PRAD_Macro_BPmetCan <- ggscatter(data.frame(a), x = "HE_macro", y = "Macro_Methy", size = 2, add.params = list(color = "black"), color = "chocolate", title = "PRAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_Methy), as.matrix(HE_PRAD_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_Methy) - as.matrix(HE_PRAD_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(PRAD_methy_decon)), size = 4)

#### Neu

a <- cbind(PRAD_methy_decon$Neu, HE_PRAD_modif$Neutrophils)
colnames(a) <- c("Neu_Methy", "HE_neu")

Fig_PRAD_Neu_BPmetCan <- ggscatter(data.frame(a), x = "HE_neu", y = "Neu_Methy", size = 2, add.params = list(color = "black"), color = "chocolate", title = "PRAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.8)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.0135, y = 0.8, label = paste("italic(r)==", round(cor.test(as.matrix(PRAD_methy_decon$Neu), as.matrix(HE_PRAD_modif$Neutrophils))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(PRAD_methy_decon$Neu), as.matrix(HE_PRAD_modif$Neutrophils))$p.value, 10)), parse = TRUE, size = 4) + annotate("text", x = 0.0085, y = 0.7, label = paste("RMSE =", round(sqrt(mean((as.matrix(PRAD_methy_decon$Neu) - as.matrix(HE_PRAD_modif$Neutrophils))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.0057, y = 0.6, label = paste("n = ", nrow(PRAD_methy_decon)), size = 4)


##### Correlation between DNA methylation and expression deconvolution #####

## Tumor purity

a <- cbind(PRAD_BPRNACan_decon$cancer, PRAD_methy_decon$cancer)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_PRAD_TM_BPRNACan_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", size = 2, add.params = list(color = "black"), color = "chocolate", title = "PRAD") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL, limits = c(0, 1)) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", label.x = 0, label.y = 1, size = 6)

a <- cbind(PRAD_BPRNACanProMet_decon$cancer, PRAD_methy_decon$cancer)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_PRAD_TM_BPRNACanProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", size = 2, add.params = list(color = "black"), color = "chocolate", title = "PRAD") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL, limits = c(0, 1)) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", label.x = 0, label.y = 1, size = 6)

a <- cbind(PRAD_BPRNACan3DProMet_decon$cancer, PRAD_methy_decon$cancer)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_PRAD_TM_BPRNACan3DProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", size = 2, add.params = list(color = "black"), color = "chocolate", title = "PRAD") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL, limits = c(0, 1)) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", label.x = 0, label.y = 1, size = 6)


## Lymphcytes

a <- cbind(lymph_PRAD_BPRNACan, lymph_methy)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_PRAD_lymph_BPRNACan_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "PRAD") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")

a <- cbind(lymph_PRAD_BPRNACanProMet, lymph_methy)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_PRAD_lymph_BPRNACanProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "PRAD") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")

a <- cbind(lymph_PRAD_BPRNACan3DProMet, lymph_methy)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_PRAD_lymph_BPRNACan3DProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "PRAD") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")


## Macrophages

a <- cbind(Macro_PRAD_BPRNACan, Macro_Methy)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_PRAD_macro_BPRNACan_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "PRAD") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")


a <- cbind(Macro_PRAD_BPRNACanProMet, Macro_Methy)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_PRAD_macro_BPRNACanProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "PRAD") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")

a <- cbind(Macro_PRAD_BPRNACan3DProMet, Macro_Methy)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_PRAD_macro_BPRNACan3DProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "PRAD") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")


## Netrophils

a <- cbind(PRAD_BPRNACan_decon$Neu, PRAD_methy_decon$Neu)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_PRAD_Neu_BPRNACan_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "PRAD") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")


a <- cbind(PRAD_BPRNACanProMet_decon$Neu, PRAD_methy_decon$Neu)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_PRAD_Neu_BPRNACanProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "PRAD") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")

a <- cbind(PRAD_BPRNACan3DProMet_decon$Neu, PRAD_methy_decon$Neu)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_PRAD_Neu_BPRNACan3DProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "PRAD") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")



###############################################
###### average of Methylation and RNAseq ######
###############################################

#### Tumor purity

a <- cbind(rowMeans(cbind(PRAD_BPRNACan_decon$cancer, PRAD_methy_decon$cancer)), Facs_PRAD_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_PRAD_BPRNACan_avrage <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "PRAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0, 1.2), breaks = seq(0.0, 1.2, 0.2)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.45, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(rowMeans(cbind(PRAD_BPRNACan_decon$cancer, PRAD_methy_decon$cancer))), as.matrix(Facs_PRAD_modif$CPE))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.05, label = paste("RMSE =", round(sqrt(mean((as.matrix(rowMeans(cbind(PRAD_BPRNACan_decon$cancer, PRAD_methy_decon$cancer))) - as.matrix(Facs_PRAD_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 0.9, label = paste("n = ", nrow(PRAD_BPRNACan_decon)), size = 4)


a <- cbind(rowMeans(cbind(PRAD_BPRNACanProMet_decon$cancer, PRAD_methy_decon$cancer)), Facs_PRAD_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_PRAD_BPRNACanProMet_avrage <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "PRAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0, 1.2), breaks = seq(0.0, 1.2, 0.2)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.45, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(rowMeans(cbind(PRAD_BPRNACanProMet_decon$cancer, PRAD_methy_decon$cancer))), as.matrix(Facs_PRAD_modif$CPE))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.05, label = paste("RMSE =", round(sqrt(mean((as.matrix(rowMeans(cbind(PRAD_BPRNACanProMet_decon$cancer, PRAD_methy_decon$cancer))) - as.matrix(Facs_PRAD_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 0.9, label = paste("n = ", nrow(PRAD_BPRNACan_decon)), size = 4)


a <- cbind(rowMeans(cbind(PRAD_BPRNACan3DProMet_decon$cancer, PRAD_methy_decon$cancer)), Facs_PRAD_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_PRAD_BPRNACan3DProMet_avrage <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "PRAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0, 1.2), breaks = seq(0.0, 1.2, 0.2)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.45, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(rowMeans(cbind(PRAD_BPRNACan3DProMet_decon$cancer, PRAD_methy_decon$cancer))), as.matrix(Facs_PRAD_modif$CPE))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.05, label = paste("RMSE =", round(sqrt(mean((as.matrix(rowMeans(cbind(PRAD_BPRNACan3DProMet_decon$cancer, PRAD_methy_decon$cancer))) - as.matrix(Facs_PRAD_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 0.9, label = paste("n = ", nrow(PRAD_BPRNACan_decon)), size = 4)


#### Lymphocytes

lymph_PRAD_BPRNACan_avr <- rowMeans(cbind(PRAD_BPRNACan_decon$B + PRAD_BPRNACan_decon$NK + PRAD_BPRNACan_decon$CD4 + PRAD_BPRNACan_decon$CD8, PRAD_methy_decon$B + PRAD_methy_decon$CD4 + PRAD_methy_decon$CD8 + PRAD_methy_decon$NK + PRAD_methy_decon$Treg))

a <- cbind(lymph_PRAD_BPRNACan_avr, HE_PRAD_modif$Lymphocytes)
colnames(a) <- c("Cancer_cell_fractions", "Lymphocytes")

Fig_PRAD_lymph_BPRNACan_avrage <- ggscatter(data.frame(a), x = "Lymphocytes", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "PRAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_PRAD_BPRNACan_avr), as.matrix(HE_PRAD_modif$Lymphocytes))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_PRAD_BPRNACan_avr) - as.matrix(HE_PRAD_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(PRAD_methy_decon)), size = 4)


lymph_PRAD_BPRNACanProMet_avr <- rowMeans(cbind(PRAD_BPRNACanProMet_decon$B + PRAD_BPRNACanProMet_decon$NK + PRAD_BPRNACanProMet_decon$CD4 + PRAD_BPRNACanProMet_decon$CD8, PRAD_methy_decon$B + PRAD_methy_decon$CD4 + PRAD_methy_decon$CD8 + PRAD_methy_decon$NK + PRAD_methy_decon$Treg))

a <- cbind(lymph_PRAD_BPRNACanProMet_avr, HE_PRAD_modif$Lymphocytes)
colnames(a) <- c("Cancer_cell_fractions", "Lymphocytes")

Fig_PRAD_lymph_BPRNACanProMet_avrage <- ggscatter(data.frame(a), x = "Lymphocytes", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "PRAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_PRAD_BPRNACanProMet_avr), as.matrix(HE_PRAD_modif$Lymphocytes))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_PRAD_BPRNACanProMet_avr) - as.matrix(HE_PRAD_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(PRAD_methy_decon)), size = 4)

lymph_PRAD_BPRNACan3DProMet_avr <- rowMeans(cbind(PRAD_BPRNACan3DProMet_decon$B + PRAD_BPRNACan3DProMet_decon$NK + PRAD_BPRNACan3DProMet_decon$CD4 + PRAD_BPRNACan3DProMet_decon$CD8, PRAD_methy_decon$B + PRAD_methy_decon$CD4 + PRAD_methy_decon$CD8 + PRAD_methy_decon$NK + PRAD_methy_decon$Treg))

a <- cbind(lymph_PRAD_BPRNACan3DProMet_avr, HE_PRAD_modif$Lymphocytes)
colnames(a) <- c("Cancer_cell_fractions", "Lymphocytes")

Fig_PRAD_lymph_BPRNACan3DProMet_avrage <- ggscatter(data.frame(a), x = "Lymphocytes", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "PRAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_PRAD_BPRNACan3DProMet_avr), as.matrix(HE_PRAD_modif$Lymphocytes))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_PRAD_BPRNACan3DProMet_avr) - as.matrix(HE_PRAD_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(PRAD_methy_decon)), size = 4)

#### Macrophages

Macro_PRAD_BPRNACan_avr <- rowMeans(cbind(PRAD_BPRNACan_decon$M0 + PRAD_BPRNACan_decon$M1 + PRAD_BPRNACan_decon$M2 + PRAD_BPRNACan_decon$Mono, PRAD_methy_decon$M0 + PRAD_methy_decon$M1 + PRAD_methy_decon$M2 + PRAD_methy_decon$Mono))

a <- cbind(Macro_PRAD_BPRNACan_avr, HE_PRAD_modif$Macrophages)
colnames(a) <- c("Cancer_cell_fractions", "Macrophages")

Fig_PRAD_Macro_BPRNACan_avrage <- ggscatter(data.frame(a), x = "Macrophages", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "PRAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_PRAD_BPRNACan_avr), as.matrix(HE_PRAD_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_PRAD_BPRNACan_avr) - as.matrix(HE_PRAD_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(PRAD_methy_decon)), size = 4)

Macro_PRAD_BPRNACanProMet_avr <- rowMeans(cbind(PRAD_BPRNACanProMet_decon$M0 + PRAD_BPRNACanProMet_decon$M1 + PRAD_BPRNACanProMet_decon$M2 + PRAD_BPRNACanProMet_decon$Mono, PRAD_methy_decon$M0 + PRAD_methy_decon$M1 + PRAD_methy_decon$M2 + PRAD_methy_decon$Mono))

a <- cbind(Macro_PRAD_BPRNACanProMet_avr, HE_PRAD_modif$Macrophages)
colnames(a) <- c("Cancer_cell_fractions", "Macrophages")

Fig_PRAD_Macro_BPRNACanProMet_avrage <- ggscatter(data.frame(a), x = "Macrophages", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "PRAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_PRAD_BPRNACanProMet_avr), as.matrix(HE_PRAD_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_PRAD_BPRNACanProMet_avr) - as.matrix(HE_PRAD_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(PRAD_methy_decon)), size = 4)


Macro_PRAD_BPRNACan3DProMet_avr <- rowMeans(cbind(PRAD_BPRNACan3DProMet_decon$M0 + PRAD_BPRNACan3DProMet_decon$M1 + PRAD_BPRNACan3DProMet_decon$M2 + PRAD_BPRNACan3DProMet_decon$Mono, PRAD_methy_decon$M0 + PRAD_methy_decon$M1 + PRAD_methy_decon$M2 + PRAD_methy_decon$Mono))

a <- cbind(Macro_PRAD_BPRNACan3DProMet_avr, HE_PRAD_modif$Macrophages)
colnames(a) <- c("Cancer_cell_fractions", "Macrophages")

Fig_PRAD_Macro_BPRNACan3DProMet_avrage <- ggscatter(data.frame(a), x = "Macrophages", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "PRAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_PRAD_BPRNACan3DProMet_avr), as.matrix(HE_PRAD_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_PRAD_BPRNACan3DProMet_avr) - as.matrix(HE_PRAD_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(PRAD_methy_decon)), size = 4)


#### Neutrophils

a <- cbind(rowMeans(cbind(PRAD_BPRNACan_decon$Neu, PRAD_methy_decon$Neu)), HE_PRAD_modif$Neutrophils)
colnames(a) <- c("Cancer_cell_fractions", "Neutrophils")

Fig_PRAD_Neu_BPRNACan_avrage <- ggscatter(data.frame(a), x = "Neutrophils", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "PRAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.4)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.012, y = 0.4, label = paste("italic(r)==", round(cor.test(as.matrix(rowMeans(cbind(PRAD_BPRNACan_decon$Neu, PRAD_methy_decon$Neu))), as.matrix(HE_PRAD_modif$Neutrophils))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(rowMeans(cbind(PRAD_BPRNACan_decon$Neu, PRAD_methy_decon$Neu))), as.matrix(HE_PRAD_modif$Neutrophils))$p.value, 9)), parse = TRUE, size = 4) + annotate("text", x = 0.008, y = 0.35, label = paste("RMSE =", round(sqrt(mean((as.matrix(rowMeans(cbind(PRAD_BPRNACan_decon$Neu, PRAD_methy_decon$Neu))) - as.matrix(HE_PRAD_modif$Neutrophils))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.0051, y = 0.3, label = paste("n = ", nrow(PRAD_methy_decon)), size = 4)

a <- cbind(rowMeans(cbind(PRAD_BPRNACanProMet_decon$Neu, PRAD_methy_decon$Neu)), HE_PRAD_modif$Neutrophils)
colnames(a) <- c("Cancer_cell_fractions", "Neutrophils")

Fig_PRAD_Neu_BPRNACanProMet_avrage <- ggscatter(data.frame(a), x = "Neutrophils", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "PRAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.4)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.012, y = 0.4, label = paste("italic(r)==", round(cor.test(as.matrix(rowMeans(cbind(PRAD_BPRNACanProMet_decon$Neu, PRAD_methy_decon$Neu))), as.matrix(HE_PRAD_modif$Neutrophils))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(rowMeans(cbind(PRAD_BPRNACanProMet_decon$Neu, PRAD_methy_decon$Neu))), as.matrix(HE_PRAD_modif$Neutrophils))$p.value, 9)), parse = TRUE, size = 4) + annotate("text", x = 0.008, y = 0.35, label = paste("RMSE =", round(sqrt(mean((as.matrix(rowMeans(cbind(PRAD_BPRNACanProMet_decon$Neu, PRAD_methy_decon$Neu))) - as.matrix(HE_PRAD_modif$Neutrophils))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.0051, y = 0.3, label = paste("n = ", nrow(PRAD_methy_decon)), size = 4)

a <- cbind(rowMeans(cbind(PRAD_BPRNACan3DProMet_decon$Neu, PRAD_methy_decon$Neu)), HE_PRAD_modif$Neutrophils)
colnames(a) <- c("Cancer_cell_fractions", "Neutrophils")

Fig_PRAD_Neu_BPRNACan3DProMet_avrage <- ggscatter(data.frame(a), x = "Neutrophils", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "PRAD") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.4)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.012, y = 0.4, label = paste("italic(r)==", round(cor.test(as.matrix(rowMeans(cbind(PRAD_BPRNACan3DProMet_decon$Neu, PRAD_methy_decon$Neu))), as.matrix(HE_PRAD_modif$Neutrophils))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(rowMeans(cbind(PRAD_BPRNACan3DProMet_decon$Neu, PRAD_methy_decon$Neu))), as.matrix(HE_PRAD_modif$Neutrophils))$p.value, 9)), parse = TRUE, size = 4) + annotate("text", x = 0.008, y = 0.35, label = paste("RMSE =", round(sqrt(mean((as.matrix(rowMeans(cbind(PRAD_BPRNACan3DProMet_decon$Neu, PRAD_methy_decon$Neu))) - as.matrix(HE_PRAD_modif$Neutrophils))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.0051, y = 0.3, label = paste("n = ", nrow(PRAD_methy_decon)), size = 4)
```

```{r}
#### BPRNACan3D

Lym_PRAD_3DRNA <- cbind(lymph_PRAD_BPRNACan3DProMet, HE_PRAD_modif$Lymphocytes)
colnames(Lym_PRAD_3DRNA) <- c("Cancer_cell_fractions", "Lymphocytes")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((lymph_PRAD_BPRNACan3DProMet - HE_PRAD_modif$Lymphocytes)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Lym_PRAD_3DRNA <- ggplot(as.data.frame(Lym_PRAD_3DRNA), aes(x = Lymphocytes, y = Cancer_cell_fractions)) +
  geom_point(colour = c("darkslategrey")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"BPRNACan3D") +
  scale_x_continuous(name = NULL, limits = c(0, max(Lym_PRAD_3DRNA))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Lym_PRAD_3DRNA))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)

Macro_PRAD_3DRNA <- cbind(Macro_PRAD_BPRNACan3DProMet, HE_PRAD_modif$Macrophages)
colnames(Macro_PRAD_3DRNA) <- c("Cancer_cell_fractions", "Macrophages")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((Macro_PRAD_BPRNACan3DProMet - HE_PRAD_modif$Macrophages)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Macro_PRAD_3DRNA <- ggplot(as.data.frame(Macro_PRAD_3DRNA), aes(x = Macrophages, y = Cancer_cell_fractions)) +
  geom_point(colour = c("coral")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"BPRNACan3D") +
  scale_x_continuous(name = NULL, limits = c(0, max(Macro_PRAD_3DRNA))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Macro_PRAD_3DRNA))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)


Neu_PRAD_3DRNA <- cbind(PRAD_BPRNACan3DProMet_decon$Neu, HE_PRAD_modif$Neutrophils)
colnames(Neu_PRAD_3DRNA) <- c("Cancer_cell_fractions", "Neutrophils")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((PRAD_BPRNACan3DProMet_decon$Neu - HE_PRAD_modif$Neutrophils)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Neu_PRAD_3DRNA <- ggplot(as.data.frame(Neu_PRAD_3DRNA), aes(x = Neutrophils, y = Cancer_cell_fractions)) +
  geom_point(colour = c("green")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"BPRNACan3D") +
  scale_x_continuous(name = NULL, limits = c(0, max(Neu_PRAD_3DRNA))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Neu_PRAD_3DRNA))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)


#### BPmetCan

#### lympho

Lym_PRAD_methy <- cbind(lymph_methy, HE_PRAD_modif$Lymphocytes)
colnames(Lym_PRAD_methy) <- c("Cancer_cell_fractions", "Lymphocytes")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((Lym_PRAD_methy - HE_PRAD_modif$Lymphocytes)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Lym_PRAD_BPmetCan <- ggplot(as.data.frame(Lym_PRAD_methy), aes(x = Lymphocytes, y = Cancer_cell_fractions)) +
  geom_point(colour = c("darkslategrey")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"BPmetCan") +
  scale_x_continuous(name = NULL, limits = c(0, max(Lym_PRAD_methy))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Lym_PRAD_methy))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)

#### Macro

Macro_Methy <- PRAD_methy_decon$M0 + PRAD_methy_decon$M1 + PRAD_methy_decon$M2 + PRAD_methy_decon$Mono

Macro_PRAD_methy <- cbind(Macro_Methy, HE_PRAD_modif$Macrophages)
colnames(Macro_PRAD_methy) <- c("Cancer_cell_fractions", "Macrophages")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((Macro_PRAD_methy - HE_PRAD_modif$Macrophages)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Macro_PRAD_BPmetCan <- ggplot(as.data.frame(Macro_PRAD_methy), aes(x = Macrophages, y = Cancer_cell_fractions)) +
  geom_point(colour = c("coral")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"BPmetCan") +
  scale_x_continuous(name = NULL, limits = c(0, max(Macro_Methy))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Macro_Methy))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)


#### Neu

Neu_PRAD_methy <- cbind(PRAD_methy_decon$Neu, HE_PRAD_modif$Neutrophils)
colnames(Neu_PRAD_methy) <- c("Cancer_cell_fractions", "Neutrophils")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((PRAD_methy_decon$Neu - HE_PRAD_modif$Neutrophils)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Neu_PRAD_BPmetCan <- ggplot(as.data.frame(Neu_PRAD_methy), aes(x = Neutrophils, y = Cancer_cell_fractions)) +
  geom_point(colour = c("green")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"BPmetCan") + 
  scale_x_continuous(name = NULL, limits = c(0, max(Neu_PRAD_methy))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Neu_PRAD_methy))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)



#### avrg

Lym_PRAD_avrg <- cbind(lymph_PRAD_BPRNACan_avr, HE_PRAD_modif$Lymphocytes)
colnames(Lym_PRAD_avrg) <- c("Cancer_cell_fractions", "Lymphocytes")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((lymph_PRAD_BPRNACan_avr - HE_PRAD_modif$Lymphocytes)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Lym_PRAD_avrg <- ggplot(as.data.frame(Lym_PRAD_avrg), aes(x = Lymphocytes, y = Cancer_cell_fractions)) +
  geom_point(colour = c("darkslategrey")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"Meth + RNA") + 
  scale_x_continuous(name = NULL, limits = c(0, max(Lym_PRAD_avrg))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Lym_PRAD_avrg))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)


Macro_PRAD_avrg <- cbind(Macro_PRAD_BPRNACan_avr, HE_PRAD_modif$Macrophages)
colnames(Macro_PRAD_avrg) <- c("Cancer_cell_fractions", "Macrophages")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((Macro_PRAD_BPRNACan_avr - HE_PRAD_modif$Macrophages)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Macro_PRAD_avrg <- ggplot(as.data.frame(Macro_PRAD_avrg), aes(x = Macrophages, y = Cancer_cell_fractions)) +
  geom_point(colour = c("coral")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"Meth + RNA") +
  scale_x_continuous(name = NULL, limits = c(0, max(Macro_PRAD_avrg))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Macro_PRAD_avrg))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)

Neu_PRAD_avrg <- cbind(rowMeans(cbind(PRAD_BPRNACan_decon$Neu, PRAD_methy_decon$Neu)), HE_PRAD_modif$Neutrophils)
colnames(Neu_PRAD_avrg) <- c("Cancer_cell_fractions", "Neutrophils")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean(rowMeans(cbind(PRAD_BPRNACan_decon$Neu, PRAD_methy_decon$Neu) - HE_PRAD_modif$Neutrophils)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Neu_PRAD_avrg <- ggplot(as.data.frame(Neu_PRAD_avrg), aes(x = Neutrophils, y = Cancer_cell_fractions)) +
  geom_point(colour = c("green")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"Meth + RNA") + 
  scale_x_continuous(name = NULL, limits = c(0, max(Neu_PRAD_avrg))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Neu_PRAD_avrg))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)



lymph = ggarrange(fig_Lym_PRAD_3DRNA, fig_Lym_PRAD_BPmetCan, fig_Lym_PRAD_avrg, ncol = 3, nrow = 1, labels = "a", font.label = list(size = 20, color = "black"), align = "hv")
neutro = ggarrange(fig_Neu_PRAD_3DRNA, fig_Neu_PRAD_BPmetCan, fig_Neu_PRAD_avrg, ncol = 3, nrow = 1, labels = "b", font.label = list(size = 20, color = "black"), align = "hv")
macro = ggarrange(fig_Macro_PRAD_3DRNA, fig_Macro_PRAD_BPmetCan, fig_Macro_PRAD_avrg, ncol = 3, nrow = 1, labels = "c", font.label = list(size = 20, color = "black"), align = "hv")


All_PRAD <- ggarrange(lymph, neutro, macro, ncol = 1, nrow = 3, font.label = list(size = 20, color = "black"), align = "hv")


All_PRAD <- annotate_figure(All_PRAD,
  left = text_grob("Estimated fractions", color = "black", size = 20, rot = 90),
  bottom = text_grob("H&E estimates", color = "black", size = 20)
  
)

All_PRAD
```
RNA, methylation, and averaged values of correlation across a : lymphocytes, b: neutrophils, c : macrophages, using the BPRNACan3D and BPMetCan signatures on EpiDish.


## BRCA

```{r}

BRCA_methy_decon <- read.table("/mnt/SERVER-CRCT-STORAGE/CRCT21/Private/Julien/gemdecan/data/meth/BRCA.txt", sep = "\t", header = T)

Facs_BRCA <- Aran_all_facs[Aran_all_facs$Cancer_type == "BRCA", ]

HE_BRCA <- HE_all_TCGA[HE_all_TCGA$Study == "BRCA", ]

Facs_BRCA_modif <- Facs_BRCA[Facs_BRCA$CPE != "NaN", ]

Comm_samples <- Reduce(intersect, list(HE_BRCA$ParticipantBarcode, Facs_BRCA_modif$Sample_ID, tcga_deconv$Samples, rownames(BRCA_methy_decon)))

Facs_BRCA_modif <- Facs_BRCA_modif %>% .[.$Sample_ID %in% Comm_samples, ]

HE_BRCA_modif <- HE_BRCA %>%
  .[.$ParticipantBarcode %in% Comm_samples, ] %>%
  .[order(.$ParticipantBarcode), ]

BRCA_methy_decon <- BRCA_methy_decon[Comm_samples, ] %>% 
  rownames_to_column() 
BRCA_methy_decon <- BRCA_methy_decon[order(BRCA_methy_decon$rowname), ]
rownames(BRCA_methy_decon) <- BRCA_methy_decon$rowname
BRCA_methy_decon <- BRCA_methy_decon[,-1]

BRCA_RNA_decon <- tcga_deconv %>% filter(Samples %in% Comm_samples)

###################################
##### Estimating Tumor Purity #####
###################################


BRCA_BPRNACan_decon <- BRCA_RNA_decon %>% select(colnames(BRCA_RNA_decon)[grepl("Epidish_BPRNACan_", colnames(BRCA_RNA_decon))])
colnames(BRCA_BPRNACan_decon) <- colnames(BRCA_BPRNACan_decon) %>% str_remove_all("Epidish_BPRNACan_")

a <- cbind(BRCA_BPRNACan_decon$cancer, Facs_BRCA_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_BRCA_BPRNACan <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BRCA") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0.8, 1.2), breaks = seq(0.0, 1.2, 0.1)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.42, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(BRCA_BPRNACan_decon$cancer), as.matrix(Facs_BRCA_modif$CPE))$est, 2), "~','", "~italic(P)<", round(cor.test(as.matrix(BRCA_BPRNACan_decon$cancer), as.matrix(Facs_BRCA_modif$CPE))$p.value, 14)), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.15, label = paste("RMSE =", round(sqrt(mean((as.matrix(BRCA_BPRNACan_decon$cancer) - as.matrix(Facs_BRCA_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 1.1, label = paste("n = ", nrow(BRCA_BPRNACan_decon)), size = 4)


BRCA_BPRNACanProMet_decon <- BRCA_RNA_decon %>% select(colnames(BRCA_RNA_decon)[grepl("Epidish_BPRNACanProMet_", colnames(BRCA_RNA_decon))])
colnames(BRCA_BPRNACanProMet_decon) <- colnames(BRCA_BPRNACanProMet_decon) %>% str_remove_all("Epidish_BPRNACanProMet_")

a <- cbind(BRCA_BPRNACanProMet_decon$cancer, Facs_BRCA_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_BRCA_BPRNACanProMet <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BRCA") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0.8, 1.2), breaks = seq(0.0, 1.2, 0.1)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.45, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(BRCA_BPRNACanProMet_decon$cancer), as.matrix(Facs_BRCA_modif$CPE))$est, 2), "~','", "~italic(P)<", round(cor.test(as.matrix(BRCA_BPRNACanProMet_decon$cancer), as.matrix(Facs_BRCA_modif$CPE))$p.value, 14)), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.15, label = paste("RMSE =", round(sqrt(mean((as.matrix(BRCA_BPRNACanProMet_decon$cancer) - as.matrix(Facs_BRCA_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 1.1, label = paste("n = ", nrow(BRCA_BPRNACanProMet_decon)), size = 4)


BRCA_BPRNACan3DProMet_decon <- BRCA_RNA_decon %>% select(colnames(BRCA_RNA_decon)[grepl("Epidish_BPRNACan3DProMet_", colnames(BRCA_RNA_decon))])
colnames(BRCA_BPRNACan3DProMet_decon) <- colnames(BRCA_BPRNACan3DProMet_decon) %>% str_remove_all("Epidish_BPRNACan3DProMet_")


a <- cbind(BRCA_BPRNACan3DProMet_decon$cancer, Facs_BRCA_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_BRCA_BPRNACan3DProMet <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BRCA") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0.8, 1.2), breaks = seq(0.0, 1.2, 0.1)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.52, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(BRCA_BPRNACan3DProMet_decon$cancer), as.matrix(Facs_BRCA_modif$CPE))$est, 2), "~','", "~italic(P)<", round(cor.test(as.matrix(BRCA_BPRNACan3DProMet_decon$cancer), as.matrix(Facs_BRCA_modif$CPE))$p.value, 14)), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.15, label = paste("RMSE =", round(sqrt(mean((as.matrix(BRCA_BPRNACan3DProMet_decon$cancer) - as.matrix(Facs_BRCA_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 1.1, label = paste("n = ", nrow(BRCA_BPRNACan3DProMet_decon)), size = 4)

###### Methylation part

a <- cbind(BRCA_methy_decon$cancer, Facs_BRCA_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_BRCA_BPmetCan <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BRCA") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0, 1.2), breaks = seq(0.0, 1.2, 0.2)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.45, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(BRCA_methy_decon$cancer), as.matrix(Facs_BRCA_modif$CPE))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.05, label = paste("RMSE =", round(sqrt(mean((as.matrix(BRCA_methy_decon$cancer) - as.matrix(Facs_BRCA_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 0.9, label = paste("n = ", nrow(BRCA_methy_decon)), size = 4)


###############################################################
##### Estimating Lymphocytes, Macrophages and Neutrophils #####
###############################################################

##### RNA expression Part #####

#### lymph

lymph_BRCA_BPRNACan <- BRCA_BPRNACan_decon$B + BRCA_BPRNACan_decon$CD4 + BRCA_BPRNACan_decon$CD8 + BRCA_BPRNACan_decon$NK

a <- cbind(lymph_BRCA_BPRNACan, HE_BRCA_modif$Lymphocytes)
colnames(a) <- c("lymph_fractions", "HE")

Fig_BRCA_lymph_BPRNACan <- ggscatter(data.frame(a), x = "HE", y = "lymph_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BRCA") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.08)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.235, y = 0.08, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_BRCA_BPRNACan), as.matrix(HE_BRCA_modif$Lymphocytes))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.07, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_BRCA_BPRNACan) - as.matrix(HE_BRCA_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.06, label = paste("n = ", nrow(BRCA_methy_decon)), size = 4)



lymph_BRCA_BPRNACanProMet <- BRCA_BPRNACanProMet_decon$B + BRCA_BPRNACanProMet_decon$CD4 + BRCA_BPRNACanProMet_decon$CD8 + BRCA_BPRNACanProMet_decon$NK

a <- cbind(lymph_BRCA_BPRNACanProMet, HE_BRCA_modif$Lymphocytes)
colnames(a) <- c("lymph_fractions", "HE")

Fig_BRCA_lymph_BPRNACanProMet <- ggscatter(data.frame(a), x = "HE", y = "lymph_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BRCA") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.08)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.235, y = 0.08, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_BRCA_BPRNACanProMet), as.matrix(HE_BRCA_modif$Lymphocytes))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(lymph_BRCA_BPRNACanProMet), as.matrix(HE_BRCA_modif$Lymphocytes))$p.value, 13)), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.07, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_BRCA_BPRNACanProMet) - as.matrix(HE_BRCA_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.06, label = paste("n = ", nrow(BRCA_BPRNACanProMet_decon)), size = 4)


lymph_BRCA_BPRNACan3DProMet <- BRCA_BPRNACan3DProMet_decon$B + BRCA_BPRNACan3DProMet_decon$CD4 + BRCA_BPRNACan3DProMet_decon$CD8 + BRCA_BPRNACan3DProMet_decon$NK

a <- cbind(lymph_BRCA_BPRNACan3DProMet, HE_BRCA_modif$Lymphocytes)
colnames(a) <- c("lymph_fractions", "HE")

Fig_BRCA_lymph_BPRNACan3DProMet <- ggscatter(data.frame(a), x = "HE", y = "lymph_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BRCA") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.08)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.235, y = 0.08, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_BRCA_BPRNACan3DProMet), as.matrix(HE_BRCA_modif$Lymphocytes))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(lymph_BRCA_BPRNACan3DProMet), as.matrix(HE_BRCA_modif$Lymphocytes))$p.value, 13)), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.07, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_BRCA_BPRNACan3DProMet) - as.matrix(HE_BRCA_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.06, label = paste("n = ", nrow(BRCA_BPRNACanProMet_decon)), size = 4)


#### Macro

Macro_BRCA_BPRNACan <- BRCA_BPRNACan_decon$M0 + BRCA_BPRNACan_decon$M1 + BRCA_BPRNACan_decon$M2 + BRCA_BPRNACan_decon$Mono

a <- cbind(Macro_BRCA_BPRNACan, HE_BRCA_modif$Macrophages)
colnames(a) <- c("Macro_fractions", "HE")

Fig_BRCA_Macro_BPRNACan <- ggscatter(data.frame(a), x = "HE", y = "Macro_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BRCA") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.4)) + scale_y_continuous(name = NULL, limits = c(0, 0.06)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.175, y = 0.06, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_BRCA_BPRNACan), as.matrix(HE_BRCA_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.11, y = 0.0526, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_BRCA_BPRNACan) - as.matrix(HE_BRCA_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.08, y = 0.045, label = paste("n = ", nrow(BRCA_BPRNACan_decon)), size = 4)



Macro_BRCA_BPRNACanProMet <- BRCA_BPRNACanProMet_decon$M0 + BRCA_BPRNACanProMet_decon$M1 + BRCA_BPRNACanProMet_decon$M2 + BRCA_BPRNACanProMet_decon$Mono

a <- cbind(Macro_BRCA_BPRNACanProMet, HE_BRCA_modif$Macrophages)
colnames(a) <- c("Macro_fractions", "HE")

Fig_BRCA_Macro_BPRNACanProMet <- ggscatter(data.frame(a), x = "HE", y = "Macro_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BRCA") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.4)) + scale_y_continuous(name = NULL, limits = c(0, 0.06)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.185, y = 0.06, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_BRCA_BPRNACanProMet), as.matrix(HE_BRCA_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.11, y = 0.0526, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_BRCA_BPRNACanProMet) - as.matrix(HE_BRCA_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.08, y = 0.045, label = paste("n = ", nrow(BRCA_BPRNACan_decon)), size = 4)

Macro_BRCA_BPRNACan3DProMet <- BRCA_BPRNACan3DProMet_decon$M0 + BRCA_BPRNACan3DProMet_decon$M1 + BRCA_BPRNACan3DProMet_decon$M2 + BRCA_BPRNACan3DProMet_decon$Mono

a <- cbind(Macro_BRCA_BPRNACan3DProMet, HE_BRCA_modif$Macrophages)
colnames(a) <- c("Macro_fractions", "HE")

Fig_BRCA_Macro_BPRNACan3DProMet <- ggscatter(data.frame(a), x = "HE", y = "Macro_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BRCA") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.4)) + scale_y_continuous(name = NULL, limits = c(0, 0.06)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.185, y = 0.06, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_BRCA_BPRNACan3DProMet), as.matrix(HE_BRCA_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.11, y = 0.0526, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_BRCA_BPRNACan3DProMet) - as.matrix(HE_BRCA_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.08, y = 0.045, label = paste("n = ", nrow(BRCA_BPRNACan_decon)), size = 4)

#### Neutrophis

a <- cbind(BRCA_BPRNACan_decon$Neu, HE_BRCA_modif$Neutrophils)
colnames(a) <- c("Neu_fractions", "HE")

Fig_BRCA_Neu_BPRNACan <- ggscatter(data.frame(a), x = "HE", y = "Neu_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BRCA") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.006)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.015, y = 0.006, label = paste("italic(r)==", round(cor.test(as.matrix(BRCA_BPRNACan_decon$Neu), as.matrix(HE_BRCA_modif$Neutrophils))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.009, y = 0.00525, label = paste("RMSE =", round(sqrt(mean((as.matrix(BRCA_BPRNACan_decon$Neu) - as.matrix(HE_BRCA_modif$Neutrophils))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.0065, y = 0.0046, label = paste("n = ", nrow(BRCA_BPRNACan_decon)), size = 4)


a <- cbind(BRCA_BPRNACanProMet_decon$Neu, HE_BRCA_modif$Neutrophils)
colnames(a) <- c("Neu_fractions", "HE")

Fig_BRCA_Neu_BPRNACanProMet <- ggscatter(data.frame(a[-155, ]), x = "HE", y = "Neu_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BRCA") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.006)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.015, y = 0.006, label = paste("italic(r)==", round(cor.test(as.matrix(BRCA_BPRNACanProMet_decon$Neu), as.matrix(HE_BRCA_modif$Neutrophils))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.0105, y = 0.00525, label = paste("RMSE =", round(sqrt(mean((as.matrix(BRCA_BPRNACanProMet_decon$Neu) - as.matrix(HE_BRCA_modif$Neutrophils))^2, na.rm = T)), 5)), parse = F, size = 4) + annotate("text", x = 0.0065, y = 0.0046, label = paste("n = ", nrow(BRCA_BPRNACan_decon)), size = 4)


a <- cbind(BRCA_BPRNACan3DProMet_decon$Neu, HE_BRCA_modif$Neutrophils)
colnames(a) <- c("Neu_fractions", "HE")

Fig_BRCA_Neu_BPRNACan3DProMet <- ggscatter(data.frame(a), x = "HE", y = "Neu_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BRCA") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.008)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.015, y = 0.008, label = paste("italic(r)==", round(cor.test(as.matrix(BRCA_BPRNACan3DProMet_decon$Neu), as.matrix(HE_BRCA_modif$Neutrophils))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(BRCA_BPRNACan3DProMet_decon$Neu), as.matrix(HE_BRCA_modif$Neutrophils))$p.value, 15)), parse = TRUE, size = 4) + annotate("text", x = 0.0105, y = 0.007, label = paste("RMSE =", round(sqrt(mean((as.matrix(BRCA_BPRNACan3DProMet_decon$Neu) - as.matrix(HE_BRCA_modif$Neutrophils))^2, na.rm = T)), 3)), parse = F, size = 4) + annotate("text", x = 0.0065, y = 0.006, label = paste("n = ", nrow(BRCA_BPRNACan_decon)), size = 4)

##### DNA methylation Part #####

#### lympho

lymph_methy <- BRCA_methy_decon$B + BRCA_methy_decon$CD4 + BRCA_methy_decon$CD8 + BRCA_methy_decon$Treg + BRCA_methy_decon$NK

a <- cbind(lymph_methy, HE_BRCA_modif$Lymphocytes)
colnames(a) <- c("lymph_methy", "HE_lympho")

Fig_BRCA_lymph_BPmetCan <- ggscatter(data.frame(a), x = "HE_lympho", y = "lymph_methy", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BRCA") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_methy), as.matrix(HE_BRCA_modif$Lymphocytes))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_methy) - as.matrix(HE_BRCA_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(BRCA_methy_decon)), size = 4)


#### Macro

Macro_Methy <- BRCA_methy_decon$M0 + BRCA_methy_decon$M1 + BRCA_methy_decon$M2 + BRCA_methy_decon$Mono

a <- cbind(Macro_Methy, HE_BRCA_modif$Macrophages)
colnames(a) <- c("Macro_Methy", "HE_macro")

Fig_BRCA_Macro_BPmetCan <- ggscatter(data.frame(a), x = "HE_macro", y = "Macro_Methy", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BRCA") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_Methy), as.matrix(HE_BRCA_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_Methy) - as.matrix(HE_BRCA_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(BRCA_methy_decon)), size = 4)

#### Neu

a <- cbind(BRCA_methy_decon$Neu, HE_BRCA_modif$Neutrophils)
colnames(a) <- c("Neu_Methy", "HE_neu")

Fig_BRCA_Neu_BPmetCan <- ggscatter(data.frame(a), x = "HE_neu", y = "Neu_Methy", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BRCA") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.8)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.0135, y = 0.8, label = paste("italic(r)==", round(cor.test(as.matrix(BRCA_methy_decon$Neu), as.matrix(HE_BRCA_modif$Neutrophils))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(BRCA_methy_decon$Neu), as.matrix(HE_BRCA_modif$Neutrophils))$p.value, 10)), parse = TRUE, size = 4) + annotate("text", x = 0.0085, y = 0.7, label = paste("RMSE =", round(sqrt(mean((as.matrix(BRCA_methy_decon$Neu) - as.matrix(HE_BRCA_modif$Neutrophils))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.0057, y = 0.6, label = paste("n = ", nrow(BRCA_methy_decon)), size = 4)


##### Correlation between DNA methylation and expression deconvolution #####

## Tumor purity

a <- cbind(BRCA_BPRNACan_decon$cancer, BRCA_methy_decon$cancer)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_BRCA_TM_BPRNACan_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BRCA") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL, limits = c(0, 1)) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", label.x = 0, label.y = 1, size = 6)

a <- cbind(BRCA_BPRNACanProMet_decon$cancer, BRCA_methy_decon$cancer)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_BRCA_TM_BPRNACanProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BRCA") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL, limits = c(0, 1)) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", label.x = 0, label.y = 1, size = 6)

a <- cbind(BRCA_BPRNACan3DProMet_decon$cancer, BRCA_methy_decon$cancer)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_BRCA_TM_BPRNACan3DProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BRCA") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL, limits = c(0, 1)) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", label.x = 0, label.y = 1, size = 6)


## Lymphcytes

a <- cbind(lymph_BRCA_BPRNACan, lymph_methy)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_BRCA_lymph_BPRNACan_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "BRCA") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")

a <- cbind(lymph_BRCA_BPRNACanProMet, lymph_methy)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_BRCA_lymph_BPRNACanProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "BRCA") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")

a <- cbind(lymph_BRCA_BPRNACan3DProMet, lymph_methy)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_BRCA_lymph_BPRNACan3DProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "BRCA") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")


## Macrophages

a <- cbind(Macro_BRCA_BPRNACan, Macro_Methy)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_BRCA_macro_BPRNACan_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "BRCA") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")


a <- cbind(Macro_BRCA_BPRNACanProMet, Macro_Methy)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_BRCA_macro_BPRNACanProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "BRCA") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")

a <- cbind(Macro_BRCA_BPRNACan3DProMet, Macro_Methy)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_BRCA_macro_BPRNACan3DProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "BRCA") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")


## Netrophils

a <- cbind(BRCA_BPRNACan_decon$Neu, BRCA_methy_decon$Neu)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_BRCA_Neu_BPRNACan_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "BRCA") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")


a <- cbind(BRCA_BPRNACanProMet_decon$Neu, BRCA_methy_decon$Neu)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_BRCA_Neu_BPRNACanProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "BRCA") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")

a <- cbind(BRCA_BPRNACan3DProMet_decon$Neu, BRCA_methy_decon$Neu)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_BRCA_Neu_BPRNACan3DProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "BRCA") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")



###############################################
###### average of Methylation and RNAseq ######
###############################################

#### Tumor purity

a <- cbind(rowMeans(cbind(BRCA_BPRNACan_decon$cancer, BRCA_methy_decon$cancer)), Facs_BRCA_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_BRCA_BPRNACan_avrage <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BRCA") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0, 1.2), breaks = seq(0.0, 1.2, 0.2)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.45, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(rowMeans(cbind(BRCA_BPRNACan_decon$cancer, BRCA_methy_decon$cancer))), as.matrix(Facs_BRCA_modif$CPE))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.05, label = paste("RMSE =", round(sqrt(mean((as.matrix(rowMeans(cbind(BRCA_BPRNACan_decon$cancer, BRCA_methy_decon$cancer))) - as.matrix(Facs_BRCA_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 0.9, label = paste("n = ", nrow(BRCA_BPRNACan_decon)), size = 4)


a <- cbind(rowMeans(cbind(BRCA_BPRNACanProMet_decon$cancer, BRCA_methy_decon$cancer)), Facs_BRCA_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_BRCA_BPRNACanProMet_avrage <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BRCA") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0, 1.2), breaks = seq(0.0, 1.2, 0.2)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.45, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(rowMeans(cbind(BRCA_BPRNACanProMet_decon$cancer, BRCA_methy_decon$cancer))), as.matrix(Facs_BRCA_modif$CPE))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.05, label = paste("RMSE =", round(sqrt(mean((as.matrix(rowMeans(cbind(BRCA_BPRNACanProMet_decon$cancer, BRCA_methy_decon$cancer))) - as.matrix(Facs_BRCA_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 0.9, label = paste("n = ", nrow(BRCA_BPRNACan_decon)), size = 4)


a <- cbind(rowMeans(cbind(BRCA_BPRNACan3DProMet_decon$cancer, BRCA_methy_decon$cancer)), Facs_BRCA_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_BRCA_BPRNACan3DProMet_avrage <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BRCA") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0, 1.2), breaks = seq(0.0, 1.2, 0.2)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.45, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(rowMeans(cbind(BRCA_BPRNACan3DProMet_decon$cancer, BRCA_methy_decon$cancer))), as.matrix(Facs_BRCA_modif$CPE))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.05, label = paste("RMSE =", round(sqrt(mean((as.matrix(rowMeans(cbind(BRCA_BPRNACan3DProMet_decon$cancer, BRCA_methy_decon$cancer))) - as.matrix(Facs_BRCA_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 0.9, label = paste("n = ", nrow(BRCA_BPRNACan_decon)), size = 4)


#### Lymphocytes

lymph_BRCA_BPRNACan_avr <- rowMeans(cbind(BRCA_BPRNACan_decon$B + BRCA_BPRNACan_decon$NK + BRCA_BPRNACan_decon$CD4 + BRCA_BPRNACan_decon$CD8, BRCA_methy_decon$B + BRCA_methy_decon$CD4 + BRCA_methy_decon$CD8 + BRCA_methy_decon$NK + BRCA_methy_decon$Treg))

a <- cbind(lymph_BRCA_BPRNACan_avr, HE_BRCA_modif$Lymphocytes)
colnames(a) <- c("Cancer_cell_fractions", "Lymphocytes")

Fig_BRCA_lymph_BPRNACan_avrage <- ggscatter(data.frame(a), x = "Lymphocytes", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BRCA") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_BRCA_BPRNACan_avr), as.matrix(HE_BRCA_modif$Lymphocytes))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_BRCA_BPRNACan_avr) - as.matrix(HE_BRCA_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(BRCA_methy_decon)), size = 4)


lymph_BRCA_BPRNACanProMet_avr <- rowMeans(cbind(BRCA_BPRNACanProMet_decon$B + BRCA_BPRNACanProMet_decon$NK + BRCA_BPRNACanProMet_decon$CD4 + BRCA_BPRNACanProMet_decon$CD8, BRCA_methy_decon$B + BRCA_methy_decon$CD4 + BRCA_methy_decon$CD8 + BRCA_methy_decon$NK + BRCA_methy_decon$Treg))

a <- cbind(lymph_BRCA_BPRNACanProMet_avr, HE_BRCA_modif$Lymphocytes)
colnames(a) <- c("Cancer_cell_fractions", "Lymphocytes")

Fig_BRCA_lymph_BPRNACanProMet_avrage <- ggscatter(data.frame(a), x = "Lymphocytes", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BRCA") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_BRCA_BPRNACanProMet_avr), as.matrix(HE_BRCA_modif$Lymphocytes))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_BRCA_BPRNACanProMet_avr) - as.matrix(HE_BRCA_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(BRCA_methy_decon)), size = 4)

lymph_BRCA_BPRNACan3DProMet_avr <- rowMeans(cbind(BRCA_BPRNACan3DProMet_decon$B + BRCA_BPRNACan3DProMet_decon$NK + BRCA_BPRNACan3DProMet_decon$CD4 + BRCA_BPRNACan3DProMet_decon$CD8, BRCA_methy_decon$B + BRCA_methy_decon$CD4 + BRCA_methy_decon$CD8 + BRCA_methy_decon$NK + BRCA_methy_decon$Treg))

a <- cbind(lymph_BRCA_BPRNACan3DProMet_avr, HE_BRCA_modif$Lymphocytes)
colnames(a) <- c("Cancer_cell_fractions", "Lymphocytes")

Fig_BRCA_lymph_BPRNACan3DProMet_avrage <- ggscatter(data.frame(a), x = "Lymphocytes", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BRCA") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_BRCA_BPRNACan3DProMet_avr), as.matrix(HE_BRCA_modif$Lymphocytes))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_BRCA_BPRNACan3DProMet_avr) - as.matrix(HE_BRCA_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(BRCA_methy_decon)), size = 4)

#### Macrophages

Macro_BRCA_BPRNACan_avr <- rowMeans(cbind(BRCA_BPRNACan_decon$M0 + BRCA_BPRNACan_decon$M1 + BRCA_BPRNACan_decon$M2 + BRCA_BPRNACan_decon$Mono, BRCA_methy_decon$M0 + BRCA_methy_decon$M1 + BRCA_methy_decon$M2 + BRCA_methy_decon$Mono))

a <- cbind(Macro_BRCA_BPRNACan_avr, HE_BRCA_modif$Macrophages)
colnames(a) <- c("Cancer_cell_fractions", "Macrophages")

Fig_BRCA_Macro_BPRNACan_avrage <- ggscatter(data.frame(a), x = "Macrophages", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BRCA") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_BRCA_BPRNACan_avr), as.matrix(HE_BRCA_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_BRCA_BPRNACan_avr) - as.matrix(HE_BRCA_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(BRCA_methy_decon)), size = 4)

Macro_BRCA_BPRNACanProMet_avr <- rowMeans(cbind(BRCA_BPRNACanProMet_decon$M0 + BRCA_BPRNACanProMet_decon$M1 + BRCA_BPRNACanProMet_decon$M2 + BRCA_BPRNACanProMet_decon$Mono, BRCA_methy_decon$M0 + BRCA_methy_decon$M1 + BRCA_methy_decon$M2 + BRCA_methy_decon$Mono))

a <- cbind(Macro_BRCA_BPRNACanProMet_avr, HE_BRCA_modif$Macrophages)
colnames(a) <- c("Cancer_cell_fractions", "Macrophages")

Fig_BRCA_Macro_BPRNACanProMet_avrage <- ggscatter(data.frame(a), x = "Macrophages", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BRCA") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_BRCA_BPRNACanProMet_avr), as.matrix(HE_BRCA_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_BRCA_BPRNACanProMet_avr) - as.matrix(HE_BRCA_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(BRCA_methy_decon)), size = 4)


Macro_BRCA_BPRNACan3DProMet_avr <- rowMeans(cbind(BRCA_BPRNACan3DProMet_decon$M0 + BRCA_BPRNACan3DProMet_decon$M1 + BRCA_BPRNACan3DProMet_decon$M2 + BRCA_BPRNACan3DProMet_decon$Mono, BRCA_methy_decon$M0 + BRCA_methy_decon$M1 + BRCA_methy_decon$M2 + BRCA_methy_decon$Mono))

a <- cbind(Macro_BRCA_BPRNACan3DProMet_avr, HE_BRCA_modif$Macrophages)
colnames(a) <- c("Cancer_cell_fractions", "Macrophages")

Fig_BRCA_Macro_BPRNACan3DProMet_avrage <- ggscatter(data.frame(a), x = "Macrophages", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BRCA") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_BRCA_BPRNACan3DProMet_avr), as.matrix(HE_BRCA_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_BRCA_BPRNACan3DProMet_avr) - as.matrix(HE_BRCA_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(BRCA_methy_decon)), size = 4)


#### Neutrophils

a <- cbind(rowMeans(cbind(BRCA_BPRNACan_decon$Neu, BRCA_methy_decon$Neu)), HE_BRCA_modif$Neutrophils)
colnames(a) <- c("Cancer_cell_fractions", "Neutrophils")

Fig_BRCA_Neu_BPRNACan_avrage <- ggscatter(data.frame(a), x = "Neutrophils", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BRCA") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.4)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.012, y = 0.4, label = paste("italic(r)==", round(cor.test(as.matrix(rowMeans(cbind(BRCA_BPRNACan_decon$Neu, BRCA_methy_decon$Neu))), as.matrix(HE_BRCA_modif$Neutrophils))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(rowMeans(cbind(BRCA_BPRNACan_decon$Neu, BRCA_methy_decon$Neu))), as.matrix(HE_BRCA_modif$Neutrophils))$p.value, 9)), parse = TRUE, size = 4) + annotate("text", x = 0.008, y = 0.35, label = paste("RMSE =", round(sqrt(mean((as.matrix(rowMeans(cbind(BRCA_BPRNACan_decon$Neu, BRCA_methy_decon$Neu))) - as.matrix(HE_BRCA_modif$Neutrophils))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.0051, y = 0.3, label = paste("n = ", nrow(BRCA_methy_decon)), size = 4)

a <- cbind(rowMeans(cbind(BRCA_BPRNACanProMet_decon$Neu, BRCA_methy_decon$Neu)), HE_BRCA_modif$Neutrophils)
colnames(a) <- c("Cancer_cell_fractions", "Neutrophils")

Fig_BRCA_Neu_BPRNACanProMet_avrage <- ggscatter(data.frame(a), x = "Neutrophils", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BRCA") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.4)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.012, y = 0.4, label = paste("italic(r)==", round(cor.test(as.matrix(rowMeans(cbind(BRCA_BPRNACanProMet_decon$Neu, BRCA_methy_decon$Neu))), as.matrix(HE_BRCA_modif$Neutrophils))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(rowMeans(cbind(BRCA_BPRNACanProMet_decon$Neu, BRCA_methy_decon$Neu))), as.matrix(HE_BRCA_modif$Neutrophils))$p.value, 9)), parse = TRUE, size = 4) + annotate("text", x = 0.008, y = 0.35, label = paste("RMSE =", round(sqrt(mean((as.matrix(rowMeans(cbind(BRCA_BPRNACanProMet_decon$Neu, BRCA_methy_decon$Neu))) - as.matrix(HE_BRCA_modif$Neutrophils))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.0051, y = 0.3, label = paste("n = ", nrow(BRCA_methy_decon)), size = 4)

a <- cbind(rowMeans(cbind(BRCA_BPRNACan3DProMet_decon$Neu, BRCA_methy_decon$Neu)), HE_BRCA_modif$Neutrophils)
colnames(a) <- c("Cancer_cell_fractions", "Neutrophils")

Fig_BRCA_Neu_BPRNACan3DProMet_avrage <- ggscatter(data.frame(a), x = "Neutrophils", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BRCA") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.4)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.012, y = 0.4, label = paste("italic(r)==", round(cor.test(as.matrix(rowMeans(cbind(BRCA_BPRNACan3DProMet_decon$Neu, BRCA_methy_decon$Neu))), as.matrix(HE_BRCA_modif$Neutrophils))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(rowMeans(cbind(BRCA_BPRNACan3DProMet_decon$Neu, BRCA_methy_decon$Neu))), as.matrix(HE_BRCA_modif$Neutrophils))$p.value, 9)), parse = TRUE, size = 4) + annotate("text", x = 0.008, y = 0.35, label = paste("RMSE =", round(sqrt(mean((as.matrix(rowMeans(cbind(BRCA_BPRNACan3DProMet_decon$Neu, BRCA_methy_decon$Neu))) - as.matrix(HE_BRCA_modif$Neutrophils))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.0051, y = 0.3, label = paste("n = ", nrow(BRCA_methy_decon)), size = 4)
```

```{r}
#### BPRNACan3D

Lym_BRCA_3DRNA <- cbind(lymph_BRCA_BPRNACan3DProMet, HE_BRCA_modif$Lymphocytes)
colnames(Lym_BRCA_3DRNA) <- c("Cancer_cell_fractions", "Lymphocytes")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((lymph_BRCA_BPRNACan3DProMet - HE_BRCA_modif$Lymphocytes)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Lym_BRCA_3DRNA <- ggplot(as.data.frame(Lym_BRCA_3DRNA), aes(x = Lymphocytes, y = Cancer_cell_fractions)) +
  geom_point(colour = c("darkslategrey")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"BPRNACan3D") +
  scale_x_continuous(name = NULL, limits = c(0, max(Lym_BRCA_3DRNA))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Lym_BRCA_3DRNA))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)

Macro_BRCA_3DRNA <- cbind(Macro_BRCA_BPRNACan3DProMet, HE_BRCA_modif$Macrophages)
colnames(Macro_BRCA_3DRNA) <- c("Cancer_cell_fractions", "Macrophages")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((Macro_BRCA_BPRNACan3DProMet - HE_BRCA_modif$Macrophages)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Macro_BRCA_3DRNA <- ggplot(as.data.frame(Macro_BRCA_3DRNA), aes(x = Macrophages, y = Cancer_cell_fractions)) +
  geom_point(colour = c("coral")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"BPRNACan3D") +
  scale_x_continuous(name = NULL, limits = c(0, max(Macro_BRCA_3DRNA))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Macro_BRCA_3DRNA))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)


Neu_BRCA_3DRNA <- cbind(BRCA_BPRNACan3DProMet_decon$Neu, HE_BRCA_modif$Neutrophils)
colnames(Neu_BRCA_3DRNA) <- c("Cancer_cell_fractions", "Neutrophils")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((BRCA_BPRNACan3DProMet_decon$Neu - HE_BRCA_modif$Neutrophils)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Neu_BRCA_3DRNA <- ggplot(as.data.frame(Neu_BRCA_3DRNA), aes(x = Neutrophils, y = Cancer_cell_fractions)) +
  geom_point(colour = c("green")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"BPRNACan3D") +
  scale_x_continuous(name = NULL, limits = c(0, max(Neu_BRCA_3DRNA))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Neu_BRCA_3DRNA))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)


#### BPmetCan

#### lympho

Lym_BRCA_methy <- cbind(lymph_methy, HE_BRCA_modif$Lymphocytes)
colnames(Lym_BRCA_methy) <- c("Cancer_cell_fractions", "Lymphocytes")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((Lym_BRCA_methy - HE_BRCA_modif$Lymphocytes)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Lym_BRCA_BPmetCan <- ggplot(as.data.frame(Lym_BRCA_methy), aes(x = Lymphocytes, y = Cancer_cell_fractions)) +
  geom_point(colour = c("darkslategrey")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"BPmetCan") +
  scale_x_continuous(name = NULL, limits = c(0, max(Lym_BRCA_methy))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Lym_BRCA_methy))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)

#### Macro

Macro_Methy <- BRCA_methy_decon$M0 + BRCA_methy_decon$M1 + BRCA_methy_decon$M2 + BRCA_methy_decon$Mono

Macro_BRCA_methy <- cbind(Macro_Methy, HE_BRCA_modif$Macrophages)
colnames(Macro_BRCA_methy) <- c("Cancer_cell_fractions", "Macrophages")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((Macro_BRCA_methy - HE_BRCA_modif$Macrophages)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Macro_BRCA_BPmetCan <- ggplot(as.data.frame(Macro_BRCA_methy), aes(x = Macrophages, y = Cancer_cell_fractions)) +
  geom_point(colour = c("coral")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"BPmetCan") +
  scale_x_continuous(name = NULL, limits = c(0, max(Macro_Methy))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Macro_Methy))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)


#### Neu

Neu_BRCA_methy <- cbind(BRCA_methy_decon$Neu, HE_BRCA_modif$Neutrophils)
colnames(Neu_BRCA_methy) <- c("Cancer_cell_fractions", "Neutrophils")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((BRCA_methy_decon$Neu - HE_BRCA_modif$Neutrophils)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Neu_BRCA_BPmetCan <- ggplot(as.data.frame(Neu_BRCA_methy), aes(x = Neutrophils, y = Cancer_cell_fractions)) +
  geom_point(colour = c("green")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"BPmetCan") + 
  scale_x_continuous(name = NULL, limits = c(0, max(Neu_BRCA_methy))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Neu_BRCA_methy))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)



#### avrg

Lym_BRCA_avrg <- cbind(lymph_BRCA_BPRNACan_avr, HE_BRCA_modif$Lymphocytes)
colnames(Lym_BRCA_avrg) <- c("Cancer_cell_fractions", "Lymphocytes")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((lymph_BRCA_BPRNACan_avr - HE_BRCA_modif$Lymphocytes)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Lym_BRCA_avrg <- ggplot(as.data.frame(Lym_BRCA_avrg), aes(x = Lymphocytes, y = Cancer_cell_fractions)) +
  geom_point(colour = c("darkslategrey")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"Meth + RNA") + 
  scale_x_continuous(name = NULL, limits = c(0, max(Lym_BRCA_avrg))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Lym_BRCA_avrg))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)


Macro_BRCA_avrg <- cbind(Macro_BRCA_BPRNACan_avr, HE_BRCA_modif$Macrophages)
colnames(Macro_BRCA_avrg) <- c("Cancer_cell_fractions", "Macrophages")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((Macro_BRCA_BPRNACan_avr - HE_BRCA_modif$Macrophages)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Macro_BRCA_avrg <- ggplot(as.data.frame(Macro_BRCA_avrg), aes(x = Macrophages, y = Cancer_cell_fractions)) +
  geom_point(colour = c("coral")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"Meth + RNA") +
  scale_x_continuous(name = NULL, limits = c(0, max(Macro_BRCA_avrg))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Macro_BRCA_avrg))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)

Neu_BRCA_avrg <- cbind(rowMeans(cbind(BRCA_BPRNACan_decon$Neu, BRCA_methy_decon$Neu)), HE_BRCA_modif$Neutrophils)
colnames(Neu_BRCA_avrg) <- c("Cancer_cell_fractions", "Neutrophils")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean(rowMeans(cbind(BRCA_BPRNACan_decon$Neu, BRCA_methy_decon$Neu) - HE_BRCA_modif$Neutrophils)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Neu_BRCA_avrg <- ggplot(as.data.frame(Neu_BRCA_avrg), aes(x = Neutrophils, y = Cancer_cell_fractions)) +
  geom_point(colour = c("green")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"Meth + RNA") + 
  scale_x_continuous(name = NULL, limits = c(0, max(Neu_BRCA_avrg))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Neu_BRCA_avrg))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)



lymph = ggarrange(fig_Lym_BRCA_3DRNA, fig_Lym_BRCA_BPmetCan, fig_Lym_BRCA_avrg, ncol = 3, nrow = 1, labels = "a", font.label = list(size = 20, color = "black"), align = "hv")
neutro = ggarrange(fig_Neu_BRCA_3DRNA, fig_Neu_BRCA_BPmetCan, fig_Neu_BRCA_avrg, ncol = 3, nrow = 1, labels = "b", font.label = list(size = 20, color = "black"), align = "hv")
macro = ggarrange(fig_Macro_BRCA_3DRNA, fig_Macro_BRCA_BPmetCan, fig_Macro_BRCA_avrg, ncol = 3, nrow = 1, labels = "c", font.label = list(size = 20, color = "black"), align = "hv")


All_BRCA <- ggarrange(lymph, neutro, macro, ncol = 1, nrow = 3, font.label = list(size = 20, color = "black"), align = "hv")


All_BRCA <- annotate_figure(All_BRCA,
  left = text_grob("Estimated fractions", color = "black", size = 20, rot = 90),
  bottom = text_grob("H&E estimates", color = "black", size = 20)
  
)

All_BRCA
```
RNA, methylation, and averaged values of correlation across a : lymphocytes, b: neutrophils, c : macrophages, using the BPRNACan3D and BPMetCan signatures on EpiDish.


## BLCA

```{r}

BLCA_methy_decon <- read.table("/mnt/SERVER-CRCT-STORAGE/CRCT21/Private/Julien/gemdecan/data/meth/BLCA.txt", sep = "\t", header = T)

Facs_BLCA <- Aran_all_facs[Aran_all_facs$Cancer_type == "BLCA", ]

HE_BLCA <- HE_all_TCGA[HE_all_TCGA$Study == "BLCA", ]

Facs_BLCA_modif <- Facs_BLCA[Facs_BLCA$CPE != "NaN", ]

Comm_samples <- Reduce(intersect, list(HE_BLCA$ParticipantBarcode, Facs_BLCA_modif$Sample_ID, tcga_deconv$Samples, rownames(BLCA_methy_decon)))

Facs_BLCA_modif <- Facs_BLCA_modif %>% .[.$Sample_ID %in% Comm_samples, ]

HE_BLCA_modif <- HE_BLCA %>%
  .[.$ParticipantBarcode %in% Comm_samples, ] %>%
  .[order(.$ParticipantBarcode), ]

BLCA_methy_decon <- BLCA_methy_decon[Comm_samples, ] %>% 
  rownames_to_column() 
BLCA_methy_decon <- BLCA_methy_decon[order(BLCA_methy_decon$rowname), ]
rownames(BLCA_methy_decon) <- BLCA_methy_decon$rowname
BLCA_methy_decon <- BLCA_methy_decon[,-1]

BLCA_RNA_decon <- tcga_deconv %>% filter(Samples %in% Comm_samples)

###################################
##### Estimating Tumor Purity #####
###################################


BLCA_BPRNACan_decon <- BLCA_RNA_decon %>% select(colnames(BLCA_RNA_decon)[grepl("Epidish_BPRNACan_", colnames(BLCA_RNA_decon))])
colnames(BLCA_BPRNACan_decon) <- colnames(BLCA_BPRNACan_decon) %>% str_remove_all("Epidish_BPRNACan_")

a <- cbind(BLCA_BPRNACan_decon$cancer, Facs_BLCA_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_BLCA_BPRNACan <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BLCA") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0.8, 1.2), breaks = seq(0.0, 1.2, 0.1)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.42, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(BLCA_BPRNACan_decon$cancer), as.matrix(Facs_BLCA_modif$CPE))$est, 2), "~','", "~italic(P)<", round(cor.test(as.matrix(BLCA_BPRNACan_decon$cancer), as.matrix(Facs_BLCA_modif$CPE))$p.value, 14)), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.15, label = paste("RMSE =", round(sqrt(mean((as.matrix(BLCA_BPRNACan_decon$cancer) - as.matrix(Facs_BLCA_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 1.1, label = paste("n = ", nrow(BLCA_BPRNACan_decon)), size = 4)


BLCA_BPRNACanProMet_decon <- BLCA_RNA_decon %>% select(colnames(BLCA_RNA_decon)[grepl("Epidish_BPRNACanProMet_", colnames(BLCA_RNA_decon))])
colnames(BLCA_BPRNACanProMet_decon) <- colnames(BLCA_BPRNACanProMet_decon) %>% str_remove_all("Epidish_BPRNACanProMet_")

a <- cbind(BLCA_BPRNACanProMet_decon$cancer, Facs_BLCA_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_BLCA_BPRNACanProMet <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BLCA") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0.8, 1.2), breaks = seq(0.0, 1.2, 0.1)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.45, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(BLCA_BPRNACanProMet_decon$cancer), as.matrix(Facs_BLCA_modif$CPE))$est, 2), "~','", "~italic(P)<", round(cor.test(as.matrix(BLCA_BPRNACanProMet_decon$cancer), as.matrix(Facs_BLCA_modif$CPE))$p.value, 14)), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.15, label = paste("RMSE =", round(sqrt(mean((as.matrix(BLCA_BPRNACanProMet_decon$cancer) - as.matrix(Facs_BLCA_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 1.1, label = paste("n = ", nrow(BLCA_BPRNACanProMet_decon)), size = 4)


BLCA_BPRNACan3DProMet_decon <- BLCA_RNA_decon %>% select(colnames(BLCA_RNA_decon)[grepl("Epidish_BPRNACan3DProMet_", colnames(BLCA_RNA_decon))])
colnames(BLCA_BPRNACan3DProMet_decon) <- colnames(BLCA_BPRNACan3DProMet_decon) %>% str_remove_all("Epidish_BPRNACan3DProMet_")


a <- cbind(BLCA_BPRNACan3DProMet_decon$cancer, Facs_BLCA_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_BLCA_BPRNACan3DProMet <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BLCA") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0.8, 1.2), breaks = seq(0.0, 1.2, 0.1)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.52, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(BLCA_BPRNACan3DProMet_decon$cancer), as.matrix(Facs_BLCA_modif$CPE))$est, 2), "~','", "~italic(P)<", round(cor.test(as.matrix(BLCA_BPRNACan3DProMet_decon$cancer), as.matrix(Facs_BLCA_modif$CPE))$p.value, 14)), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.15, label = paste("RMSE =", round(sqrt(mean((as.matrix(BLCA_BPRNACan3DProMet_decon$cancer) - as.matrix(Facs_BLCA_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 1.1, label = paste("n = ", nrow(BLCA_BPRNACan3DProMet_decon)), size = 4)

###### Methylation part

a <- cbind(BLCA_methy_decon$cancer, Facs_BLCA_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_BLCA_BPmetCan <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BLCA") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0, 1.2), breaks = seq(0.0, 1.2, 0.2)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.45, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(BLCA_methy_decon$cancer), as.matrix(Facs_BLCA_modif$CPE))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.05, label = paste("RMSE =", round(sqrt(mean((as.matrix(BLCA_methy_decon$cancer) - as.matrix(Facs_BLCA_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 0.9, label = paste("n = ", nrow(BLCA_methy_decon)), size = 4)


###############################################################
##### Estimating Lymphocytes, Macrophages and Neutrophils #####
###############################################################

##### RNA expression Part #####

#### lymph

lymph_BLCA_BPRNACan <- BLCA_BPRNACan_decon$B + BLCA_BPRNACan_decon$CD4 + BLCA_BPRNACan_decon$CD8 + BLCA_BPRNACan_decon$NK

a <- cbind(lymph_BLCA_BPRNACan, HE_BLCA_modif$Lymphocytes)
colnames(a) <- c("lymph_fractions", "HE")

Fig_BLCA_lymph_BPRNACan <- ggscatter(data.frame(a), x = "HE", y = "lymph_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BLCA") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.08)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.235, y = 0.08, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_BLCA_BPRNACan), as.matrix(HE_BLCA_modif$Lymphocytes))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.07, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_BLCA_BPRNACan) - as.matrix(HE_BLCA_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.06, label = paste("n = ", nrow(BLCA_methy_decon)), size = 4)



lymph_BLCA_BPRNACanProMet <- BLCA_BPRNACanProMet_decon$B + BLCA_BPRNACanProMet_decon$CD4 + BLCA_BPRNACanProMet_decon$CD8 + BLCA_BPRNACanProMet_decon$NK

a <- cbind(lymph_BLCA_BPRNACanProMet, HE_BLCA_modif$Lymphocytes)
colnames(a) <- c("lymph_fractions", "HE")

Fig_BLCA_lymph_BPRNACanProMet <- ggscatter(data.frame(a), x = "HE", y = "lymph_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BLCA") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.08)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.235, y = 0.08, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_BLCA_BPRNACanProMet), as.matrix(HE_BLCA_modif$Lymphocytes))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(lymph_BLCA_BPRNACanProMet), as.matrix(HE_BLCA_modif$Lymphocytes))$p.value, 13)), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.07, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_BLCA_BPRNACanProMet) - as.matrix(HE_BLCA_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.06, label = paste("n = ", nrow(BLCA_BPRNACanProMet_decon)), size = 4)


lymph_BLCA_BPRNACan3DProMet <- BLCA_BPRNACan3DProMet_decon$B + BLCA_BPRNACan3DProMet_decon$CD4 + BLCA_BPRNACan3DProMet_decon$CD8 + BLCA_BPRNACan3DProMet_decon$NK

a <- cbind(lymph_BLCA_BPRNACan3DProMet, HE_BLCA_modif$Lymphocytes)
colnames(a) <- c("lymph_fractions", "HE")

Fig_BLCA_lymph_BPRNACan3DProMet <- ggscatter(data.frame(a), x = "HE", y = "lymph_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BLCA") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.08)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.235, y = 0.08, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_BLCA_BPRNACan3DProMet), as.matrix(HE_BLCA_modif$Lymphocytes))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(lymph_BLCA_BPRNACan3DProMet), as.matrix(HE_BLCA_modif$Lymphocytes))$p.value, 13)), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.07, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_BLCA_BPRNACan3DProMet) - as.matrix(HE_BLCA_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.06, label = paste("n = ", nrow(BLCA_BPRNACanProMet_decon)), size = 4)


#### Macro

Macro_BLCA_BPRNACan <- BLCA_BPRNACan_decon$M0 + BLCA_BPRNACan_decon$M1 + BLCA_BPRNACan_decon$M2 + BLCA_BPRNACan_decon$Mono

a <- cbind(Macro_BLCA_BPRNACan, HE_BLCA_modif$Macrophages)
colnames(a) <- c("Macro_fractions", "HE")

Fig_BLCA_Macro_BPRNACan <- ggscatter(data.frame(a), x = "HE", y = "Macro_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BLCA") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.4)) + scale_y_continuous(name = NULL, limits = c(0, 0.06)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.175, y = 0.06, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_BLCA_BPRNACan), as.matrix(HE_BLCA_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.11, y = 0.0526, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_BLCA_BPRNACan) - as.matrix(HE_BLCA_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.08, y = 0.045, label = paste("n = ", nrow(BLCA_BPRNACan_decon)), size = 4)



Macro_BLCA_BPRNACanProMet <- BLCA_BPRNACanProMet_decon$M0 + BLCA_BPRNACanProMet_decon$M1 + BLCA_BPRNACanProMet_decon$M2 + BLCA_BPRNACanProMet_decon$Mono

a <- cbind(Macro_BLCA_BPRNACanProMet, HE_BLCA_modif$Macrophages)
colnames(a) <- c("Macro_fractions", "HE")

Fig_BLCA_Macro_BPRNACanProMet <- ggscatter(data.frame(a), x = "HE", y = "Macro_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BLCA") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.4)) + scale_y_continuous(name = NULL, limits = c(0, 0.06)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.185, y = 0.06, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_BLCA_BPRNACanProMet), as.matrix(HE_BLCA_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.11, y = 0.0526, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_BLCA_BPRNACanProMet) - as.matrix(HE_BLCA_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.08, y = 0.045, label = paste("n = ", nrow(BLCA_BPRNACan_decon)), size = 4)

Macro_BLCA_BPRNACan3DProMet <- BLCA_BPRNACan3DProMet_decon$M0 + BLCA_BPRNACan3DProMet_decon$M1 + BLCA_BPRNACan3DProMet_decon$M2 + BLCA_BPRNACan3DProMet_decon$Mono

a <- cbind(Macro_BLCA_BPRNACan3DProMet, HE_BLCA_modif$Macrophages)
colnames(a) <- c("Macro_fractions", "HE")

Fig_BLCA_Macro_BPRNACan3DProMet <- ggscatter(data.frame(a), x = "HE", y = "Macro_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BLCA") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.4)) + scale_y_continuous(name = NULL, limits = c(0, 0.06)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.185, y = 0.06, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_BLCA_BPRNACan3DProMet), as.matrix(HE_BLCA_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.11, y = 0.0526, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_BLCA_BPRNACan3DProMet) - as.matrix(HE_BLCA_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.08, y = 0.045, label = paste("n = ", nrow(BLCA_BPRNACan_decon)), size = 4)

#### Neutrophis

a <- cbind(BLCA_BPRNACan_decon$Neu, HE_BLCA_modif$Neutrophils)
colnames(a) <- c("Neu_fractions", "HE")

Fig_BLCA_Neu_BPRNACan <- ggscatter(data.frame(a), x = "HE", y = "Neu_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BLCA") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.006)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.015, y = 0.006, label = paste("italic(r)==", round(cor.test(as.matrix(BLCA_BPRNACan_decon$Neu), as.matrix(HE_BLCA_modif$Neutrophils))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.009, y = 0.00525, label = paste("RMSE =", round(sqrt(mean((as.matrix(BLCA_BPRNACan_decon$Neu) - as.matrix(HE_BLCA_modif$Neutrophils))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.0065, y = 0.0046, label = paste("n = ", nrow(BLCA_BPRNACan_decon)), size = 4)


a <- cbind(BLCA_BPRNACanProMet_decon$Neu, HE_BLCA_modif$Neutrophils)
colnames(a) <- c("Neu_fractions", "HE")

Fig_BLCA_Neu_BPRNACanProMet <- ggscatter(data.frame(a[-155, ]), x = "HE", y = "Neu_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BLCA") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.006)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.015, y = 0.006, label = paste("italic(r)==", round(cor.test(as.matrix(BLCA_BPRNACanProMet_decon$Neu), as.matrix(HE_BLCA_modif$Neutrophils))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.0105, y = 0.00525, label = paste("RMSE =", round(sqrt(mean((as.matrix(BLCA_BPRNACanProMet_decon$Neu) - as.matrix(HE_BLCA_modif$Neutrophils))^2, na.rm = T)), 5)), parse = F, size = 4) + annotate("text", x = 0.0065, y = 0.0046, label = paste("n = ", nrow(BLCA_BPRNACan_decon)), size = 4)


a <- cbind(BLCA_BPRNACan3DProMet_decon$Neu, HE_BLCA_modif$Neutrophils)
colnames(a) <- c("Neu_fractions", "HE")

Fig_BLCA_Neu_BPRNACan3DProMet <- ggscatter(data.frame(a), x = "HE", y = "Neu_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BLCA") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.008)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.015, y = 0.008, label = paste("italic(r)==", round(cor.test(as.matrix(BLCA_BPRNACan3DProMet_decon$Neu), as.matrix(HE_BLCA_modif$Neutrophils))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(BLCA_BPRNACan3DProMet_decon$Neu), as.matrix(HE_BLCA_modif$Neutrophils))$p.value, 15)), parse = TRUE, size = 4) + annotate("text", x = 0.0105, y = 0.007, label = paste("RMSE =", round(sqrt(mean((as.matrix(BLCA_BPRNACan3DProMet_decon$Neu) - as.matrix(HE_BLCA_modif$Neutrophils))^2, na.rm = T)), 3)), parse = F, size = 4) + annotate("text", x = 0.0065, y = 0.006, label = paste("n = ", nrow(BLCA_BPRNACan_decon)), size = 4)

##### DNA methylation Part #####

#### lympho

lymph_methy <- BLCA_methy_decon$B + BLCA_methy_decon$CD4 + BLCA_methy_decon$CD8 + BLCA_methy_decon$Treg + BLCA_methy_decon$NK

a <- cbind(lymph_methy, HE_BLCA_modif$Lymphocytes)
colnames(a) <- c("lymph_methy", "HE_lympho")

Fig_BLCA_lymph_BPmetCan <- ggscatter(data.frame(a), x = "HE_lympho", y = "lymph_methy", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BLCA") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_methy), as.matrix(HE_BLCA_modif$Lymphocytes))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_methy) - as.matrix(HE_BLCA_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(BLCA_methy_decon)), size = 4)


#### Macro

Macro_Methy <- BLCA_methy_decon$M0 + BLCA_methy_decon$M1 + BLCA_methy_decon$M2 + BLCA_methy_decon$Mono

a <- cbind(Macro_Methy, HE_BLCA_modif$Macrophages)
colnames(a) <- c("Macro_Methy", "HE_macro")

Fig_BLCA_Macro_BPmetCan <- ggscatter(data.frame(a), x = "HE_macro", y = "Macro_Methy", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BLCA") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_Methy), as.matrix(HE_BLCA_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_Methy) - as.matrix(HE_BLCA_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(BLCA_methy_decon)), size = 4)

#### Neu

a <- cbind(BLCA_methy_decon$Neu, HE_BLCA_modif$Neutrophils)
colnames(a) <- c("Neu_Methy", "HE_neu")

Fig_BLCA_Neu_BPmetCan <- ggscatter(data.frame(a), x = "HE_neu", y = "Neu_Methy", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BLCA") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.8)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.0135, y = 0.8, label = paste("italic(r)==", round(cor.test(as.matrix(BLCA_methy_decon$Neu), as.matrix(HE_BLCA_modif$Neutrophils))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(BLCA_methy_decon$Neu), as.matrix(HE_BLCA_modif$Neutrophils))$p.value, 10)), parse = TRUE, size = 4) + annotate("text", x = 0.0085, y = 0.7, label = paste("RMSE =", round(sqrt(mean((as.matrix(BLCA_methy_decon$Neu) - as.matrix(HE_BLCA_modif$Neutrophils))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.0057, y = 0.6, label = paste("n = ", nrow(BLCA_methy_decon)), size = 4)


##### Correlation between DNA methylation and expression deconvolution #####

## Tumor purity

a <- cbind(BLCA_BPRNACan_decon$cancer, BLCA_methy_decon$cancer)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_BLCA_TM_BPRNACan_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BLCA") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL, limits = c(0, 1)) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", label.x = 0, label.y = 1, size = 6)

a <- cbind(BLCA_BPRNACanProMet_decon$cancer, BLCA_methy_decon$cancer)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_BLCA_TM_BPRNACanProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BLCA") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL, limits = c(0, 1)) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", label.x = 0, label.y = 1, size = 6)

a <- cbind(BLCA_BPRNACan3DProMet_decon$cancer, BLCA_methy_decon$cancer)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_BLCA_TM_BPRNACan3DProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BLCA") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL, limits = c(0, 1)) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", label.x = 0, label.y = 1, size = 6)


## Lymphcytes

a <- cbind(lymph_BLCA_BPRNACan, lymph_methy)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_BLCA_lymph_BPRNACan_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "BLCA") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")

a <- cbind(lymph_BLCA_BPRNACanProMet, lymph_methy)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_BLCA_lymph_BPRNACanProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "BLCA") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")

a <- cbind(lymph_BLCA_BPRNACan3DProMet, lymph_methy)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_BLCA_lymph_BPRNACan3DProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "BLCA") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")


## Macrophages

a <- cbind(Macro_BLCA_BPRNACan, Macro_Methy)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_BLCA_macro_BPRNACan_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "BLCA") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")


a <- cbind(Macro_BLCA_BPRNACanProMet, Macro_Methy)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_BLCA_macro_BPRNACanProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "BLCA") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")

a <- cbind(Macro_BLCA_BPRNACan3DProMet, Macro_Methy)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_BLCA_macro_BPRNACan3DProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "BLCA") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")


## Netrophils

a <- cbind(BLCA_BPRNACan_decon$Neu, BLCA_methy_decon$Neu)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_BLCA_Neu_BPRNACan_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "BLCA") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")


a <- cbind(BLCA_BPRNACanProMet_decon$Neu, BLCA_methy_decon$Neu)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_BLCA_Neu_BPRNACanProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "BLCA") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")

a <- cbind(BLCA_BPRNACan3DProMet_decon$Neu, BLCA_methy_decon$Neu)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_BLCA_Neu_BPRNACan3DProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "BLCA") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")



###############################################
###### average of Methylation and RNAseq ######
###############################################

#### Tumor purity

a <- cbind(rowMeans(cbind(BLCA_BPRNACan_decon$cancer, BLCA_methy_decon$cancer)), Facs_BLCA_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_BLCA_BPRNACan_avrage <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BLCA") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0, 1.2), breaks = seq(0.0, 1.2, 0.2)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.45, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(rowMeans(cbind(BLCA_BPRNACan_decon$cancer, BLCA_methy_decon$cancer))), as.matrix(Facs_BLCA_modif$CPE))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.05, label = paste("RMSE =", round(sqrt(mean((as.matrix(rowMeans(cbind(BLCA_BPRNACan_decon$cancer, BLCA_methy_decon$cancer))) - as.matrix(Facs_BLCA_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 0.9, label = paste("n = ", nrow(BLCA_BPRNACan_decon)), size = 4)


a <- cbind(rowMeans(cbind(BLCA_BPRNACanProMet_decon$cancer, BLCA_methy_decon$cancer)), Facs_BLCA_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_BLCA_BPRNACanProMet_avrage <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BLCA") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0, 1.2), breaks = seq(0.0, 1.2, 0.2)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.45, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(rowMeans(cbind(BLCA_BPRNACanProMet_decon$cancer, BLCA_methy_decon$cancer))), as.matrix(Facs_BLCA_modif$CPE))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.05, label = paste("RMSE =", round(sqrt(mean((as.matrix(rowMeans(cbind(BLCA_BPRNACanProMet_decon$cancer, BLCA_methy_decon$cancer))) - as.matrix(Facs_BLCA_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 0.9, label = paste("n = ", nrow(BLCA_BPRNACan_decon)), size = 4)


a <- cbind(rowMeans(cbind(BLCA_BPRNACan3DProMet_decon$cancer, BLCA_methy_decon$cancer)), Facs_BLCA_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_BLCA_BPRNACan3DProMet_avrage <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BLCA") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0, 1.2), breaks = seq(0.0, 1.2, 0.2)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.45, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(rowMeans(cbind(BLCA_BPRNACan3DProMet_decon$cancer, BLCA_methy_decon$cancer))), as.matrix(Facs_BLCA_modif$CPE))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.05, label = paste("RMSE =", round(sqrt(mean((as.matrix(rowMeans(cbind(BLCA_BPRNACan3DProMet_decon$cancer, BLCA_methy_decon$cancer))) - as.matrix(Facs_BLCA_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 0.9, label = paste("n = ", nrow(BLCA_BPRNACan_decon)), size = 4)


#### Lymphocytes

lymph_BLCA_BPRNACan_avr <- rowMeans(cbind(BLCA_BPRNACan_decon$B + BLCA_BPRNACan_decon$NK + BLCA_BPRNACan_decon$CD4 + BLCA_BPRNACan_decon$CD8, BLCA_methy_decon$B + BLCA_methy_decon$CD4 + BLCA_methy_decon$CD8 + BLCA_methy_decon$NK + BLCA_methy_decon$Treg))

a <- cbind(lymph_BLCA_BPRNACan_avr, HE_BLCA_modif$Lymphocytes)
colnames(a) <- c("Cancer_cell_fractions", "Lymphocytes")

Fig_BLCA_lymph_BPRNACan_avrage <- ggscatter(data.frame(a), x = "Lymphocytes", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BLCA") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_BLCA_BPRNACan_avr), as.matrix(HE_BLCA_modif$Lymphocytes))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_BLCA_BPRNACan_avr) - as.matrix(HE_BLCA_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(BLCA_methy_decon)), size = 4)


lymph_BLCA_BPRNACanProMet_avr <- rowMeans(cbind(BLCA_BPRNACanProMet_decon$B + BLCA_BPRNACanProMet_decon$NK + BLCA_BPRNACanProMet_decon$CD4 + BLCA_BPRNACanProMet_decon$CD8, BLCA_methy_decon$B + BLCA_methy_decon$CD4 + BLCA_methy_decon$CD8 + BLCA_methy_decon$NK + BLCA_methy_decon$Treg))

a <- cbind(lymph_BLCA_BPRNACanProMet_avr, HE_BLCA_modif$Lymphocytes)
colnames(a) <- c("Cancer_cell_fractions", "Lymphocytes")

Fig_BLCA_lymph_BPRNACanProMet_avrage <- ggscatter(data.frame(a), x = "Lymphocytes", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BLCA") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_BLCA_BPRNACanProMet_avr), as.matrix(HE_BLCA_modif$Lymphocytes))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_BLCA_BPRNACanProMet_avr) - as.matrix(HE_BLCA_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(BLCA_methy_decon)), size = 4)

lymph_BLCA_BPRNACan3DProMet_avr <- rowMeans(cbind(BLCA_BPRNACan3DProMet_decon$B + BLCA_BPRNACan3DProMet_decon$NK + BLCA_BPRNACan3DProMet_decon$CD4 + BLCA_BPRNACan3DProMet_decon$CD8, BLCA_methy_decon$B + BLCA_methy_decon$CD4 + BLCA_methy_decon$CD8 + BLCA_methy_decon$NK + BLCA_methy_decon$Treg))

a <- cbind(lymph_BLCA_BPRNACan3DProMet_avr, HE_BLCA_modif$Lymphocytes)
colnames(a) <- c("Cancer_cell_fractions", "Lymphocytes")

Fig_BLCA_lymph_BPRNACan3DProMet_avrage <- ggscatter(data.frame(a), x = "Lymphocytes", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BLCA") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_BLCA_BPRNACan3DProMet_avr), as.matrix(HE_BLCA_modif$Lymphocytes))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_BLCA_BPRNACan3DProMet_avr) - as.matrix(HE_BLCA_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(BLCA_methy_decon)), size = 4)

#### Macrophages

Macro_BLCA_BPRNACan_avr <- rowMeans(cbind(BLCA_BPRNACan_decon$M0 + BLCA_BPRNACan_decon$M1 + BLCA_BPRNACan_decon$M2 + BLCA_BPRNACan_decon$Mono, BLCA_methy_decon$M0 + BLCA_methy_decon$M1 + BLCA_methy_decon$M2 + BLCA_methy_decon$Mono))

a <- cbind(Macro_BLCA_BPRNACan_avr, HE_BLCA_modif$Macrophages)
colnames(a) <- c("Cancer_cell_fractions", "Macrophages")

Fig_BLCA_Macro_BPRNACan_avrage <- ggscatter(data.frame(a), x = "Macrophages", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BLCA") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_BLCA_BPRNACan_avr), as.matrix(HE_BLCA_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_BLCA_BPRNACan_avr) - as.matrix(HE_BLCA_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(BLCA_methy_decon)), size = 4)

Macro_BLCA_BPRNACanProMet_avr <- rowMeans(cbind(BLCA_BPRNACanProMet_decon$M0 + BLCA_BPRNACanProMet_decon$M1 + BLCA_BPRNACanProMet_decon$M2 + BLCA_BPRNACanProMet_decon$Mono, BLCA_methy_decon$M0 + BLCA_methy_decon$M1 + BLCA_methy_decon$M2 + BLCA_methy_decon$Mono))

a <- cbind(Macro_BLCA_BPRNACanProMet_avr, HE_BLCA_modif$Macrophages)
colnames(a) <- c("Cancer_cell_fractions", "Macrophages")

Fig_BLCA_Macro_BPRNACanProMet_avrage <- ggscatter(data.frame(a), x = "Macrophages", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BLCA") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_BLCA_BPRNACanProMet_avr), as.matrix(HE_BLCA_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_BLCA_BPRNACanProMet_avr) - as.matrix(HE_BLCA_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(BLCA_methy_decon)), size = 4)


Macro_BLCA_BPRNACan3DProMet_avr <- rowMeans(cbind(BLCA_BPRNACan3DProMet_decon$M0 + BLCA_BPRNACan3DProMet_decon$M1 + BLCA_BPRNACan3DProMet_decon$M2 + BLCA_BPRNACan3DProMet_decon$Mono, BLCA_methy_decon$M0 + BLCA_methy_decon$M1 + BLCA_methy_decon$M2 + BLCA_methy_decon$Mono))

a <- cbind(Macro_BLCA_BPRNACan3DProMet_avr, HE_BLCA_modif$Macrophages)
colnames(a) <- c("Cancer_cell_fractions", "Macrophages")

Fig_BLCA_Macro_BPRNACan3DProMet_avrage <- ggscatter(data.frame(a), x = "Macrophages", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BLCA") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_BLCA_BPRNACan3DProMet_avr), as.matrix(HE_BLCA_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_BLCA_BPRNACan3DProMet_avr) - as.matrix(HE_BLCA_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(BLCA_methy_decon)), size = 4)


#### Neutrophils

a <- cbind(rowMeans(cbind(BLCA_BPRNACan_decon$Neu, BLCA_methy_decon$Neu)), HE_BLCA_modif$Neutrophils)
colnames(a) <- c("Cancer_cell_fractions", "Neutrophils")

Fig_BLCA_Neu_BPRNACan_avrage <- ggscatter(data.frame(a), x = "Neutrophils", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BLCA") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.4)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.012, y = 0.4, label = paste("italic(r)==", round(cor.test(as.matrix(rowMeans(cbind(BLCA_BPRNACan_decon$Neu, BLCA_methy_decon$Neu))), as.matrix(HE_BLCA_modif$Neutrophils))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(rowMeans(cbind(BLCA_BPRNACan_decon$Neu, BLCA_methy_decon$Neu))), as.matrix(HE_BLCA_modif$Neutrophils))$p.value, 9)), parse = TRUE, size = 4) + annotate("text", x = 0.008, y = 0.35, label = paste("RMSE =", round(sqrt(mean((as.matrix(rowMeans(cbind(BLCA_BPRNACan_decon$Neu, BLCA_methy_decon$Neu))) - as.matrix(HE_BLCA_modif$Neutrophils))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.0051, y = 0.3, label = paste("n = ", nrow(BLCA_methy_decon)), size = 4)

a <- cbind(rowMeans(cbind(BLCA_BPRNACanProMet_decon$Neu, BLCA_methy_decon$Neu)), HE_BLCA_modif$Neutrophils)
colnames(a) <- c("Cancer_cell_fractions", "Neutrophils")

Fig_BLCA_Neu_BPRNACanProMet_avrage <- ggscatter(data.frame(a), x = "Neutrophils", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BLCA") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.4)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.012, y = 0.4, label = paste("italic(r)==", round(cor.test(as.matrix(rowMeans(cbind(BLCA_BPRNACanProMet_decon$Neu, BLCA_methy_decon$Neu))), as.matrix(HE_BLCA_modif$Neutrophils))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(rowMeans(cbind(BLCA_BPRNACanProMet_decon$Neu, BLCA_methy_decon$Neu))), as.matrix(HE_BLCA_modif$Neutrophils))$p.value, 9)), parse = TRUE, size = 4) + annotate("text", x = 0.008, y = 0.35, label = paste("RMSE =", round(sqrt(mean((as.matrix(rowMeans(cbind(BLCA_BPRNACanProMet_decon$Neu, BLCA_methy_decon$Neu))) - as.matrix(HE_BLCA_modif$Neutrophils))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.0051, y = 0.3, label = paste("n = ", nrow(BLCA_methy_decon)), size = 4)

a <- cbind(rowMeans(cbind(BLCA_BPRNACan3DProMet_decon$Neu, BLCA_methy_decon$Neu)), HE_BLCA_modif$Neutrophils)
colnames(a) <- c("Cancer_cell_fractions", "Neutrophils")

Fig_BLCA_Neu_BPRNACan3DProMet_avrage <- ggscatter(data.frame(a), x = "Neutrophils", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "BLCA") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.4)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.012, y = 0.4, label = paste("italic(r)==", round(cor.test(as.matrix(rowMeans(cbind(BLCA_BPRNACan3DProMet_decon$Neu, BLCA_methy_decon$Neu))), as.matrix(HE_BLCA_modif$Neutrophils))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(rowMeans(cbind(BLCA_BPRNACan3DProMet_decon$Neu, BLCA_methy_decon$Neu))), as.matrix(HE_BLCA_modif$Neutrophils))$p.value, 9)), parse = TRUE, size = 4) + annotate("text", x = 0.008, y = 0.35, label = paste("RMSE =", round(sqrt(mean((as.matrix(rowMeans(cbind(BLCA_BPRNACan3DProMet_decon$Neu, BLCA_methy_decon$Neu))) - as.matrix(HE_BLCA_modif$Neutrophils))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.0051, y = 0.3, label = paste("n = ", nrow(BLCA_methy_decon)), size = 4)
```

```{r}
#### BPRNACan3D

Lym_BLCA_3DRNA <- cbind(lymph_BLCA_BPRNACan3DProMet, HE_BLCA_modif$Lymphocytes)
colnames(Lym_BLCA_3DRNA) <- c("Cancer_cell_fractions", "Lymphocytes")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((lymph_BLCA_BPRNACan3DProMet - HE_BLCA_modif$Lymphocytes)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Lym_BLCA_3DRNA <- ggplot(as.data.frame(Lym_BLCA_3DRNA), aes(x = Lymphocytes, y = Cancer_cell_fractions)) +
  geom_point(colour = c("darkslategrey")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"BPRNACan3D") +
  scale_x_continuous(name = NULL, limits = c(0, max(Lym_BLCA_3DRNA))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Lym_BLCA_3DRNA))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)

Macro_BLCA_3DRNA <- cbind(Macro_BLCA_BPRNACan3DProMet, HE_BLCA_modif$Macrophages)
colnames(Macro_BLCA_3DRNA) <- c("Cancer_cell_fractions", "Macrophages")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((Macro_BLCA_BPRNACan3DProMet - HE_BLCA_modif$Macrophages)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Macro_BLCA_3DRNA <- ggplot(as.data.frame(Macro_BLCA_3DRNA), aes(x = Macrophages, y = Cancer_cell_fractions)) +
  geom_point(colour = c("coral")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"BPRNACan3D") +
  scale_x_continuous(name = NULL, limits = c(0, max(Macro_BLCA_3DRNA))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Macro_BLCA_3DRNA))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)


Neu_BLCA_3DRNA <- cbind(BLCA_BPRNACan3DProMet_decon$Neu, HE_BLCA_modif$Neutrophils)
colnames(Neu_BLCA_3DRNA) <- c("Cancer_cell_fractions", "Neutrophils")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((BLCA_BPRNACan3DProMet_decon$Neu - HE_BLCA_modif$Neutrophils)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Neu_BLCA_3DRNA <- ggplot(as.data.frame(Neu_BLCA_3DRNA), aes(x = Neutrophils, y = Cancer_cell_fractions)) +
  geom_point(colour = c("green")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"BPRNACan3D") +
  scale_x_continuous(name = NULL, limits = c(0, max(Neu_BLCA_3DRNA))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Neu_BLCA_3DRNA))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)


#### BPmetCan

#### lympho

Lym_BLCA_methy <- cbind(lymph_methy, HE_BLCA_modif$Lymphocytes)
colnames(Lym_BLCA_methy) <- c("Cancer_cell_fractions", "Lymphocytes")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((Lym_BLCA_methy - HE_BLCA_modif$Lymphocytes)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Lym_BLCA_BPmetCan <- ggplot(as.data.frame(Lym_BLCA_methy), aes(x = Lymphocytes, y = Cancer_cell_fractions)) +
  geom_point(colour = c("darkslategrey")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"BPmetCan") +
  scale_x_continuous(name = NULL, limits = c(0, max(Lym_BLCA_methy))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Lym_BLCA_methy))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)

#### Macro

Macro_Methy <- BLCA_methy_decon$M0 + BLCA_methy_decon$M1 + BLCA_methy_decon$M2 + BLCA_methy_decon$Mono

Macro_BLCA_methy <- cbind(Macro_Methy, HE_BLCA_modif$Macrophages)
colnames(Macro_BLCA_methy) <- c("Cancer_cell_fractions", "Macrophages")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((Macro_BLCA_methy - HE_BLCA_modif$Macrophages)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Macro_BLCA_BPmetCan <- ggplot(as.data.frame(Macro_BLCA_methy), aes(x = Macrophages, y = Cancer_cell_fractions)) +
  geom_point(colour = c("coral")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"BPmetCan") +
  scale_x_continuous(name = NULL, limits = c(0, max(Macro_Methy))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Macro_Methy))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)


#### Neu

Neu_BLCA_methy <- cbind(BLCA_methy_decon$Neu, HE_BLCA_modif$Neutrophils)
colnames(Neu_BLCA_methy) <- c("Cancer_cell_fractions", "Neutrophils")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((BLCA_methy_decon$Neu - HE_BLCA_modif$Neutrophils)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Neu_BLCA_BPmetCan <- ggplot(as.data.frame(Neu_BLCA_methy), aes(x = Neutrophils, y = Cancer_cell_fractions)) +
  geom_point(colour = c("green")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"BPmetCan") + 
  scale_x_continuous(name = NULL, limits = c(0, max(Neu_BLCA_methy))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Neu_BLCA_methy))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)



#### avrg

Lym_BLCA_avrg <- cbind(lymph_BLCA_BPRNACan_avr, HE_BLCA_modif$Lymphocytes)
colnames(Lym_BLCA_avrg) <- c("Cancer_cell_fractions", "Lymphocytes")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((lymph_BLCA_BPRNACan_avr - HE_BLCA_modif$Lymphocytes)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Lym_BLCA_avrg <- ggplot(as.data.frame(Lym_BLCA_avrg), aes(x = Lymphocytes, y = Cancer_cell_fractions)) +
  geom_point(colour = c("darkslategrey")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"Meth + RNA") + 
  scale_x_continuous(name = NULL, limits = c(0, max(Lym_BLCA_avrg))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Lym_BLCA_avrg))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)


Macro_BLCA_avrg <- cbind(Macro_BLCA_BPRNACan_avr, HE_BLCA_modif$Macrophages)
colnames(Macro_BLCA_avrg) <- c("Cancer_cell_fractions", "Macrophages")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((Macro_BLCA_BPRNACan_avr - HE_BLCA_modif$Macrophages)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Macro_BLCA_avrg <- ggplot(as.data.frame(Macro_BLCA_avrg), aes(x = Macrophages, y = Cancer_cell_fractions)) +
  geom_point(colour = c("coral")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"Meth + RNA") +
  scale_x_continuous(name = NULL, limits = c(0, max(Macro_BLCA_avrg))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Macro_BLCA_avrg))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)

Neu_BLCA_avrg <- cbind(rowMeans(cbind(BLCA_BPRNACan_decon$Neu, BLCA_methy_decon$Neu)), HE_BLCA_modif$Neutrophils)
colnames(Neu_BLCA_avrg) <- c("Cancer_cell_fractions", "Neutrophils")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean(rowMeans(cbind(BLCA_BPRNACan_decon$Neu, BLCA_methy_decon$Neu) - HE_BLCA_modif$Neutrophils)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Neu_BLCA_avrg <- ggplot(as.data.frame(Neu_BLCA_avrg), aes(x = Neutrophils, y = Cancer_cell_fractions)) +
  geom_point(colour = c("green")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"Meth + RNA") + 
  scale_x_continuous(name = NULL, limits = c(0, max(Neu_BLCA_avrg))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Neu_BLCA_avrg))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)



lymph = ggarrange(fig_Lym_BLCA_3DRNA, fig_Lym_BLCA_BPmetCan, fig_Lym_BLCA_avrg, ncol = 3, nrow = 1, labels = "a", font.label = list(size = 20, color = "black"), align = "hv")
neutro = ggarrange(fig_Neu_BLCA_3DRNA, fig_Neu_BLCA_BPmetCan, fig_Neu_BLCA_avrg, ncol = 3, nrow = 1, labels = "b", font.label = list(size = 20, color = "black"), align = "hv")
macro = ggarrange(fig_Macro_BLCA_3DRNA, fig_Macro_BLCA_BPmetCan, fig_Macro_BLCA_avrg, ncol = 3, nrow = 1, labels = "c", font.label = list(size = 20, color = "black"), align = "hv")


All_BLCA <- ggarrange(lymph, neutro, macro, ncol = 1, nrow = 3, font.label = list(size = 20, color = "black"), align = "hv")


All_BLCA <- annotate_figure(All_BLCA,
  left = text_grob("Estimated fractions", color = "black", size = 20, rot = 90),
  bottom = text_grob("H&E estimates", color = "black", size = 20)
  
)

All_BLCA
```
RNA, methylation, and averaged values of correlation across a : lymphocytes, b: neutrophils, c : macrophages, using the BPRNACan3D and BPMetCan signatures on EpiDish.


## UCEC 

```{r}

UCEC_methy_decon <- read.table("/mnt/SERVER-CRCT-STORAGE/CRCT21/Private/Julien/gemdecan/data/meth/UCEC.txt", sep = "\t", header = T)

Facs_UCEC <- Aran_all_facs[Aran_all_facs$Cancer_type == "UCEC", ]

HE_UCEC <- HE_all_TCGA[HE_all_TCGA$Study == "UCEC", ]

Facs_UCEC_modif <- Facs_UCEC[Facs_UCEC$CPE != "NaN", ]

Comm_samples <- Reduce(intersect, list(HE_UCEC$ParticipantBarcode, Facs_UCEC_modif$Sample_ID, tcga_deconv$Samples, rownames(UCEC_methy_decon)))

Facs_UCEC_modif <- Facs_UCEC_modif %>% .[.$Sample_ID %in% Comm_samples, ]

HE_UCEC_modif <- HE_UCEC %>%
  .[.$ParticipantBarcode %in% Comm_samples, ] %>%
  .[order(.$ParticipantBarcode), ]

UCEC_methy_decon <- UCEC_methy_decon[Comm_samples, ] %>% 
  rownames_to_column() 
UCEC_methy_decon <- UCEC_methy_decon[order(UCEC_methy_decon$rowname), ]
rownames(UCEC_methy_decon) <- UCEC_methy_decon$rowname
UCEC_methy_decon <- UCEC_methy_decon[,-1]

UCEC_RNA_decon <- tcga_deconv %>% filter(Samples %in% Comm_samples)

###################################
##### Estimating Tumor Purity #####
###################################


UCEC_BPRNACan_decon <- UCEC_RNA_decon %>% select(colnames(UCEC_RNA_decon)[grepl("Epidish_BPRNACan_", colnames(UCEC_RNA_decon))])
colnames(UCEC_BPRNACan_decon) <- colnames(UCEC_BPRNACan_decon) %>% str_remove_all("Epidish_BPRNACan_")

a <- cbind(UCEC_BPRNACan_decon$cancer, Facs_UCEC_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_UCEC_BPRNACan <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "UCEC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0.8, 1.2), breaks = seq(0.0, 1.2, 0.1)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.42, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(UCEC_BPRNACan_decon$cancer), as.matrix(Facs_UCEC_modif$CPE))$est, 2), "~','", "~italic(P)<", round(cor.test(as.matrix(UCEC_BPRNACan_decon$cancer), as.matrix(Facs_UCEC_modif$CPE))$p.value, 14)), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.15, label = paste("RMSE =", round(sqrt(mean((as.matrix(UCEC_BPRNACan_decon$cancer) - as.matrix(Facs_UCEC_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 1.1, label = paste("n = ", nrow(UCEC_BPRNACan_decon)), size = 4)


UCEC_BPRNACanProMet_decon <- UCEC_RNA_decon %>% select(colnames(UCEC_RNA_decon)[grepl("Epidish_BPRNACanProMet_", colnames(UCEC_RNA_decon))])
colnames(UCEC_BPRNACanProMet_decon) <- colnames(UCEC_BPRNACanProMet_decon) %>% str_remove_all("Epidish_BPRNACanProMet_")

a <- cbind(UCEC_BPRNACanProMet_decon$cancer, Facs_UCEC_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_UCEC_BPRNACanProMet <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "UCEC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0.8, 1.2), breaks = seq(0.0, 1.2, 0.1)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.45, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(UCEC_BPRNACanProMet_decon$cancer), as.matrix(Facs_UCEC_modif$CPE))$est, 2), "~','", "~italic(P)<", round(cor.test(as.matrix(UCEC_BPRNACanProMet_decon$cancer), as.matrix(Facs_UCEC_modif$CPE))$p.value, 14)), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.15, label = paste("RMSE =", round(sqrt(mean((as.matrix(UCEC_BPRNACanProMet_decon$cancer) - as.matrix(Facs_UCEC_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 1.1, label = paste("n = ", nrow(UCEC_BPRNACanProMet_decon)), size = 4)


UCEC_BPRNACan3DProMet_decon <- UCEC_RNA_decon %>% select(colnames(UCEC_RNA_decon)[grepl("Epidish_BPRNACan3DProMet_", colnames(UCEC_RNA_decon))])
colnames(UCEC_BPRNACan3DProMet_decon) <- colnames(UCEC_BPRNACan3DProMet_decon) %>% str_remove_all("Epidish_BPRNACan3DProMet_")


a <- cbind(UCEC_BPRNACan3DProMet_decon$cancer, Facs_UCEC_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_UCEC_BPRNACan3DProMet <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "UCEC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0.8, 1.2), breaks = seq(0.0, 1.2, 0.1)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.52, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(UCEC_BPRNACan3DProMet_decon$cancer), as.matrix(Facs_UCEC_modif$CPE))$est, 2), "~','", "~italic(P)<", round(cor.test(as.matrix(UCEC_BPRNACan3DProMet_decon$cancer), as.matrix(Facs_UCEC_modif$CPE))$p.value, 14)), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.15, label = paste("RMSE =", round(sqrt(mean((as.matrix(UCEC_BPRNACan3DProMet_decon$cancer) - as.matrix(Facs_UCEC_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 1.1, label = paste("n = ", nrow(UCEC_BPRNACan3DProMet_decon)), size = 4)

###### Methylation part

a <- cbind(UCEC_methy_decon$cancer, Facs_UCEC_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_UCEC_BPmetCan <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "UCEC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0, 1.2), breaks = seq(0.0, 1.2, 0.2)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.45, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(UCEC_methy_decon$cancer), as.matrix(Facs_UCEC_modif$CPE))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.05, label = paste("RMSE =", round(sqrt(mean((as.matrix(UCEC_methy_decon$cancer) - as.matrix(Facs_UCEC_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 0.9, label = paste("n = ", nrow(UCEC_methy_decon)), size = 4)


###############################################################
##### Estimating Lymphocytes, Macrophages and Neutrophils #####
###############################################################

##### RNA expression Part #####

#### lymph

lymph_UCEC_BPRNACan <- UCEC_BPRNACan_decon$B + UCEC_BPRNACan_decon$CD4 + UCEC_BPRNACan_decon$CD8 + UCEC_BPRNACan_decon$NK

a <- cbind(lymph_UCEC_BPRNACan, HE_UCEC_modif$Lymphocytes)
colnames(a) <- c("lymph_fractions", "HE")

Fig_UCEC_lymph_BPRNACan <- ggscatter(data.frame(a), x = "HE", y = "lymph_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "UCEC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.08)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.235, y = 0.08, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_UCEC_BPRNACan), as.matrix(HE_UCEC_modif$Lymphocytes))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.07, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_UCEC_BPRNACan) - as.matrix(HE_UCEC_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.06, label = paste("n = ", nrow(UCEC_methy_decon)), size = 4)



lymph_UCEC_BPRNACanProMet <- UCEC_BPRNACanProMet_decon$B + UCEC_BPRNACanProMet_decon$CD4 + UCEC_BPRNACanProMet_decon$CD8 + UCEC_BPRNACanProMet_decon$NK

a <- cbind(lymph_UCEC_BPRNACanProMet, HE_UCEC_modif$Lymphocytes)
colnames(a) <- c("lymph_fractions", "HE")

Fig_UCEC_lymph_BPRNACanProMet <- ggscatter(data.frame(a), x = "HE", y = "lymph_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "UCEC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.08)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.235, y = 0.08, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_UCEC_BPRNACanProMet), as.matrix(HE_UCEC_modif$Lymphocytes))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(lymph_UCEC_BPRNACanProMet), as.matrix(HE_UCEC_modif$Lymphocytes))$p.value, 13)), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.07, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_UCEC_BPRNACanProMet) - as.matrix(HE_UCEC_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.06, label = paste("n = ", nrow(UCEC_BPRNACanProMet_decon)), size = 4)


lymph_UCEC_BPRNACan3DProMet <- UCEC_BPRNACan3DProMet_decon$B + UCEC_BPRNACan3DProMet_decon$CD4 + UCEC_BPRNACan3DProMet_decon$CD8 + UCEC_BPRNACan3DProMet_decon$NK

a <- cbind(lymph_UCEC_BPRNACan3DProMet, HE_UCEC_modif$Lymphocytes)
colnames(a) <- c("lymph_fractions", "HE")

Fig_UCEC_lymph_BPRNACan3DProMet <- ggscatter(data.frame(a), x = "HE", y = "lymph_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "UCEC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.08)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.235, y = 0.08, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_UCEC_BPRNACan3DProMet), as.matrix(HE_UCEC_modif$Lymphocytes))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(lymph_UCEC_BPRNACan3DProMet), as.matrix(HE_UCEC_modif$Lymphocytes))$p.value, 13)), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.07, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_UCEC_BPRNACan3DProMet) - as.matrix(HE_UCEC_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.06, label = paste("n = ", nrow(UCEC_BPRNACanProMet_decon)), size = 4)


#### Macro

Macro_UCEC_BPRNACan <- UCEC_BPRNACan_decon$M0 + UCEC_BPRNACan_decon$M1 + UCEC_BPRNACan_decon$M2 + UCEC_BPRNACan_decon$Mono

a <- cbind(Macro_UCEC_BPRNACan, HE_UCEC_modif$Macrophages)
colnames(a) <- c("Macro_fractions", "HE")

Fig_UCEC_Macro_BPRNACan <- ggscatter(data.frame(a), x = "HE", y = "Macro_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "UCEC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.4)) + scale_y_continuous(name = NULL, limits = c(0, 0.06)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.175, y = 0.06, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_UCEC_BPRNACan), as.matrix(HE_UCEC_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.11, y = 0.0526, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_UCEC_BPRNACan) - as.matrix(HE_UCEC_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.08, y = 0.045, label = paste("n = ", nrow(UCEC_BPRNACan_decon)), size = 4)



Macro_UCEC_BPRNACanProMet <- UCEC_BPRNACanProMet_decon$M0 + UCEC_BPRNACanProMet_decon$M1 + UCEC_BPRNACanProMet_decon$M2 + UCEC_BPRNACanProMet_decon$Mono

a <- cbind(Macro_UCEC_BPRNACanProMet, HE_UCEC_modif$Macrophages)
colnames(a) <- c("Macro_fractions", "HE")

Fig_UCEC_Macro_BPRNACanProMet <- ggscatter(data.frame(a), x = "HE", y = "Macro_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "UCEC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.4)) + scale_y_continuous(name = NULL, limits = c(0, 0.06)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.185, y = 0.06, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_UCEC_BPRNACanProMet), as.matrix(HE_UCEC_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.11, y = 0.0526, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_UCEC_BPRNACanProMet) - as.matrix(HE_UCEC_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.08, y = 0.045, label = paste("n = ", nrow(UCEC_BPRNACan_decon)), size = 4)

Macro_UCEC_BPRNACan3DProMet <- UCEC_BPRNACan3DProMet_decon$M0 + UCEC_BPRNACan3DProMet_decon$M1 + UCEC_BPRNACan3DProMet_decon$M2 + UCEC_BPRNACan3DProMet_decon$Mono

a <- cbind(Macro_UCEC_BPRNACan3DProMet, HE_UCEC_modif$Macrophages)
colnames(a) <- c("Macro_fractions", "HE")

Fig_UCEC_Macro_BPRNACan3DProMet <- ggscatter(data.frame(a), x = "HE", y = "Macro_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "UCEC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.4)) + scale_y_continuous(name = NULL, limits = c(0, 0.06)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.185, y = 0.06, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_UCEC_BPRNACan3DProMet), as.matrix(HE_UCEC_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.11, y = 0.0526, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_UCEC_BPRNACan3DProMet) - as.matrix(HE_UCEC_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.08, y = 0.045, label = paste("n = ", nrow(UCEC_BPRNACan_decon)), size = 4)

#### Neutrophis

a <- cbind(UCEC_BPRNACan_decon$Neu, HE_UCEC_modif$Neutrophils)
colnames(a) <- c("Neu_fractions", "HE")

Fig_UCEC_Neu_BPRNACan <- ggscatter(data.frame(a), x = "HE", y = "Neu_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "UCEC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.006)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.015, y = 0.006, label = paste("italic(r)==", round(cor.test(as.matrix(UCEC_BPRNACan_decon$Neu), as.matrix(HE_UCEC_modif$Neutrophils))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.009, y = 0.00525, label = paste("RMSE =", round(sqrt(mean((as.matrix(UCEC_BPRNACan_decon$Neu) - as.matrix(HE_UCEC_modif$Neutrophils))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.0065, y = 0.0046, label = paste("n = ", nrow(UCEC_BPRNACan_decon)), size = 4)


a <- cbind(UCEC_BPRNACanProMet_decon$Neu, HE_UCEC_modif$Neutrophils)
colnames(a) <- c("Neu_fractions", "HE")

Fig_UCEC_Neu_BPRNACanProMet <- ggscatter(data.frame(a[-155, ]), x = "HE", y = "Neu_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "UCEC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.006)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.015, y = 0.006, label = paste("italic(r)==", round(cor.test(as.matrix(UCEC_BPRNACanProMet_decon$Neu), as.matrix(HE_UCEC_modif$Neutrophils))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.0105, y = 0.00525, label = paste("RMSE =", round(sqrt(mean((as.matrix(UCEC_BPRNACanProMet_decon$Neu) - as.matrix(HE_UCEC_modif$Neutrophils))^2, na.rm = T)), 5)), parse = F, size = 4) + annotate("text", x = 0.0065, y = 0.0046, label = paste("n = ", nrow(UCEC_BPRNACan_decon)), size = 4)


a <- cbind(UCEC_BPRNACan3DProMet_decon$Neu, HE_UCEC_modif$Neutrophils)
colnames(a) <- c("Neu_fractions", "HE")

Fig_UCEC_Neu_BPRNACan3DProMet <- ggscatter(data.frame(a), x = "HE", y = "Neu_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "UCEC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.008)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.015, y = 0.008, label = paste("italic(r)==", round(cor.test(as.matrix(UCEC_BPRNACan3DProMet_decon$Neu), as.matrix(HE_UCEC_modif$Neutrophils))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(UCEC_BPRNACan3DProMet_decon$Neu), as.matrix(HE_UCEC_modif$Neutrophils))$p.value, 15)), parse = TRUE, size = 4) + annotate("text", x = 0.0105, y = 0.007, label = paste("RMSE =", round(sqrt(mean((as.matrix(UCEC_BPRNACan3DProMet_decon$Neu) - as.matrix(HE_UCEC_modif$Neutrophils))^2, na.rm = T)), 3)), parse = F, size = 4) + annotate("text", x = 0.0065, y = 0.006, label = paste("n = ", nrow(UCEC_BPRNACan_decon)), size = 4)

##### DNA methylation Part #####

#### lympho

lymph_methy <- UCEC_methy_decon$B + UCEC_methy_decon$CD4 + UCEC_methy_decon$CD8 + UCEC_methy_decon$Treg + UCEC_methy_decon$NK

a <- cbind(lymph_methy, HE_UCEC_modif$Lymphocytes)
colnames(a) <- c("lymph_methy", "HE_lympho")

Fig_UCEC_lymph_BPmetCan <- ggscatter(data.frame(a), x = "HE_lympho", y = "lymph_methy", size = 2, add.params = list(color = "black"), color = "chocolate", title = "UCEC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_methy), as.matrix(HE_UCEC_modif$Lymphocytes))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_methy) - as.matrix(HE_UCEC_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(UCEC_methy_decon)), size = 4)


#### Macro

Macro_Methy <- UCEC_methy_decon$M0 + UCEC_methy_decon$M1 + UCEC_methy_decon$M2 + UCEC_methy_decon$Mono

a <- cbind(Macro_Methy, HE_UCEC_modif$Macrophages)
colnames(a) <- c("Macro_Methy", "HE_macro")

Fig_UCEC_Macro_BPmetCan <- ggscatter(data.frame(a), x = "HE_macro", y = "Macro_Methy", size = 2, add.params = list(color = "black"), color = "chocolate", title = "UCEC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_Methy), as.matrix(HE_UCEC_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_Methy) - as.matrix(HE_UCEC_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(UCEC_methy_decon)), size = 4)

#### Neu

a <- cbind(UCEC_methy_decon$Neu, HE_UCEC_modif$Neutrophils)
colnames(a) <- c("Neu_Methy", "HE_neu")

Fig_UCEC_Neu_BPmetCan <- ggscatter(data.frame(a), x = "HE_neu", y = "Neu_Methy", size = 2, add.params = list(color = "black"), color = "chocolate", title = "UCEC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.8)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.0135, y = 0.8, label = paste("italic(r)==", round(cor.test(as.matrix(UCEC_methy_decon$Neu), as.matrix(HE_UCEC_modif$Neutrophils))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(UCEC_methy_decon$Neu), as.matrix(HE_UCEC_modif$Neutrophils))$p.value, 10)), parse = TRUE, size = 4) + annotate("text", x = 0.0085, y = 0.7, label = paste("RMSE =", round(sqrt(mean((as.matrix(UCEC_methy_decon$Neu) - as.matrix(HE_UCEC_modif$Neutrophils))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.0057, y = 0.6, label = paste("n = ", nrow(UCEC_methy_decon)), size = 4)


##### Correlation between DNA methylation and expression deconvolution #####

## Tumor purity

a <- cbind(UCEC_BPRNACan_decon$cancer, UCEC_methy_decon$cancer)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_UCEC_TM_BPRNACan_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", size = 2, add.params = list(color = "black"), color = "chocolate", title = "UCEC") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL, limits = c(0, 1)) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", label.x = 0, label.y = 1, size = 6)

a <- cbind(UCEC_BPRNACanProMet_decon$cancer, UCEC_methy_decon$cancer)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_UCEC_TM_BPRNACanProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", size = 2, add.params = list(color = "black"), color = "chocolate", title = "UCEC") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL, limits = c(0, 1)) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", label.x = 0, label.y = 1, size = 6)

a <- cbind(UCEC_BPRNACan3DProMet_decon$cancer, UCEC_methy_decon$cancer)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_UCEC_TM_BPRNACan3DProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", size = 2, add.params = list(color = "black"), color = "chocolate", title = "UCEC") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL, limits = c(0, 1)) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", label.x = 0, label.y = 1, size = 6)


## Lymphcytes

a <- cbind(lymph_UCEC_BPRNACan, lymph_methy)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_UCEC_lymph_BPRNACan_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "UCEC") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")

a <- cbind(lymph_UCEC_BPRNACanProMet, lymph_methy)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_UCEC_lymph_BPRNACanProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "UCEC") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")

a <- cbind(lymph_UCEC_BPRNACan3DProMet, lymph_methy)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_UCEC_lymph_BPRNACan3DProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "UCEC") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")


## Macrophages

a <- cbind(Macro_UCEC_BPRNACan, Macro_Methy)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_UCEC_macro_BPRNACan_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "UCEC") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")


a <- cbind(Macro_UCEC_BPRNACanProMet, Macro_Methy)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_UCEC_macro_BPRNACanProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "UCEC") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")

a <- cbind(Macro_UCEC_BPRNACan3DProMet, Macro_Methy)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_UCEC_macro_BPRNACan3DProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "UCEC") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")


## Netrophils

a <- cbind(UCEC_BPRNACan_decon$Neu, UCEC_methy_decon$Neu)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_UCEC_Neu_BPRNACan_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "UCEC") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")


a <- cbind(UCEC_BPRNACanProMet_decon$Neu, UCEC_methy_decon$Neu)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_UCEC_Neu_BPRNACanProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "UCEC") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")

a <- cbind(UCEC_BPRNACan3DProMet_decon$Neu, UCEC_methy_decon$Neu)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_UCEC_Neu_BPRNACan3DProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "UCEC") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")



###############################################
###### average of Methylation and RNAseq ######
###############################################

#### Tumor purity

a <- cbind(rowMeans(cbind(UCEC_BPRNACan_decon$cancer, UCEC_methy_decon$cancer)), Facs_UCEC_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_UCEC_BPRNACan_avrage <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "UCEC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0, 1.2), breaks = seq(0.0, 1.2, 0.2)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.45, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(rowMeans(cbind(UCEC_BPRNACan_decon$cancer, UCEC_methy_decon$cancer))), as.matrix(Facs_UCEC_modif$CPE))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.05, label = paste("RMSE =", round(sqrt(mean((as.matrix(rowMeans(cbind(UCEC_BPRNACan_decon$cancer, UCEC_methy_decon$cancer))) - as.matrix(Facs_UCEC_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 0.9, label = paste("n = ", nrow(UCEC_BPRNACan_decon)), size = 4)


a <- cbind(rowMeans(cbind(UCEC_BPRNACanProMet_decon$cancer, UCEC_methy_decon$cancer)), Facs_UCEC_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_UCEC_BPRNACanProMet_avrage <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "UCEC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0, 1.2), breaks = seq(0.0, 1.2, 0.2)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.45, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(rowMeans(cbind(UCEC_BPRNACanProMet_decon$cancer, UCEC_methy_decon$cancer))), as.matrix(Facs_UCEC_modif$CPE))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.05, label = paste("RMSE =", round(sqrt(mean((as.matrix(rowMeans(cbind(UCEC_BPRNACanProMet_decon$cancer, UCEC_methy_decon$cancer))) - as.matrix(Facs_UCEC_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 0.9, label = paste("n = ", nrow(UCEC_BPRNACan_decon)), size = 4)


a <- cbind(rowMeans(cbind(UCEC_BPRNACan3DProMet_decon$cancer, UCEC_methy_decon$cancer)), Facs_UCEC_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_UCEC_BPRNACan3DProMet_avrage <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "UCEC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0, 1.2), breaks = seq(0.0, 1.2, 0.2)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.45, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(rowMeans(cbind(UCEC_BPRNACan3DProMet_decon$cancer, UCEC_methy_decon$cancer))), as.matrix(Facs_UCEC_modif$CPE))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.05, label = paste("RMSE =", round(sqrt(mean((as.matrix(rowMeans(cbind(UCEC_BPRNACan3DProMet_decon$cancer, UCEC_methy_decon$cancer))) - as.matrix(Facs_UCEC_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 0.9, label = paste("n = ", nrow(UCEC_BPRNACan_decon)), size = 4)


#### Lymphocytes

lymph_UCEC_BPRNACan_avr <- rowMeans(cbind(UCEC_BPRNACan_decon$B + UCEC_BPRNACan_decon$NK + UCEC_BPRNACan_decon$CD4 + UCEC_BPRNACan_decon$CD8, UCEC_methy_decon$B + UCEC_methy_decon$CD4 + UCEC_methy_decon$CD8 + UCEC_methy_decon$NK + UCEC_methy_decon$Treg))

a <- cbind(lymph_UCEC_BPRNACan_avr, HE_UCEC_modif$Lymphocytes)
colnames(a) <- c("Cancer_cell_fractions", "Lymphocytes")

Fig_UCEC_lymph_BPRNACan_avrage <- ggscatter(data.frame(a), x = "Lymphocytes", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "UCEC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_UCEC_BPRNACan_avr), as.matrix(HE_UCEC_modif$Lymphocytes))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_UCEC_BPRNACan_avr) - as.matrix(HE_UCEC_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(UCEC_methy_decon)), size = 4)


lymph_UCEC_BPRNACanProMet_avr <- rowMeans(cbind(UCEC_BPRNACanProMet_decon$B + UCEC_BPRNACanProMet_decon$NK + UCEC_BPRNACanProMet_decon$CD4 + UCEC_BPRNACanProMet_decon$CD8, UCEC_methy_decon$B + UCEC_methy_decon$CD4 + UCEC_methy_decon$CD8 + UCEC_methy_decon$NK + UCEC_methy_decon$Treg))

a <- cbind(lymph_UCEC_BPRNACanProMet_avr, HE_UCEC_modif$Lymphocytes)
colnames(a) <- c("Cancer_cell_fractions", "Lymphocytes")

Fig_UCEC_lymph_BPRNACanProMet_avrage <- ggscatter(data.frame(a), x = "Lymphocytes", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "UCEC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_UCEC_BPRNACanProMet_avr), as.matrix(HE_UCEC_modif$Lymphocytes))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_UCEC_BPRNACanProMet_avr) - as.matrix(HE_UCEC_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(UCEC_methy_decon)), size = 4)

lymph_UCEC_BPRNACan3DProMet_avr <- rowMeans(cbind(UCEC_BPRNACan3DProMet_decon$B + UCEC_BPRNACan3DProMet_decon$NK + UCEC_BPRNACan3DProMet_decon$CD4 + UCEC_BPRNACan3DProMet_decon$CD8, UCEC_methy_decon$B + UCEC_methy_decon$CD4 + UCEC_methy_decon$CD8 + UCEC_methy_decon$NK + UCEC_methy_decon$Treg))

a <- cbind(lymph_UCEC_BPRNACan3DProMet_avr, HE_UCEC_modif$Lymphocytes)
colnames(a) <- c("Cancer_cell_fractions", "Lymphocytes")

Fig_UCEC_lymph_BPRNACan3DProMet_avrage <- ggscatter(data.frame(a), x = "Lymphocytes", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "UCEC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_UCEC_BPRNACan3DProMet_avr), as.matrix(HE_UCEC_modif$Lymphocytes))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_UCEC_BPRNACan3DProMet_avr) - as.matrix(HE_UCEC_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(UCEC_methy_decon)), size = 4)

#### Macrophages

Macro_UCEC_BPRNACan_avr <- rowMeans(cbind(UCEC_BPRNACan_decon$M0 + UCEC_BPRNACan_decon$M1 + UCEC_BPRNACan_decon$M2 + UCEC_BPRNACan_decon$Mono, UCEC_methy_decon$M0 + UCEC_methy_decon$M1 + UCEC_methy_decon$M2 + UCEC_methy_decon$Mono))

a <- cbind(Macro_UCEC_BPRNACan_avr, HE_UCEC_modif$Macrophages)
colnames(a) <- c("Cancer_cell_fractions", "Macrophages")

Fig_UCEC_Macro_BPRNACan_avrage <- ggscatter(data.frame(a), x = "Macrophages", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "UCEC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_UCEC_BPRNACan_avr), as.matrix(HE_UCEC_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_UCEC_BPRNACan_avr) - as.matrix(HE_UCEC_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(UCEC_methy_decon)), size = 4)

Macro_UCEC_BPRNACanProMet_avr <- rowMeans(cbind(UCEC_BPRNACanProMet_decon$M0 + UCEC_BPRNACanProMet_decon$M1 + UCEC_BPRNACanProMet_decon$M2 + UCEC_BPRNACanProMet_decon$Mono, UCEC_methy_decon$M0 + UCEC_methy_decon$M1 + UCEC_methy_decon$M2 + UCEC_methy_decon$Mono))

a <- cbind(Macro_UCEC_BPRNACanProMet_avr, HE_UCEC_modif$Macrophages)
colnames(a) <- c("Cancer_cell_fractions", "Macrophages")

Fig_UCEC_Macro_BPRNACanProMet_avrage <- ggscatter(data.frame(a), x = "Macrophages", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "UCEC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_UCEC_BPRNACanProMet_avr), as.matrix(HE_UCEC_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_UCEC_BPRNACanProMet_avr) - as.matrix(HE_UCEC_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(UCEC_methy_decon)), size = 4)


Macro_UCEC_BPRNACan3DProMet_avr <- rowMeans(cbind(UCEC_BPRNACan3DProMet_decon$M0 + UCEC_BPRNACan3DProMet_decon$M1 + UCEC_BPRNACan3DProMet_decon$M2 + UCEC_BPRNACan3DProMet_decon$Mono, UCEC_methy_decon$M0 + UCEC_methy_decon$M1 + UCEC_methy_decon$M2 + UCEC_methy_decon$Mono))

a <- cbind(Macro_UCEC_BPRNACan3DProMet_avr, HE_UCEC_modif$Macrophages)
colnames(a) <- c("Cancer_cell_fractions", "Macrophages")

Fig_UCEC_Macro_BPRNACan3DProMet_avrage <- ggscatter(data.frame(a), x = "Macrophages", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "UCEC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_UCEC_BPRNACan3DProMet_avr), as.matrix(HE_UCEC_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_UCEC_BPRNACan3DProMet_avr) - as.matrix(HE_UCEC_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(UCEC_methy_decon)), size = 4)


#### Neutrophils

a <- cbind(rowMeans(cbind(UCEC_BPRNACan_decon$Neu, UCEC_methy_decon$Neu)), HE_UCEC_modif$Neutrophils)
colnames(a) <- c("Cancer_cell_fractions", "Neutrophils")

Fig_UCEC_Neu_BPRNACan_avrage <- ggscatter(data.frame(a), x = "Neutrophils", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "UCEC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.4)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.012, y = 0.4, label = paste("italic(r)==", round(cor.test(as.matrix(rowMeans(cbind(UCEC_BPRNACan_decon$Neu, UCEC_methy_decon$Neu))), as.matrix(HE_UCEC_modif$Neutrophils))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(rowMeans(cbind(UCEC_BPRNACan_decon$Neu, UCEC_methy_decon$Neu))), as.matrix(HE_UCEC_modif$Neutrophils))$p.value, 9)), parse = TRUE, size = 4) + annotate("text", x = 0.008, y = 0.35, label = paste("RMSE =", round(sqrt(mean((as.matrix(rowMeans(cbind(UCEC_BPRNACan_decon$Neu, UCEC_methy_decon$Neu))) - as.matrix(HE_UCEC_modif$Neutrophils))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.0051, y = 0.3, label = paste("n = ", nrow(UCEC_methy_decon)), size = 4)

a <- cbind(rowMeans(cbind(UCEC_BPRNACanProMet_decon$Neu, UCEC_methy_decon$Neu)), HE_UCEC_modif$Neutrophils)
colnames(a) <- c("Cancer_cell_fractions", "Neutrophils")

Fig_UCEC_Neu_BPRNACanProMet_avrage <- ggscatter(data.frame(a), x = "Neutrophils", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "UCEC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.4)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.012, y = 0.4, label = paste("italic(r)==", round(cor.test(as.matrix(rowMeans(cbind(UCEC_BPRNACanProMet_decon$Neu, UCEC_methy_decon$Neu))), as.matrix(HE_UCEC_modif$Neutrophils))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(rowMeans(cbind(UCEC_BPRNACanProMet_decon$Neu, UCEC_methy_decon$Neu))), as.matrix(HE_UCEC_modif$Neutrophils))$p.value, 9)), parse = TRUE, size = 4) + annotate("text", x = 0.008, y = 0.35, label = paste("RMSE =", round(sqrt(mean((as.matrix(rowMeans(cbind(UCEC_BPRNACanProMet_decon$Neu, UCEC_methy_decon$Neu))) - as.matrix(HE_UCEC_modif$Neutrophils))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.0051, y = 0.3, label = paste("n = ", nrow(UCEC_methy_decon)), size = 4)

a <- cbind(rowMeans(cbind(UCEC_BPRNACan3DProMet_decon$Neu, UCEC_methy_decon$Neu)), HE_UCEC_modif$Neutrophils)
colnames(a) <- c("Cancer_cell_fractions", "Neutrophils")

Fig_UCEC_Neu_BPRNACan3DProMet_avrage <- ggscatter(data.frame(a), x = "Neutrophils", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "UCEC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.4)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.012, y = 0.4, label = paste("italic(r)==", round(cor.test(as.matrix(rowMeans(cbind(UCEC_BPRNACan3DProMet_decon$Neu, UCEC_methy_decon$Neu))), as.matrix(HE_UCEC_modif$Neutrophils))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(rowMeans(cbind(UCEC_BPRNACan3DProMet_decon$Neu, UCEC_methy_decon$Neu))), as.matrix(HE_UCEC_modif$Neutrophils))$p.value, 9)), parse = TRUE, size = 4) + annotate("text", x = 0.008, y = 0.35, label = paste("RMSE =", round(sqrt(mean((as.matrix(rowMeans(cbind(UCEC_BPRNACan3DProMet_decon$Neu, UCEC_methy_decon$Neu))) - as.matrix(HE_UCEC_modif$Neutrophils))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.0051, y = 0.3, label = paste("n = ", nrow(UCEC_methy_decon)), size = 4)
```

```{r}
#### BPRNACan3D

Lym_UCEC_3DRNA <- cbind(lymph_UCEC_BPRNACan3DProMet, HE_UCEC_modif$Lymphocytes)
colnames(Lym_UCEC_3DRNA) <- c("Cancer_cell_fractions", "Lymphocytes")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((lymph_UCEC_BPRNACan3DProMet - HE_UCEC_modif$Lymphocytes)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Lym_UCEC_3DRNA <- ggplot(as.data.frame(Lym_UCEC_3DRNA), aes(x = Lymphocytes, y = Cancer_cell_fractions)) +
  geom_point(colour = c("darkslategrey")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"BPRNACan3D") +
  scale_x_continuous(name = NULL, limits = c(0, max(Lym_UCEC_3DRNA))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Lym_UCEC_3DRNA))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)

Macro_UCEC_3DRNA <- cbind(Macro_UCEC_BPRNACan3DProMet, HE_UCEC_modif$Macrophages)
colnames(Macro_UCEC_3DRNA) <- c("Cancer_cell_fractions", "Macrophages")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((Macro_UCEC_BPRNACan3DProMet - HE_UCEC_modif$Macrophages)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Macro_UCEC_3DRNA <- ggplot(as.data.frame(Macro_UCEC_3DRNA), aes(x = Macrophages, y = Cancer_cell_fractions)) +
  geom_point(colour = c("coral")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"BPRNACan3D") +
  scale_x_continuous(name = NULL, limits = c(0, max(Macro_UCEC_3DRNA))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Macro_UCEC_3DRNA))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)


Neu_UCEC_3DRNA <- cbind(UCEC_BPRNACan3DProMet_decon$Neu, HE_UCEC_modif$Neutrophils)
colnames(Neu_UCEC_3DRNA) <- c("Cancer_cell_fractions", "Neutrophils")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((UCEC_BPRNACan3DProMet_decon$Neu - HE_UCEC_modif$Neutrophils)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Neu_UCEC_3DRNA <- ggplot(as.data.frame(Neu_UCEC_3DRNA), aes(x = Neutrophils, y = Cancer_cell_fractions)) +
  geom_point(colour = c("green")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"BPRNACan3D") +
  scale_x_continuous(name = NULL, limits = c(0, max(Neu_UCEC_3DRNA))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Neu_UCEC_3DRNA))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)


#### BPmetCan

#### lympho

Lym_UCEC_methy <- cbind(lymph_methy, HE_UCEC_modif$Lymphocytes)
colnames(Lym_UCEC_methy) <- c("Cancer_cell_fractions", "Lymphocytes")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((Lym_UCEC_methy - HE_UCEC_modif$Lymphocytes)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Lym_UCEC_BPmetCan <- ggplot(as.data.frame(Lym_UCEC_methy), aes(x = Lymphocytes, y = Cancer_cell_fractions)) +
  geom_point(colour = c("darkslategrey")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"BPmetCan") +
  scale_x_continuous(name = NULL, limits = c(0, max(Lym_UCEC_methy))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Lym_UCEC_methy))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)

#### Macro

Macro_Methy <- UCEC_methy_decon$M0 + UCEC_methy_decon$M1 + UCEC_methy_decon$M2 + UCEC_methy_decon$Mono

Macro_UCEC_methy <- cbind(Macro_Methy, HE_UCEC_modif$Macrophages)
colnames(Macro_UCEC_methy) <- c("Cancer_cell_fractions", "Macrophages")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((Macro_UCEC_methy - HE_UCEC_modif$Macrophages)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Macro_UCEC_BPmetCan <- ggplot(as.data.frame(Macro_UCEC_methy), aes(x = Macrophages, y = Cancer_cell_fractions)) +
  geom_point(colour = c("coral")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"BPmetCan") +
  scale_x_continuous(name = NULL, limits = c(0, max(Macro_Methy))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Macro_Methy))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)


#### Neu

Neu_UCEC_methy <- cbind(UCEC_methy_decon$Neu, HE_UCEC_modif$Neutrophils)
colnames(Neu_UCEC_methy) <- c("Cancer_cell_fractions", "Neutrophils")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((UCEC_methy_decon$Neu - HE_UCEC_modif$Neutrophils)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Neu_UCEC_BPmetCan <- ggplot(as.data.frame(Neu_UCEC_methy), aes(x = Neutrophils, y = Cancer_cell_fractions)) +
  geom_point(colour = c("green")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"BPmetCan") + 
  scale_x_continuous(name = NULL, limits = c(0, max(Neu_UCEC_methy))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Neu_UCEC_methy))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)



#### avrg

Lym_UCEC_avrg <- cbind(lymph_UCEC_BPRNACan_avr, HE_UCEC_modif$Lymphocytes)
colnames(Lym_UCEC_avrg) <- c("Cancer_cell_fractions", "Lymphocytes")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((lymph_UCEC_BPRNACan_avr - HE_UCEC_modif$Lymphocytes)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Lym_UCEC_avrg <- ggplot(as.data.frame(Lym_UCEC_avrg), aes(x = Lymphocytes, y = Cancer_cell_fractions)) +
  geom_point(colour = c("darkslategrey")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"Meth + RNA") + 
  scale_x_continuous(name = NULL, limits = c(0, max(Lym_UCEC_avrg))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Lym_UCEC_avrg))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)


Macro_UCEC_avrg <- cbind(Macro_UCEC_BPRNACan_avr, HE_UCEC_modif$Macrophages)
colnames(Macro_UCEC_avrg) <- c("Cancer_cell_fractions", "Macrophages")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((Macro_UCEC_BPRNACan_avr - HE_UCEC_modif$Macrophages)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Macro_UCEC_avrg <- ggplot(as.data.frame(Macro_UCEC_avrg), aes(x = Macrophages, y = Cancer_cell_fractions)) +
  geom_point(colour = c("coral")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"Meth + RNA") +
  scale_x_continuous(name = NULL, limits = c(0, max(Macro_UCEC_avrg))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Macro_UCEC_avrg))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)

Neu_UCEC_avrg <- cbind(rowMeans(cbind(UCEC_BPRNACan_decon$Neu, UCEC_methy_decon$Neu)), HE_UCEC_modif$Neutrophils)
colnames(Neu_UCEC_avrg) <- c("Cancer_cell_fractions", "Neutrophils")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean(rowMeans(cbind(UCEC_BPRNACan_decon$Neu, UCEC_methy_decon$Neu) - HE_UCEC_modif$Neutrophils)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Neu_UCEC_avrg <- ggplot(as.data.frame(Neu_UCEC_avrg), aes(x = Neutrophils, y = Cancer_cell_fractions)) +
  geom_point(colour = c("green")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"Meth + RNA") + 
  scale_x_continuous(name = NULL, limits = c(0, max(Neu_UCEC_avrg))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Neu_UCEC_avrg))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)



lymph = ggarrange(fig_Lym_UCEC_3DRNA, fig_Lym_UCEC_BPmetCan, fig_Lym_UCEC_avrg, ncol = 3, nrow = 1, labels = "a", font.label = list(size = 20, color = "black"), align = "hv")
neutro = ggarrange(fig_Neu_UCEC_3DRNA, fig_Neu_UCEC_BPmetCan, fig_Neu_UCEC_avrg, ncol = 3, nrow = 1, labels = "b", font.label = list(size = 20, color = "black"), align = "hv")
macro = ggarrange(fig_Macro_UCEC_3DRNA, fig_Macro_UCEC_BPmetCan, fig_Macro_UCEC_avrg, ncol = 3, nrow = 1, labels = "c", font.label = list(size = 20, color = "black"), align = "hv")


All_UCEC <- ggarrange(lymph, neutro, macro, ncol = 1, nrow = 3, font.label = list(size = 20, color = "black"), align = "hv")


All_UCEC <- annotate_figure(All_UCEC,
  left = text_grob("Estimated fractions", color = "black", size = 20, rot = 90),
  bottom = text_grob("H&E estimates", color = "black", size = 20)
  
)

All_UCEC
```
RNA, methylation, and averaged values of correlation across a : lymphocytes, b: neutrophils, c : macrophages, using the BPRNACan3D and BPMetCan signatures on EpiDish.

## CESC

```{r}

CESC_methy_decon <- read.table("/mnt/SERVER-CRCT-STORAGE/CRCT21/Private/Julien/gemdecan/data/meth/CESC.txt", sep = "\t", header = T)

Facs_CESC <- Aran_all_facs[Aran_all_facs$Cancer_type == "CESC", ]

HE_CESC <- HE_all_TCGA[HE_all_TCGA$Study == "CESC", ]

Facs_CESC_modif <- Facs_CESC[Facs_CESC$CPE != "NaN", ]

Comm_samples <- Reduce(intersect, list(HE_CESC$ParticipantBarcode, Facs_CESC_modif$Sample_ID, tcga_deconv$Samples, rownames(CESC_methy_decon)))

Facs_CESC_modif <- Facs_CESC_modif %>% .[.$Sample_ID %in% Comm_samples, ]

HE_CESC_modif <- HE_CESC %>%
  .[.$ParticipantBarcode %in% Comm_samples, ] %>%
  .[order(.$ParticipantBarcode), ]

CESC_methy_decon <- CESC_methy_decon[Comm_samples, ] %>% 
  rownames_to_column() 
CESC_methy_decon <- CESC_methy_decon[order(CESC_methy_decon$rowname), ]
rownames(CESC_methy_decon) <- CESC_methy_decon$rowname
CESC_methy_decon <- CESC_methy_decon[,-1]

CESC_RNA_decon <- tcga_deconv %>% filter(Samples %in% Comm_samples)

###################################
##### Estimating Tumor Purity #####
###################################


CESC_BPRNACan_decon <- CESC_RNA_decon %>% select(colnames(CESC_RNA_decon)[grepl("Epidish_BPRNACan_", colnames(CESC_RNA_decon))])
colnames(CESC_BPRNACan_decon) <- colnames(CESC_BPRNACan_decon) %>% str_remove_all("Epidish_BPRNACan_")

a <- cbind(CESC_BPRNACan_decon$cancer, Facs_CESC_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_CESC_BPRNACan <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "CESC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0.8, 1.2), breaks = seq(0.0, 1.2, 0.1)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.42, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(CESC_BPRNACan_decon$cancer), as.matrix(Facs_CESC_modif$CPE))$est, 2), "~','", "~italic(P)<", round(cor.test(as.matrix(CESC_BPRNACan_decon$cancer), as.matrix(Facs_CESC_modif$CPE))$p.value, 14)), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.15, label = paste("RMSE =", round(sqrt(mean((as.matrix(CESC_BPRNACan_decon$cancer) - as.matrix(Facs_CESC_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 1.1, label = paste("n = ", nrow(CESC_BPRNACan_decon)), size = 4)


CESC_BPRNACanProMet_decon <- CESC_RNA_decon %>% select(colnames(CESC_RNA_decon)[grepl("Epidish_BPRNACanProMet_", colnames(CESC_RNA_decon))])
colnames(CESC_BPRNACanProMet_decon) <- colnames(CESC_BPRNACanProMet_decon) %>% str_remove_all("Epidish_BPRNACanProMet_")

a <- cbind(CESC_BPRNACanProMet_decon$cancer, Facs_CESC_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_CESC_BPRNACanProMet <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "CESC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0.8, 1.2), breaks = seq(0.0, 1.2, 0.1)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.45, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(CESC_BPRNACanProMet_decon$cancer), as.matrix(Facs_CESC_modif$CPE))$est, 2), "~','", "~italic(P)<", round(cor.test(as.matrix(CESC_BPRNACanProMet_decon$cancer), as.matrix(Facs_CESC_modif$CPE))$p.value, 14)), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.15, label = paste("RMSE =", round(sqrt(mean((as.matrix(CESC_BPRNACanProMet_decon$cancer) - as.matrix(Facs_CESC_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 1.1, label = paste("n = ", nrow(CESC_BPRNACanProMet_decon)), size = 4)


CESC_BPRNACan3DProMet_decon <- CESC_RNA_decon %>% select(colnames(CESC_RNA_decon)[grepl("Epidish_BPRNACan3DProMet_", colnames(CESC_RNA_decon))])
colnames(CESC_BPRNACan3DProMet_decon) <- colnames(CESC_BPRNACan3DProMet_decon) %>% str_remove_all("Epidish_BPRNACan3DProMet_")


a <- cbind(CESC_BPRNACan3DProMet_decon$cancer, Facs_CESC_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_CESC_BPRNACan3DProMet <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "CESC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0.8, 1.2), breaks = seq(0.0, 1.2, 0.1)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.52, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(CESC_BPRNACan3DProMet_decon$cancer), as.matrix(Facs_CESC_modif$CPE))$est, 2), "~','", "~italic(P)<", round(cor.test(as.matrix(CESC_BPRNACan3DProMet_decon$cancer), as.matrix(Facs_CESC_modif$CPE))$p.value, 14)), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.15, label = paste("RMSE =", round(sqrt(mean((as.matrix(CESC_BPRNACan3DProMet_decon$cancer) - as.matrix(Facs_CESC_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 1.1, label = paste("n = ", nrow(CESC_BPRNACan3DProMet_decon)), size = 4)

###### Methylation part

a <- cbind(CESC_methy_decon$cancer, Facs_CESC_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_CESC_BPmetCan <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "CESC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0, 1.2), breaks = seq(0.0, 1.2, 0.2)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.45, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(CESC_methy_decon$cancer), as.matrix(Facs_CESC_modif$CPE))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.05, label = paste("RMSE =", round(sqrt(mean((as.matrix(CESC_methy_decon$cancer) - as.matrix(Facs_CESC_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 0.9, label = paste("n = ", nrow(CESC_methy_decon)), size = 4)


###############################################################
##### Estimating Lymphocytes, Macrophages and Neutrophils #####
###############################################################

##### RNA expression Part #####

#### lymph

lymph_CESC_BPRNACan <- CESC_BPRNACan_decon$B + CESC_BPRNACan_decon$CD4 + CESC_BPRNACan_decon$CD8 + CESC_BPRNACan_decon$NK

a <- cbind(lymph_CESC_BPRNACan, HE_CESC_modif$Lymphocytes)
colnames(a) <- c("lymph_fractions", "HE")

Fig_CESC_lymph_BPRNACan <- ggscatter(data.frame(a), x = "HE", y = "lymph_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "CESC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.08)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.235, y = 0.08, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_CESC_BPRNACan), as.matrix(HE_CESC_modif$Lymphocytes))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.07, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_CESC_BPRNACan) - as.matrix(HE_CESC_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.06, label = paste("n = ", nrow(CESC_methy_decon)), size = 4)



lymph_CESC_BPRNACanProMet <- CESC_BPRNACanProMet_decon$B + CESC_BPRNACanProMet_decon$CD4 + CESC_BPRNACanProMet_decon$CD8 + CESC_BPRNACanProMet_decon$NK

a <- cbind(lymph_CESC_BPRNACanProMet, HE_CESC_modif$Lymphocytes)
colnames(a) <- c("lymph_fractions", "HE")

Fig_CESC_lymph_BPRNACanProMet <- ggscatter(data.frame(a), x = "HE", y = "lymph_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "CESC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.08)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.235, y = 0.08, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_CESC_BPRNACanProMet), as.matrix(HE_CESC_modif$Lymphocytes))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(lymph_CESC_BPRNACanProMet), as.matrix(HE_CESC_modif$Lymphocytes))$p.value, 13)), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.07, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_CESC_BPRNACanProMet) - as.matrix(HE_CESC_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.06, label = paste("n = ", nrow(CESC_BPRNACanProMet_decon)), size = 4)


lymph_CESC_BPRNACan3DProMet <- CESC_BPRNACan3DProMet_decon$B + CESC_BPRNACan3DProMet_decon$CD4 + CESC_BPRNACan3DProMet_decon$CD8 + CESC_BPRNACan3DProMet_decon$NK

a <- cbind(lymph_CESC_BPRNACan3DProMet, HE_CESC_modif$Lymphocytes)
colnames(a) <- c("lymph_fractions", "HE")

Fig_CESC_lymph_BPRNACan3DProMet <- ggscatter(data.frame(a), x = "HE", y = "lymph_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "CESC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.08)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.235, y = 0.08, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_CESC_BPRNACan3DProMet), as.matrix(HE_CESC_modif$Lymphocytes))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(lymph_CESC_BPRNACan3DProMet), as.matrix(HE_CESC_modif$Lymphocytes))$p.value, 13)), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.07, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_CESC_BPRNACan3DProMet) - as.matrix(HE_CESC_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.06, label = paste("n = ", nrow(CESC_BPRNACanProMet_decon)), size = 4)


#### Macro

Macro_CESC_BPRNACan <- CESC_BPRNACan_decon$M0 + CESC_BPRNACan_decon$M1 + CESC_BPRNACan_decon$M2 + CESC_BPRNACan_decon$Mono

a <- cbind(Macro_CESC_BPRNACan, HE_CESC_modif$Macrophages)
colnames(a) <- c("Macro_fractions", "HE")

Fig_CESC_Macro_BPRNACan <- ggscatter(data.frame(a), x = "HE", y = "Macro_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "CESC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.4)) + scale_y_continuous(name = NULL, limits = c(0, 0.06)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.175, y = 0.06, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_CESC_BPRNACan), as.matrix(HE_CESC_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.11, y = 0.0526, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_CESC_BPRNACan) - as.matrix(HE_CESC_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.08, y = 0.045, label = paste("n = ", nrow(CESC_BPRNACan_decon)), size = 4)



Macro_CESC_BPRNACanProMet <- CESC_BPRNACanProMet_decon$M0 + CESC_BPRNACanProMet_decon$M1 + CESC_BPRNACanProMet_decon$M2 + CESC_BPRNACanProMet_decon$Mono

a <- cbind(Macro_CESC_BPRNACanProMet, HE_CESC_modif$Macrophages)
colnames(a) <- c("Macro_fractions", "HE")

Fig_CESC_Macro_BPRNACanProMet <- ggscatter(data.frame(a), x = "HE", y = "Macro_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "CESC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.4)) + scale_y_continuous(name = NULL, limits = c(0, 0.06)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.185, y = 0.06, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_CESC_BPRNACanProMet), as.matrix(HE_CESC_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.11, y = 0.0526, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_CESC_BPRNACanProMet) - as.matrix(HE_CESC_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.08, y = 0.045, label = paste("n = ", nrow(CESC_BPRNACan_decon)), size = 4)

Macro_CESC_BPRNACan3DProMet <- CESC_BPRNACan3DProMet_decon$M0 + CESC_BPRNACan3DProMet_decon$M1 + CESC_BPRNACan3DProMet_decon$M2 + CESC_BPRNACan3DProMet_decon$Mono

a <- cbind(Macro_CESC_BPRNACan3DProMet, HE_CESC_modif$Macrophages)
colnames(a) <- c("Macro_fractions", "HE")

Fig_CESC_Macro_BPRNACan3DProMet <- ggscatter(data.frame(a), x = "HE", y = "Macro_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "CESC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.4)) + scale_y_continuous(name = NULL, limits = c(0, 0.06)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.185, y = 0.06, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_CESC_BPRNACan3DProMet), as.matrix(HE_CESC_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.11, y = 0.0526, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_CESC_BPRNACan3DProMet) - as.matrix(HE_CESC_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.08, y = 0.045, label = paste("n = ", nrow(CESC_BPRNACan_decon)), size = 4)

#### Neutrophis

a <- cbind(CESC_BPRNACan_decon$Neu, HE_CESC_modif$Neutrophils)
colnames(a) <- c("Neu_fractions", "HE")

Fig_CESC_Neu_BPRNACan <- ggscatter(data.frame(a), x = "HE", y = "Neu_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "CESC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.006)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.015, y = 0.006, label = paste("italic(r)==", round(cor.test(as.matrix(CESC_BPRNACan_decon$Neu), as.matrix(HE_CESC_modif$Neutrophils))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.009, y = 0.00525, label = paste("RMSE =", round(sqrt(mean((as.matrix(CESC_BPRNACan_decon$Neu) - as.matrix(HE_CESC_modif$Neutrophils))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.0065, y = 0.0046, label = paste("n = ", nrow(CESC_BPRNACan_decon)), size = 4)


a <- cbind(CESC_BPRNACanProMet_decon$Neu, HE_CESC_modif$Neutrophils)
colnames(a) <- c("Neu_fractions", "HE")

Fig_CESC_Neu_BPRNACanProMet <- ggscatter(data.frame(a[-155, ]), x = "HE", y = "Neu_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "CESC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.006)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.015, y = 0.006, label = paste("italic(r)==", round(cor.test(as.matrix(CESC_BPRNACanProMet_decon$Neu), as.matrix(HE_CESC_modif$Neutrophils))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.0105, y = 0.00525, label = paste("RMSE =", round(sqrt(mean((as.matrix(CESC_BPRNACanProMet_decon$Neu) - as.matrix(HE_CESC_modif$Neutrophils))^2, na.rm = T)), 5)), parse = F, size = 4) + annotate("text", x = 0.0065, y = 0.0046, label = paste("n = ", nrow(CESC_BPRNACan_decon)), size = 4)


a <- cbind(CESC_BPRNACan3DProMet_decon$Neu, HE_CESC_modif$Neutrophils)
colnames(a) <- c("Neu_fractions", "HE")

Fig_CESC_Neu_BPRNACan3DProMet <- ggscatter(data.frame(a), x = "HE", y = "Neu_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "CESC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.008)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.015, y = 0.008, label = paste("italic(r)==", round(cor.test(as.matrix(CESC_BPRNACan3DProMet_decon$Neu), as.matrix(HE_CESC_modif$Neutrophils))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(CESC_BPRNACan3DProMet_decon$Neu), as.matrix(HE_CESC_modif$Neutrophils))$p.value, 15)), parse = TRUE, size = 4) + annotate("text", x = 0.0105, y = 0.007, label = paste("RMSE =", round(sqrt(mean((as.matrix(CESC_BPRNACan3DProMet_decon$Neu) - as.matrix(HE_CESC_modif$Neutrophils))^2, na.rm = T)), 3)), parse = F, size = 4) + annotate("text", x = 0.0065, y = 0.006, label = paste("n = ", nrow(CESC_BPRNACan_decon)), size = 4)

##### DNA methylation Part #####

#### lympho

lymph_methy <- CESC_methy_decon$B + CESC_methy_decon$CD4 + CESC_methy_decon$CD8 + CESC_methy_decon$Treg + CESC_methy_decon$NK

a <- cbind(lymph_methy, HE_CESC_modif$Lymphocytes)
colnames(a) <- c("lymph_methy", "HE_lympho")

Fig_CESC_lymph_BPmetCan <- ggscatter(data.frame(a), x = "HE_lympho", y = "lymph_methy", size = 2, add.params = list(color = "black"), color = "chocolate", title = "CESC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_methy), as.matrix(HE_CESC_modif$Lymphocytes))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_methy) - as.matrix(HE_CESC_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(CESC_methy_decon)), size = 4)


#### Macro

Macro_Methy <- CESC_methy_decon$M0 + CESC_methy_decon$M1 + CESC_methy_decon$M2 + CESC_methy_decon$Mono

a <- cbind(Macro_Methy, HE_CESC_modif$Macrophages)
colnames(a) <- c("Macro_Methy", "HE_macro")

Fig_CESC_Macro_BPmetCan <- ggscatter(data.frame(a), x = "HE_macro", y = "Macro_Methy", size = 2, add.params = list(color = "black"), color = "chocolate", title = "CESC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_Methy), as.matrix(HE_CESC_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_Methy) - as.matrix(HE_CESC_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(CESC_methy_decon)), size = 4)

#### Neu

a <- cbind(CESC_methy_decon$Neu, HE_CESC_modif$Neutrophils)
colnames(a) <- c("Neu_Methy", "HE_neu")

Fig_CESC_Neu_BPmetCan <- ggscatter(data.frame(a), x = "HE_neu", y = "Neu_Methy", size = 2, add.params = list(color = "black"), color = "chocolate", title = "CESC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.8)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.0135, y = 0.8, label = paste("italic(r)==", round(cor.test(as.matrix(CESC_methy_decon$Neu), as.matrix(HE_CESC_modif$Neutrophils))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(CESC_methy_decon$Neu), as.matrix(HE_CESC_modif$Neutrophils))$p.value, 10)), parse = TRUE, size = 4) + annotate("text", x = 0.0085, y = 0.7, label = paste("RMSE =", round(sqrt(mean((as.matrix(CESC_methy_decon$Neu) - as.matrix(HE_CESC_modif$Neutrophils))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.0057, y = 0.6, label = paste("n = ", nrow(CESC_methy_decon)), size = 4)


##### Correlation between DNA methylation and expression deconvolution #####

## Tumor purity

a <- cbind(CESC_BPRNACan_decon$cancer, CESC_methy_decon$cancer)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_CESC_TM_BPRNACan_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", size = 2, add.params = list(color = "black"), color = "chocolate", title = "CESC") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL, limits = c(0, 1)) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", label.x = 0, label.y = 1, size = 6)

a <- cbind(CESC_BPRNACanProMet_decon$cancer, CESC_methy_decon$cancer)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_CESC_TM_BPRNACanProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", size = 2, add.params = list(color = "black"), color = "chocolate", title = "CESC") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL, limits = c(0, 1)) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", label.x = 0, label.y = 1, size = 6)

a <- cbind(CESC_BPRNACan3DProMet_decon$cancer, CESC_methy_decon$cancer)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_CESC_TM_BPRNACan3DProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", size = 2, add.params = list(color = "black"), color = "chocolate", title = "CESC") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL, limits = c(0, 1)) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", label.x = 0, label.y = 1, size = 6)


## Lymphcytes

a <- cbind(lymph_CESC_BPRNACan, lymph_methy)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_CESC_lymph_BPRNACan_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "CESC") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")

a <- cbind(lymph_CESC_BPRNACanProMet, lymph_methy)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_CESC_lymph_BPRNACanProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "CESC") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")

a <- cbind(lymph_CESC_BPRNACan3DProMet, lymph_methy)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_CESC_lymph_BPRNACan3DProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "CESC") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")


## Macrophages

a <- cbind(Macro_CESC_BPRNACan, Macro_Methy)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_CESC_macro_BPRNACan_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "CESC") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")


a <- cbind(Macro_CESC_BPRNACanProMet, Macro_Methy)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_CESC_macro_BPRNACanProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "CESC") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")

a <- cbind(Macro_CESC_BPRNACan3DProMet, Macro_Methy)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_CESC_macro_BPRNACan3DProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "CESC") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")


## Netrophils

a <- cbind(CESC_BPRNACan_decon$Neu, CESC_methy_decon$Neu)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_CESC_Neu_BPRNACan_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "CESC") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")


a <- cbind(CESC_BPRNACanProMet_decon$Neu, CESC_methy_decon$Neu)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_CESC_Neu_BPRNACanProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "CESC") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")

a <- cbind(CESC_BPRNACan3DProMet_decon$Neu, CESC_methy_decon$Neu)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_CESC_Neu_BPRNACan3DProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "CESC") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")



###############################################
###### average of Methylation and RNAseq ######
###############################################

#### Tumor purity

a <- cbind(rowMeans(cbind(CESC_BPRNACan_decon$cancer, CESC_methy_decon$cancer)), Facs_CESC_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_CESC_BPRNACan_avrage <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "CESC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0, 1.2), breaks = seq(0.0, 1.2, 0.2)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.45, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(rowMeans(cbind(CESC_BPRNACan_decon$cancer, CESC_methy_decon$cancer))), as.matrix(Facs_CESC_modif$CPE))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.05, label = paste("RMSE =", round(sqrt(mean((as.matrix(rowMeans(cbind(CESC_BPRNACan_decon$cancer, CESC_methy_decon$cancer))) - as.matrix(Facs_CESC_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 0.9, label = paste("n = ", nrow(CESC_BPRNACan_decon)), size = 4)


a <- cbind(rowMeans(cbind(CESC_BPRNACanProMet_decon$cancer, CESC_methy_decon$cancer)), Facs_CESC_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_CESC_BPRNACanProMet_avrage <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "CESC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0, 1.2), breaks = seq(0.0, 1.2, 0.2)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.45, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(rowMeans(cbind(CESC_BPRNACanProMet_decon$cancer, CESC_methy_decon$cancer))), as.matrix(Facs_CESC_modif$CPE))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.05, label = paste("RMSE =", round(sqrt(mean((as.matrix(rowMeans(cbind(CESC_BPRNACanProMet_decon$cancer, CESC_methy_decon$cancer))) - as.matrix(Facs_CESC_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 0.9, label = paste("n = ", nrow(CESC_BPRNACan_decon)), size = 4)


a <- cbind(rowMeans(cbind(CESC_BPRNACan3DProMet_decon$cancer, CESC_methy_decon$cancer)), Facs_CESC_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_CESC_BPRNACan3DProMet_avrage <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "CESC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0, 1.2), breaks = seq(0.0, 1.2, 0.2)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.45, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(rowMeans(cbind(CESC_BPRNACan3DProMet_decon$cancer, CESC_methy_decon$cancer))), as.matrix(Facs_CESC_modif$CPE))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.05, label = paste("RMSE =", round(sqrt(mean((as.matrix(rowMeans(cbind(CESC_BPRNACan3DProMet_decon$cancer, CESC_methy_decon$cancer))) - as.matrix(Facs_CESC_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 0.9, label = paste("n = ", nrow(CESC_BPRNACan_decon)), size = 4)


#### Lymphocytes

lymph_CESC_BPRNACan_avr <- rowMeans(cbind(CESC_BPRNACan_decon$B + CESC_BPRNACan_decon$NK + CESC_BPRNACan_decon$CD4 + CESC_BPRNACan_decon$CD8, CESC_methy_decon$B + CESC_methy_decon$CD4 + CESC_methy_decon$CD8 + CESC_methy_decon$NK + CESC_methy_decon$Treg))

a <- cbind(lymph_CESC_BPRNACan_avr, HE_CESC_modif$Lymphocytes)
colnames(a) <- c("Cancer_cell_fractions", "Lymphocytes")

Fig_CESC_lymph_BPRNACan_avrage <- ggscatter(data.frame(a), x = "Lymphocytes", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "CESC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_CESC_BPRNACan_avr), as.matrix(HE_CESC_modif$Lymphocytes))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_CESC_BPRNACan_avr) - as.matrix(HE_CESC_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(CESC_methy_decon)), size = 4)


lymph_CESC_BPRNACanProMet_avr <- rowMeans(cbind(CESC_BPRNACanProMet_decon$B + CESC_BPRNACanProMet_decon$NK + CESC_BPRNACanProMet_decon$CD4 + CESC_BPRNACanProMet_decon$CD8, CESC_methy_decon$B + CESC_methy_decon$CD4 + CESC_methy_decon$CD8 + CESC_methy_decon$NK + CESC_methy_decon$Treg))

a <- cbind(lymph_CESC_BPRNACanProMet_avr, HE_CESC_modif$Lymphocytes)
colnames(a) <- c("Cancer_cell_fractions", "Lymphocytes")

Fig_CESC_lymph_BPRNACanProMet_avrage <- ggscatter(data.frame(a), x = "Lymphocytes", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "CESC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_CESC_BPRNACanProMet_avr), as.matrix(HE_CESC_modif$Lymphocytes))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_CESC_BPRNACanProMet_avr) - as.matrix(HE_CESC_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(CESC_methy_decon)), size = 4)

lymph_CESC_BPRNACan3DProMet_avr <- rowMeans(cbind(CESC_BPRNACan3DProMet_decon$B + CESC_BPRNACan3DProMet_decon$NK + CESC_BPRNACan3DProMet_decon$CD4 + CESC_BPRNACan3DProMet_decon$CD8, CESC_methy_decon$B + CESC_methy_decon$CD4 + CESC_methy_decon$CD8 + CESC_methy_decon$NK + CESC_methy_decon$Treg))

a <- cbind(lymph_CESC_BPRNACan3DProMet_avr, HE_CESC_modif$Lymphocytes)
colnames(a) <- c("Cancer_cell_fractions", "Lymphocytes")

Fig_CESC_lymph_BPRNACan3DProMet_avrage <- ggscatter(data.frame(a), x = "Lymphocytes", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "CESC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_CESC_BPRNACan3DProMet_avr), as.matrix(HE_CESC_modif$Lymphocytes))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_CESC_BPRNACan3DProMet_avr) - as.matrix(HE_CESC_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(CESC_methy_decon)), size = 4)

#### Macrophages

Macro_CESC_BPRNACan_avr <- rowMeans(cbind(CESC_BPRNACan_decon$M0 + CESC_BPRNACan_decon$M1 + CESC_BPRNACan_decon$M2 + CESC_BPRNACan_decon$Mono, CESC_methy_decon$M0 + CESC_methy_decon$M1 + CESC_methy_decon$M2 + CESC_methy_decon$Mono))

a <- cbind(Macro_CESC_BPRNACan_avr, HE_CESC_modif$Macrophages)
colnames(a) <- c("Cancer_cell_fractions", "Macrophages")

Fig_CESC_Macro_BPRNACan_avrage <- ggscatter(data.frame(a), x = "Macrophages", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "CESC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_CESC_BPRNACan_avr), as.matrix(HE_CESC_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_CESC_BPRNACan_avr) - as.matrix(HE_CESC_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(CESC_methy_decon)), size = 4)

Macro_CESC_BPRNACanProMet_avr <- rowMeans(cbind(CESC_BPRNACanProMet_decon$M0 + CESC_BPRNACanProMet_decon$M1 + CESC_BPRNACanProMet_decon$M2 + CESC_BPRNACanProMet_decon$Mono, CESC_methy_decon$M0 + CESC_methy_decon$M1 + CESC_methy_decon$M2 + CESC_methy_decon$Mono))

a <- cbind(Macro_CESC_BPRNACanProMet_avr, HE_CESC_modif$Macrophages)
colnames(a) <- c("Cancer_cell_fractions", "Macrophages")

Fig_CESC_Macro_BPRNACanProMet_avrage <- ggscatter(data.frame(a), x = "Macrophages", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "CESC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_CESC_BPRNACanProMet_avr), as.matrix(HE_CESC_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_CESC_BPRNACanProMet_avr) - as.matrix(HE_CESC_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(CESC_methy_decon)), size = 4)


Macro_CESC_BPRNACan3DProMet_avr <- rowMeans(cbind(CESC_BPRNACan3DProMet_decon$M0 + CESC_BPRNACan3DProMet_decon$M1 + CESC_BPRNACan3DProMet_decon$M2 + CESC_BPRNACan3DProMet_decon$Mono, CESC_methy_decon$M0 + CESC_methy_decon$M1 + CESC_methy_decon$M2 + CESC_methy_decon$Mono))

a <- cbind(Macro_CESC_BPRNACan3DProMet_avr, HE_CESC_modif$Macrophages)
colnames(a) <- c("Cancer_cell_fractions", "Macrophages")

Fig_CESC_Macro_BPRNACan3DProMet_avrage <- ggscatter(data.frame(a), x = "Macrophages", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "CESC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_CESC_BPRNACan3DProMet_avr), as.matrix(HE_CESC_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_CESC_BPRNACan3DProMet_avr) - as.matrix(HE_CESC_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(CESC_methy_decon)), size = 4)


#### Neutrophils

a <- cbind(rowMeans(cbind(CESC_BPRNACan_decon$Neu, CESC_methy_decon$Neu)), HE_CESC_modif$Neutrophils)
colnames(a) <- c("Cancer_cell_fractions", "Neutrophils")

Fig_CESC_Neu_BPRNACan_avrage <- ggscatter(data.frame(a), x = "Neutrophils", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "CESC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.4)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.012, y = 0.4, label = paste("italic(r)==", round(cor.test(as.matrix(rowMeans(cbind(CESC_BPRNACan_decon$Neu, CESC_methy_decon$Neu))), as.matrix(HE_CESC_modif$Neutrophils))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(rowMeans(cbind(CESC_BPRNACan_decon$Neu, CESC_methy_decon$Neu))), as.matrix(HE_CESC_modif$Neutrophils))$p.value, 9)), parse = TRUE, size = 4) + annotate("text", x = 0.008, y = 0.35, label = paste("RMSE =", round(sqrt(mean((as.matrix(rowMeans(cbind(CESC_BPRNACan_decon$Neu, CESC_methy_decon$Neu))) - as.matrix(HE_CESC_modif$Neutrophils))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.0051, y = 0.3, label = paste("n = ", nrow(CESC_methy_decon)), size = 4)

a <- cbind(rowMeans(cbind(CESC_BPRNACanProMet_decon$Neu, CESC_methy_decon$Neu)), HE_CESC_modif$Neutrophils)
colnames(a) <- c("Cancer_cell_fractions", "Neutrophils")

Fig_CESC_Neu_BPRNACanProMet_avrage <- ggscatter(data.frame(a), x = "Neutrophils", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "CESC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.4)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.012, y = 0.4, label = paste("italic(r)==", round(cor.test(as.matrix(rowMeans(cbind(CESC_BPRNACanProMet_decon$Neu, CESC_methy_decon$Neu))), as.matrix(HE_CESC_modif$Neutrophils))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(rowMeans(cbind(CESC_BPRNACanProMet_decon$Neu, CESC_methy_decon$Neu))), as.matrix(HE_CESC_modif$Neutrophils))$p.value, 9)), parse = TRUE, size = 4) + annotate("text", x = 0.008, y = 0.35, label = paste("RMSE =", round(sqrt(mean((as.matrix(rowMeans(cbind(CESC_BPRNACanProMet_decon$Neu, CESC_methy_decon$Neu))) - as.matrix(HE_CESC_modif$Neutrophils))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.0051, y = 0.3, label = paste("n = ", nrow(CESC_methy_decon)), size = 4)

a <- cbind(rowMeans(cbind(CESC_BPRNACan3DProMet_decon$Neu, CESC_methy_decon$Neu)), HE_CESC_modif$Neutrophils)
colnames(a) <- c("Cancer_cell_fractions", "Neutrophils")

Fig_CESC_Neu_BPRNACan3DProMet_avrage <- ggscatter(data.frame(a), x = "Neutrophils", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "CESC") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.4)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.012, y = 0.4, label = paste("italic(r)==", round(cor.test(as.matrix(rowMeans(cbind(CESC_BPRNACan3DProMet_decon$Neu, CESC_methy_decon$Neu))), as.matrix(HE_CESC_modif$Neutrophils))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(rowMeans(cbind(CESC_BPRNACan3DProMet_decon$Neu, CESC_methy_decon$Neu))), as.matrix(HE_CESC_modif$Neutrophils))$p.value, 9)), parse = TRUE, size = 4) + annotate("text", x = 0.008, y = 0.35, label = paste("RMSE =", round(sqrt(mean((as.matrix(rowMeans(cbind(CESC_BPRNACan3DProMet_decon$Neu, CESC_methy_decon$Neu))) - as.matrix(HE_CESC_modif$Neutrophils))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.0051, y = 0.3, label = paste("n = ", nrow(CESC_methy_decon)), size = 4)
```
```{r}
#### BPRNACan3D

Lym_CESC_3DRNA <- cbind(lymph_CESC_BPRNACan3DProMet, HE_CESC_modif$Lymphocytes)
colnames(Lym_CESC_3DRNA) <- c("Cancer_cell_fractions", "Lymphocytes")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((lymph_CESC_BPRNACan3DProMet - HE_CESC_modif$Lymphocytes)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Lym_CESC_3DRNA <- ggplot(as.data.frame(Lym_CESC_3DRNA), aes(x = Lymphocytes, y = Cancer_cell_fractions)) +
  geom_point(colour = c("darkslategrey")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"BPRNACan3D") +
  scale_x_continuous(name = NULL, limits = c(0, max(Lym_CESC_3DRNA))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Lym_CESC_3DRNA))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)

Macro_CESC_3DRNA <- cbind(Macro_CESC_BPRNACan3DProMet, HE_CESC_modif$Macrophages)
colnames(Macro_CESC_3DRNA) <- c("Cancer_cell_fractions", "Macrophages")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((Macro_CESC_BPRNACan3DProMet - HE_CESC_modif$Macrophages)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Macro_CESC_3DRNA <- ggplot(as.data.frame(Macro_CESC_3DRNA), aes(x = Macrophages, y = Cancer_cell_fractions)) +
  geom_point(colour = c("coral")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"BPRNACan3D") +
  scale_x_continuous(name = NULL, limits = c(0, max(Macro_CESC_3DRNA))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Macro_CESC_3DRNA))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)


Neu_CESC_3DRNA <- cbind(CESC_BPRNACan3DProMet_decon$Neu, HE_CESC_modif$Neutrophils)
colnames(Neu_CESC_3DRNA) <- c("Cancer_cell_fractions", "Neutrophils")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((CESC_BPRNACan3DProMet_decon$Neu - HE_CESC_modif$Neutrophils)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Neu_CESC_3DRNA <- ggplot(as.data.frame(Neu_CESC_3DRNA), aes(x = Neutrophils, y = Cancer_cell_fractions)) +
  geom_point(colour = c("green")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"BPRNACan3D") +
  scale_x_continuous(name = NULL, limits = c(0, max(Neu_CESC_3DRNA))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Neu_CESC_3DRNA))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)


#### BPmetCan

#### lympho

Lym_CESC_methy <- cbind(lymph_methy, HE_CESC_modif$Lymphocytes)
colnames(Lym_CESC_methy) <- c("Cancer_cell_fractions", "Lymphocytes")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((Lym_CESC_methy - HE_CESC_modif$Lymphocytes)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Lym_CESC_BPmetCan <- ggplot(as.data.frame(Lym_CESC_methy), aes(x = Lymphocytes, y = Cancer_cell_fractions)) +
  geom_point(colour = c("darkslategrey")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"BPmetCan") +
  scale_x_continuous(name = NULL, limits = c(0, max(Lym_CESC_methy))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Lym_CESC_methy))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)

#### Macro

Macro_Methy <- CESC_methy_decon$M0 + CESC_methy_decon$M1 + CESC_methy_decon$M2 + CESC_methy_decon$Mono

Macro_CESC_methy <- cbind(Macro_Methy, HE_CESC_modif$Macrophages)
colnames(Macro_CESC_methy) <- c("Cancer_cell_fractions", "Macrophages")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((Macro_CESC_methy - HE_CESC_modif$Macrophages)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Macro_CESC_BPmetCan <- ggplot(as.data.frame(Macro_CESC_methy), aes(x = Macrophages, y = Cancer_cell_fractions)) +
  geom_point(colour = c("coral")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"BPmetCan") +
  scale_x_continuous(name = NULL, limits = c(0, max(Macro_Methy))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Macro_Methy))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)


#### Neu

Neu_CESC_methy <- cbind(CESC_methy_decon$Neu, HE_CESC_modif$Neutrophils)
colnames(Neu_CESC_methy) <- c("Cancer_cell_fractions", "Neutrophils")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((CESC_methy_decon$Neu - HE_CESC_modif$Neutrophils)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Neu_CESC_BPmetCan <- ggplot(as.data.frame(Neu_CESC_methy), aes(x = Neutrophils, y = Cancer_cell_fractions)) +
  geom_point(colour = c("green")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"BPmetCan") + 
  scale_x_continuous(name = NULL, limits = c(0, max(Neu_CESC_methy))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Neu_CESC_methy))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)



#### avrg

Lym_CESC_avrg <- cbind(lymph_CESC_BPRNACan_avr, HE_CESC_modif$Lymphocytes)
colnames(Lym_CESC_avrg) <- c("Cancer_cell_fractions", "Lymphocytes")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((lymph_CESC_BPRNACan_avr - HE_CESC_modif$Lymphocytes)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Lym_CESC_avrg <- ggplot(as.data.frame(Lym_CESC_avrg), aes(x = Lymphocytes, y = Cancer_cell_fractions)) +
  geom_point(colour = c("darkslategrey")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"Meth + RNA") + 
  scale_x_continuous(name = NULL, limits = c(0, max(Lym_CESC_avrg))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Lym_CESC_avrg))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)


Macro_CESC_avrg <- cbind(Macro_CESC_BPRNACan_avr, HE_CESC_modif$Macrophages)
colnames(Macro_CESC_avrg) <- c("Cancer_cell_fractions", "Macrophages")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((Macro_CESC_BPRNACan_avr - HE_CESC_modif$Macrophages)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Macro_CESC_avrg <- ggplot(as.data.frame(Macro_CESC_avrg), aes(x = Macrophages, y = Cancer_cell_fractions)) +
  geom_point(colour = c("coral")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"Meth + RNA") +
  scale_x_continuous(name = NULL, limits = c(0, max(Macro_CESC_avrg))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Macro_CESC_avrg))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)

Neu_CESC_avrg <- cbind(rowMeans(cbind(CESC_BPRNACan_decon$Neu, CESC_methy_decon$Neu)), HE_CESC_modif$Neutrophils)
colnames(Neu_CESC_avrg) <- c("Cancer_cell_fractions", "Neutrophils")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean(rowMeans(cbind(CESC_BPRNACan_decon$Neu, CESC_methy_decon$Neu) - HE_CESC_modif$Neutrophils)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Neu_CESC_avrg <- ggplot(as.data.frame(Neu_CESC_avrg), aes(x = Neutrophils, y = Cancer_cell_fractions)) +
  geom_point(colour = c("green")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"Meth + RNA") + 
  scale_x_continuous(name = NULL, limits = c(0, max(Neu_CESC_avrg))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Neu_CESC_avrg))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)



lymph = ggarrange(fig_Lym_CESC_3DRNA, fig_Lym_CESC_BPmetCan, fig_Lym_CESC_avrg, ncol = 3, nrow = 1, labels = "a", font.label = list(size = 20, color = "black"), align = "hv")
neutro = ggarrange(fig_Neu_CESC_3DRNA, fig_Neu_CESC_BPmetCan, fig_Neu_CESC_avrg, ncol = 3, nrow = 1, labels = "b", font.label = list(size = 20, color = "black"), align = "hv")
macro = ggarrange(fig_Macro_CESC_3DRNA, fig_Macro_CESC_BPmetCan, fig_Macro_CESC_avrg, ncol = 3, nrow = 1, labels = "c", font.label = list(size = 20, color = "black"), align = "hv")


All_CESC <- ggarrange(lymph, neutro, macro, ncol = 1, nrow = 3, font.label = list(size = 20, color = "black"), align = "hv")


All_CESC <- annotate_figure(All_CESC,
  left = text_grob("Estimated fractions", color = "black", size = 20, rot = 90),
  bottom = text_grob("H&E estimates", color = "black", size = 20)
  
)

All_CESC
```
RNA, methylation, and averaged values of correlation across a : lymphocytes, b: neutrophils, c : macrophages, using the BPRNACan3D and BPMetCan signatures on EpiDish.


## SKCM

```{r}

SKCM_methy_decon <- read.table("/mnt/SERVER-CRCT-STORAGE/CRCT21/Private/Julien/gemdecan/data/meth/SKCM.txt", sep = "\t", header = T)

Facs_SKCM <- Aran_all_facs[Aran_all_facs$Cancer_type == "SKCM", ]

HE_SKCM <- HE_all_TCGA[HE_all_TCGA$Study == "SKCM", ]

Facs_SKCM_modif <- Facs_SKCM[Facs_SKCM$CPE != "NaN", ]

Comm_samples <- Reduce(intersect, list(HE_SKCM$ParticipantBarcode, Facs_SKCM_modif$Sample_ID, tcga_deconv$Samples, rownames(SKCM_methy_decon)))

Facs_SKCM_modif <- Facs_SKCM_modif %>% .[.$Sample_ID %in% Comm_samples, ]

HE_SKCM_modif <- HE_SKCM %>%
  .[.$ParticipantBarcode %in% Comm_samples, ] %>%
  .[order(.$ParticipantBarcode), ]

SKCM_methy_decon <- SKCM_methy_decon[Comm_samples, ] %>% 
  rownames_to_column() 
SKCM_methy_decon <- SKCM_methy_decon[order(SKCM_methy_decon$rowname), ]
rownames(SKCM_methy_decon) <- SKCM_methy_decon$rowname
SKCM_methy_decon <- SKCM_methy_decon[,-1]

SKCM_RNA_decon <- tcga_deconv %>% filter(Samples %in% Comm_samples)

###################################
##### Estimating Tumor Purity #####
###################################


SKCM_BPRNACan_decon <- SKCM_RNA_decon %>% select(colnames(SKCM_RNA_decon)[grepl("Epidish_BPRNACan_", colnames(SKCM_RNA_decon))])
colnames(SKCM_BPRNACan_decon) <- colnames(SKCM_BPRNACan_decon) %>% str_remove_all("Epidish_BPRNACan_")

a <- cbind(SKCM_BPRNACan_decon$cancer, Facs_SKCM_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_SKCM_BPRNACan <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "SKCM") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0.8, 1.2), breaks = seq(0.0, 1.2, 0.1)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.42, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(SKCM_BPRNACan_decon$cancer), as.matrix(Facs_SKCM_modif$CPE))$est, 2), "~','", "~italic(P)<", round(cor.test(as.matrix(SKCM_BPRNACan_decon$cancer), as.matrix(Facs_SKCM_modif$CPE))$p.value, 14)), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.15, label = paste("RMSE =", round(sqrt(mean((as.matrix(SKCM_BPRNACan_decon$cancer) - as.matrix(Facs_SKCM_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 1.1, label = paste("n = ", nrow(SKCM_BPRNACan_decon)), size = 4)


SKCM_BPRNACanProMet_decon <- SKCM_RNA_decon %>% select(colnames(SKCM_RNA_decon)[grepl("Epidish_BPRNACanProMet_", colnames(SKCM_RNA_decon))])
colnames(SKCM_BPRNACanProMet_decon) <- colnames(SKCM_BPRNACanProMet_decon) %>% str_remove_all("Epidish_BPRNACanProMet_")

a <- cbind(SKCM_BPRNACanProMet_decon$cancer, Facs_SKCM_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_SKCM_BPRNACanProMet <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "SKCM") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0.8, 1.2), breaks = seq(0.0, 1.2, 0.1)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.45, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(SKCM_BPRNACanProMet_decon$cancer), as.matrix(Facs_SKCM_modif$CPE))$est, 2), "~','", "~italic(P)<", round(cor.test(as.matrix(SKCM_BPRNACanProMet_decon$cancer), as.matrix(Facs_SKCM_modif$CPE))$p.value, 14)), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.15, label = paste("RMSE =", round(sqrt(mean((as.matrix(SKCM_BPRNACanProMet_decon$cancer) - as.matrix(Facs_SKCM_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 1.1, label = paste("n = ", nrow(SKCM_BPRNACanProMet_decon)), size = 4)


SKCM_BPRNACan3DProMet_decon <- SKCM_RNA_decon %>% select(colnames(SKCM_RNA_decon)[grepl("Epidish_BPRNACan3DProMet_", colnames(SKCM_RNA_decon))])
colnames(SKCM_BPRNACan3DProMet_decon) <- colnames(SKCM_BPRNACan3DProMet_decon) %>% str_remove_all("Epidish_BPRNACan3DProMet_")


a <- cbind(SKCM_BPRNACan3DProMet_decon$cancer, Facs_SKCM_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_SKCM_BPRNACan3DProMet <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "SKCM") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0.8, 1.2), breaks = seq(0.0, 1.2, 0.1)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.52, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(SKCM_BPRNACan3DProMet_decon$cancer), as.matrix(Facs_SKCM_modif$CPE))$est, 2), "~','", "~italic(P)<", round(cor.test(as.matrix(SKCM_BPRNACan3DProMet_decon$cancer), as.matrix(Facs_SKCM_modif$CPE))$p.value, 14)), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.15, label = paste("RMSE =", round(sqrt(mean((as.matrix(SKCM_BPRNACan3DProMet_decon$cancer) - as.matrix(Facs_SKCM_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 1.1, label = paste("n = ", nrow(SKCM_BPRNACan3DProMet_decon)), size = 4)

###### Methylation part

a <- cbind(SKCM_methy_decon$cancer, Facs_SKCM_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_SKCM_BPmetCan <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "SKCM") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0, 1.2), breaks = seq(0.0, 1.2, 0.2)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.45, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(SKCM_methy_decon$cancer), as.matrix(Facs_SKCM_modif$CPE))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.05, label = paste("RMSE =", round(sqrt(mean((as.matrix(SKCM_methy_decon$cancer) - as.matrix(Facs_SKCM_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 0.9, label = paste("n = ", nrow(SKCM_methy_decon)), size = 4)


###############################################################
##### Estimating Lymphocytes, Macrophages and Neutrophils #####
###############################################################

##### RNA expression Part #####

#### lymph

lymph_SKCM_BPRNACan <- SKCM_BPRNACan_decon$B + SKCM_BPRNACan_decon$CD4 + SKCM_BPRNACan_decon$CD8 + SKCM_BPRNACan_decon$NK

a <- cbind(lymph_SKCM_BPRNACan, HE_SKCM_modif$Lymphocytes)
colnames(a) <- c("lymph_fractions", "HE")

Fig_SKCM_lymph_BPRNACan <- ggscatter(data.frame(a), x = "HE", y = "lymph_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "SKCM") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.08)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.235, y = 0.08, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_SKCM_BPRNACan), as.matrix(HE_SKCM_modif$Lymphocytes))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.07, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_SKCM_BPRNACan) - as.matrix(HE_SKCM_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.06, label = paste("n = ", nrow(SKCM_methy_decon)), size = 4)



lymph_SKCM_BPRNACanProMet <- SKCM_BPRNACanProMet_decon$B + SKCM_BPRNACanProMet_decon$CD4 + SKCM_BPRNACanProMet_decon$CD8 + SKCM_BPRNACanProMet_decon$NK

a <- cbind(lymph_SKCM_BPRNACanProMet, HE_SKCM_modif$Lymphocytes)
colnames(a) <- c("lymph_fractions", "HE")

Fig_SKCM_lymph_BPRNACanProMet <- ggscatter(data.frame(a), x = "HE", y = "lymph_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "SKCM") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.08)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.235, y = 0.08, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_SKCM_BPRNACanProMet), as.matrix(HE_SKCM_modif$Lymphocytes))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(lymph_SKCM_BPRNACanProMet), as.matrix(HE_SKCM_modif$Lymphocytes))$p.value, 13)), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.07, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_SKCM_BPRNACanProMet) - as.matrix(HE_SKCM_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.06, label = paste("n = ", nrow(SKCM_BPRNACanProMet_decon)), size = 4)


lymph_SKCM_BPRNACan3DProMet <- SKCM_BPRNACan3DProMet_decon$B + SKCM_BPRNACan3DProMet_decon$CD4 + SKCM_BPRNACan3DProMet_decon$CD8 + SKCM_BPRNACan3DProMet_decon$NK

a <- cbind(lymph_SKCM_BPRNACan3DProMet, HE_SKCM_modif$Lymphocytes)
colnames(a) <- c("lymph_fractions", "HE")

Fig_SKCM_lymph_BPRNACan3DProMet <- ggscatter(data.frame(a), x = "HE", y = "lymph_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "SKCM") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.08)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.235, y = 0.08, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_SKCM_BPRNACan3DProMet), as.matrix(HE_SKCM_modif$Lymphocytes))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(lymph_SKCM_BPRNACan3DProMet), as.matrix(HE_SKCM_modif$Lymphocytes))$p.value, 13)), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.07, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_SKCM_BPRNACan3DProMet) - as.matrix(HE_SKCM_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.06, label = paste("n = ", nrow(SKCM_BPRNACanProMet_decon)), size = 4)


#### Macro

Macro_SKCM_BPRNACan <- SKCM_BPRNACan_decon$M0 + SKCM_BPRNACan_decon$M1 + SKCM_BPRNACan_decon$M2 + SKCM_BPRNACan_decon$Mono

a <- cbind(Macro_SKCM_BPRNACan, HE_SKCM_modif$Macrophages)
colnames(a) <- c("Macro_fractions", "HE")

Fig_SKCM_Macro_BPRNACan <- ggscatter(data.frame(a), x = "HE", y = "Macro_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "SKCM") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.4)) + scale_y_continuous(name = NULL, limits = c(0, 0.06)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.175, y = 0.06, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_SKCM_BPRNACan), as.matrix(HE_SKCM_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.11, y = 0.0526, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_SKCM_BPRNACan) - as.matrix(HE_SKCM_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.08, y = 0.045, label = paste("n = ", nrow(SKCM_BPRNACan_decon)), size = 4)



Macro_SKCM_BPRNACanProMet <- SKCM_BPRNACanProMet_decon$M0 + SKCM_BPRNACanProMet_decon$M1 + SKCM_BPRNACanProMet_decon$M2 + SKCM_BPRNACanProMet_decon$Mono

a <- cbind(Macro_SKCM_BPRNACanProMet, HE_SKCM_modif$Macrophages)
colnames(a) <- c("Macro_fractions", "HE")

Fig_SKCM_Macro_BPRNACanProMet <- ggscatter(data.frame(a), x = "HE", y = "Macro_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "SKCM") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.4)) + scale_y_continuous(name = NULL, limits = c(0, 0.06)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.185, y = 0.06, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_SKCM_BPRNACanProMet), as.matrix(HE_SKCM_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.11, y = 0.0526, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_SKCM_BPRNACanProMet) - as.matrix(HE_SKCM_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.08, y = 0.045, label = paste("n = ", nrow(SKCM_BPRNACan_decon)), size = 4)

Macro_SKCM_BPRNACan3DProMet <- SKCM_BPRNACan3DProMet_decon$M0 + SKCM_BPRNACan3DProMet_decon$M1 + SKCM_BPRNACan3DProMet_decon$M2 + SKCM_BPRNACan3DProMet_decon$Mono

a <- cbind(Macro_SKCM_BPRNACan3DProMet, HE_SKCM_modif$Macrophages)
colnames(a) <- c("Macro_fractions", "HE")

Fig_SKCM_Macro_BPRNACan3DProMet <- ggscatter(data.frame(a), x = "HE", y = "Macro_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "SKCM") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.4)) + scale_y_continuous(name = NULL, limits = c(0, 0.06)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.185, y = 0.06, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_SKCM_BPRNACan3DProMet), as.matrix(HE_SKCM_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.11, y = 0.0526, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_SKCM_BPRNACan3DProMet) - as.matrix(HE_SKCM_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.08, y = 0.045, label = paste("n = ", nrow(SKCM_BPRNACan_decon)), size = 4)

#### Neutrophis

a <- cbind(SKCM_BPRNACan_decon$Neu, HE_SKCM_modif$Neutrophils)
colnames(a) <- c("Neu_fractions", "HE")

Fig_SKCM_Neu_BPRNACan <- ggscatter(data.frame(a), x = "HE", y = "Neu_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "SKCM") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.006)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.015, y = 0.006, label = paste("italic(r)==", round(cor.test(as.matrix(SKCM_BPRNACan_decon$Neu), as.matrix(HE_SKCM_modif$Neutrophils))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.009, y = 0.00525, label = paste("RMSE =", round(sqrt(mean((as.matrix(SKCM_BPRNACan_decon$Neu) - as.matrix(HE_SKCM_modif$Neutrophils))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.0065, y = 0.0046, label = paste("n = ", nrow(SKCM_BPRNACan_decon)), size = 4)


a <- cbind(SKCM_BPRNACanProMet_decon$Neu, HE_SKCM_modif$Neutrophils)
colnames(a) <- c("Neu_fractions", "HE")

Fig_SKCM_Neu_BPRNACanProMet <- ggscatter(data.frame(a[-155, ]), x = "HE", y = "Neu_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "SKCM") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.006)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.015, y = 0.006, label = paste("italic(r)==", round(cor.test(as.matrix(SKCM_BPRNACanProMet_decon$Neu), as.matrix(HE_SKCM_modif$Neutrophils))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.0105, y = 0.00525, label = paste("RMSE =", round(sqrt(mean((as.matrix(SKCM_BPRNACanProMet_decon$Neu) - as.matrix(HE_SKCM_modif$Neutrophils))^2, na.rm = T)), 5)), parse = F, size = 4) + annotate("text", x = 0.0065, y = 0.0046, label = paste("n = ", nrow(SKCM_BPRNACan_decon)), size = 4)


a <- cbind(SKCM_BPRNACan3DProMet_decon$Neu, HE_SKCM_modif$Neutrophils)
colnames(a) <- c("Neu_fractions", "HE")

Fig_SKCM_Neu_BPRNACan3DProMet <- ggscatter(data.frame(a), x = "HE", y = "Neu_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "SKCM") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.008)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.015, y = 0.008, label = paste("italic(r)==", round(cor.test(as.matrix(SKCM_BPRNACan3DProMet_decon$Neu), as.matrix(HE_SKCM_modif$Neutrophils))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(SKCM_BPRNACan3DProMet_decon$Neu), as.matrix(HE_SKCM_modif$Neutrophils))$p.value, 15)), parse = TRUE, size = 4) + annotate("text", x = 0.0105, y = 0.007, label = paste("RMSE =", round(sqrt(mean((as.matrix(SKCM_BPRNACan3DProMet_decon$Neu) - as.matrix(HE_SKCM_modif$Neutrophils))^2, na.rm = T)), 3)), parse = F, size = 4) + annotate("text", x = 0.0065, y = 0.006, label = paste("n = ", nrow(SKCM_BPRNACan_decon)), size = 4)

##### DNA methylation Part #####

#### lympho

lymph_methy <- SKCM_methy_decon$B + SKCM_methy_decon$CD4 + SKCM_methy_decon$CD8 + SKCM_methy_decon$Treg + SKCM_methy_decon$NK

a <- cbind(lymph_methy, HE_SKCM_modif$Lymphocytes)
colnames(a) <- c("lymph_methy", "HE_lympho")

Fig_SKCM_lymph_BPmetCan <- ggscatter(data.frame(a), x = "HE_lympho", y = "lymph_methy", size = 2, add.params = list(color = "black"), color = "chocolate", title = "SKCM") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_methy), as.matrix(HE_SKCM_modif$Lymphocytes))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_methy) - as.matrix(HE_SKCM_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(SKCM_methy_decon)), size = 4)


#### Macro

Macro_Methy <- SKCM_methy_decon$M0 + SKCM_methy_decon$M1 + SKCM_methy_decon$M2 + SKCM_methy_decon$Mono

a <- cbind(Macro_Methy, HE_SKCM_modif$Macrophages)
colnames(a) <- c("Macro_Methy", "HE_macro")

Fig_SKCM_Macro_BPmetCan <- ggscatter(data.frame(a), x = "HE_macro", y = "Macro_Methy", size = 2, add.params = list(color = "black"), color = "chocolate", title = "SKCM") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_Methy), as.matrix(HE_SKCM_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_Methy) - as.matrix(HE_SKCM_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(SKCM_methy_decon)), size = 4)

#### Neu

a <- cbind(SKCM_methy_decon$Neu, HE_SKCM_modif$Neutrophils)
colnames(a) <- c("Neu_Methy", "HE_neu")

Fig_SKCM_Neu_BPmetCan <- ggscatter(data.frame(a), x = "HE_neu", y = "Neu_Methy", size = 2, add.params = list(color = "black"), color = "chocolate", title = "SKCM") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.8)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.0135, y = 0.8, label = paste("italic(r)==", round(cor.test(as.matrix(SKCM_methy_decon$Neu), as.matrix(HE_SKCM_modif$Neutrophils))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(SKCM_methy_decon$Neu), as.matrix(HE_SKCM_modif$Neutrophils))$p.value, 10)), parse = TRUE, size = 4) + annotate("text", x = 0.0085, y = 0.7, label = paste("RMSE =", round(sqrt(mean((as.matrix(SKCM_methy_decon$Neu) - as.matrix(HE_SKCM_modif$Neutrophils))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.0057, y = 0.6, label = paste("n = ", nrow(SKCM_methy_decon)), size = 4)


##### Correlation between DNA methylation and expression deconvolution #####

## Tumor purity

a <- cbind(SKCM_BPRNACan_decon$cancer, SKCM_methy_decon$cancer)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_SKCM_TM_BPRNACan_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", size = 2, add.params = list(color = "black"), color = "chocolate", title = "SKCM") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL, limits = c(0, 1)) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", label.x = 0, label.y = 1, size = 6)

a <- cbind(SKCM_BPRNACanProMet_decon$cancer, SKCM_methy_decon$cancer)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_SKCM_TM_BPRNACanProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", size = 2, add.params = list(color = "black"), color = "chocolate", title = "SKCM") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL, limits = c(0, 1)) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", label.x = 0, label.y = 1, size = 6)

a <- cbind(SKCM_BPRNACan3DProMet_decon$cancer, SKCM_methy_decon$cancer)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_SKCM_TM_BPRNACan3DProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", size = 2, add.params = list(color = "black"), color = "chocolate", title = "SKCM") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL, limits = c(0, 1)) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black") + stat_cor(method = "pearson", label.x = 0, label.y = 1, size = 6)


## Lymphcytes

a <- cbind(lymph_SKCM_BPRNACan, lymph_methy)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_SKCM_lymph_BPRNACan_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "SKCM") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")

a <- cbind(lymph_SKCM_BPRNACanProMet, lymph_methy)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_SKCM_lymph_BPRNACanProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "SKCM") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")

a <- cbind(lymph_SKCM_BPRNACan3DProMet, lymph_methy)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_SKCM_lymph_BPRNACan3DProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "SKCM") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")


## Macrophages

a <- cbind(Macro_SKCM_BPRNACan, Macro_Methy)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_SKCM_macro_BPRNACan_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "SKCM") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")


a <- cbind(Macro_SKCM_BPRNACanProMet, Macro_Methy)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_SKCM_macro_BPRNACanProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "SKCM") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")

a <- cbind(Macro_SKCM_BPRNACan3DProMet, Macro_Methy)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_SKCM_macro_BPRNACan3DProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "SKCM") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")


## Netrophils

a <- cbind(SKCM_BPRNACan_decon$Neu, SKCM_methy_decon$Neu)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_SKCM_Neu_BPRNACan_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "SKCM") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")


a <- cbind(SKCM_BPRNACanProMet_decon$Neu, SKCM_methy_decon$Neu)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_SKCM_Neu_BPRNACanProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "SKCM") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")

a <- cbind(SKCM_BPRNACan3DProMet_decon$Neu, SKCM_methy_decon$Neu)
colnames(a) <- c("BPRNACan_fractions", "BPmetCan_fractions")

Fig_SKCM_Neu_BPRNACan3DProMet_Cor <- ggscatter(data.frame(a), x = "BPmetCan_fractions", y = "BPRNACan_fractions", add = "reg.line", cor.coef = T, cor.coef.size = 6, size = 2, add.params = list(color = "black"), color = "chocolate", title = "SKCM") + theme(plot.title = element_text(size = 18, hjust = 0.5, face = "italic")) + scale_x_continuous(name = NULL) + scale_y_continuous(name = NULL) + font("xy.text", size = 16, color = "black")



###############################################
###### average of Methylation and RNAseq ######
###############################################

#### Tumor purity

a <- cbind(rowMeans(cbind(SKCM_BPRNACan_decon$cancer, SKCM_methy_decon$cancer)), Facs_SKCM_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_SKCM_BPRNACan_avrage <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "SKCM") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0, 1.2), breaks = seq(0.0, 1.2, 0.2)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.45, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(rowMeans(cbind(SKCM_BPRNACan_decon$cancer, SKCM_methy_decon$cancer))), as.matrix(Facs_SKCM_modif$CPE))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.05, label = paste("RMSE =", round(sqrt(mean((as.matrix(rowMeans(cbind(SKCM_BPRNACan_decon$cancer, SKCM_methy_decon$cancer))) - as.matrix(Facs_SKCM_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 0.9, label = paste("n = ", nrow(SKCM_BPRNACan_decon)), size = 4)


a <- cbind(rowMeans(cbind(SKCM_BPRNACanProMet_decon$cancer, SKCM_methy_decon$cancer)), Facs_SKCM_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_SKCM_BPRNACanProMet_avrage <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "SKCM") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0, 1.2), breaks = seq(0.0, 1.2, 0.2)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.45, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(rowMeans(cbind(SKCM_BPRNACanProMet_decon$cancer, SKCM_methy_decon$cancer))), as.matrix(Facs_SKCM_modif$CPE))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.05, label = paste("RMSE =", round(sqrt(mean((as.matrix(rowMeans(cbind(SKCM_BPRNACanProMet_decon$cancer, SKCM_methy_decon$cancer))) - as.matrix(Facs_SKCM_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 0.9, label = paste("n = ", nrow(SKCM_BPRNACan_decon)), size = 4)


a <- cbind(rowMeans(cbind(SKCM_BPRNACan3DProMet_decon$cancer, SKCM_methy_decon$cancer)), Facs_SKCM_modif$CPE)
colnames(a) <- c("Cancer_cell_fractions", "Tumor_Purity")

Fig_SKCM_BPRNACan3DProMet_avrage <- ggscatter(data.frame(a), x = "Tumor_Purity", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "SKCM") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 1.0), breaks = seq(0.0, 1.0, 0.2)) + scale_y_continuous(name = NULL, limits = c(0, 1.2), breaks = seq(0.0, 1.2, 0.2)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.45, y = 1.2, label = paste("italic(r)==", round(cor.test(as.matrix(rowMeans(cbind(SKCM_BPRNACan3DProMet_decon$cancer, SKCM_methy_decon$cancer))), as.matrix(Facs_SKCM_modif$CPE))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.29, y = 1.05, label = paste("RMSE =", round(sqrt(mean((as.matrix(rowMeans(cbind(SKCM_BPRNACan3DProMet_decon$cancer, SKCM_methy_decon$cancer))) - as.matrix(Facs_SKCM_modif$CPE))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.2, y = 0.9, label = paste("n = ", nrow(SKCM_BPRNACan_decon)), size = 4)


#### Lymphocytes

lymph_SKCM_BPRNACan_avr <- rowMeans(cbind(SKCM_BPRNACan_decon$B + SKCM_BPRNACan_decon$NK + SKCM_BPRNACan_decon$CD4 + SKCM_BPRNACan_decon$CD8, SKCM_methy_decon$B + SKCM_methy_decon$CD4 + SKCM_methy_decon$CD8 + SKCM_methy_decon$NK + SKCM_methy_decon$Treg))

a <- cbind(lymph_SKCM_BPRNACan_avr, HE_SKCM_modif$Lymphocytes)
colnames(a) <- c("Cancer_cell_fractions", "Lymphocytes")

Fig_SKCM_lymph_BPRNACan_avrage <- ggscatter(data.frame(a), x = "Lymphocytes", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "SKCM") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_SKCM_BPRNACan_avr), as.matrix(HE_SKCM_modif$Lymphocytes))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_SKCM_BPRNACan_avr) - as.matrix(HE_SKCM_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(SKCM_methy_decon)), size = 4)


lymph_SKCM_BPRNACanProMet_avr <- rowMeans(cbind(SKCM_BPRNACanProMet_decon$B + SKCM_BPRNACanProMet_decon$NK + SKCM_BPRNACanProMet_decon$CD4 + SKCM_BPRNACanProMet_decon$CD8, SKCM_methy_decon$B + SKCM_methy_decon$CD4 + SKCM_methy_decon$CD8 + SKCM_methy_decon$NK + SKCM_methy_decon$Treg))

a <- cbind(lymph_SKCM_BPRNACanProMet_avr, HE_SKCM_modif$Lymphocytes)
colnames(a) <- c("Cancer_cell_fractions", "Lymphocytes")

Fig_SKCM_lymph_BPRNACanProMet_avrage <- ggscatter(data.frame(a), x = "Lymphocytes", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "SKCM") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_SKCM_BPRNACanProMet_avr), as.matrix(HE_SKCM_modif$Lymphocytes))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_SKCM_BPRNACanProMet_avr) - as.matrix(HE_SKCM_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(SKCM_methy_decon)), size = 4)

lymph_SKCM_BPRNACan3DProMet_avr <- rowMeans(cbind(SKCM_BPRNACan3DProMet_decon$B + SKCM_BPRNACan3DProMet_decon$NK + SKCM_BPRNACan3DProMet_decon$CD4 + SKCM_BPRNACan3DProMet_decon$CD8, SKCM_methy_decon$B + SKCM_methy_decon$CD4 + SKCM_methy_decon$CD8 + SKCM_methy_decon$NK + SKCM_methy_decon$Treg))

a <- cbind(lymph_SKCM_BPRNACan3DProMet_avr, HE_SKCM_modif$Lymphocytes)
colnames(a) <- c("Cancer_cell_fractions", "Lymphocytes")

Fig_SKCM_lymph_BPRNACan3DProMet_avrage <- ggscatter(data.frame(a), x = "Lymphocytes", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "SKCM") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(lymph_SKCM_BPRNACan3DProMet_avr), as.matrix(HE_SKCM_modif$Lymphocytes))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(lymph_SKCM_BPRNACan3DProMet_avr) - as.matrix(HE_SKCM_modif$Lymphocytes))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(SKCM_methy_decon)), size = 4)

#### Macrophages

Macro_SKCM_BPRNACan_avr <- rowMeans(cbind(SKCM_BPRNACan_decon$M0 + SKCM_BPRNACan_decon$M1 + SKCM_BPRNACan_decon$M2 + SKCM_BPRNACan_decon$Mono, SKCM_methy_decon$M0 + SKCM_methy_decon$M1 + SKCM_methy_decon$M2 + SKCM_methy_decon$Mono))

a <- cbind(Macro_SKCM_BPRNACan_avr, HE_SKCM_modif$Macrophages)
colnames(a) <- c("Cancer_cell_fractions", "Macrophages")

Fig_SKCM_Macro_BPRNACan_avrage <- ggscatter(data.frame(a), x = "Macrophages", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "SKCM") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_SKCM_BPRNACan_avr), as.matrix(HE_SKCM_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_SKCM_BPRNACan_avr) - as.matrix(HE_SKCM_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(SKCM_methy_decon)), size = 4)

Macro_SKCM_BPRNACanProMet_avr <- rowMeans(cbind(SKCM_BPRNACanProMet_decon$M0 + SKCM_BPRNACanProMet_decon$M1 + SKCM_BPRNACanProMet_decon$M2 + SKCM_BPRNACanProMet_decon$Mono, SKCM_methy_decon$M0 + SKCM_methy_decon$M1 + SKCM_methy_decon$M2 + SKCM_methy_decon$Mono))

a <- cbind(Macro_SKCM_BPRNACanProMet_avr, HE_SKCM_modif$Macrophages)
colnames(a) <- c("Cancer_cell_fractions", "Macrophages")

Fig_SKCM_Macro_BPRNACanProMet_avrage <- ggscatter(data.frame(a), x = "Macrophages", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "SKCM") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_SKCM_BPRNACanProMet_avr), as.matrix(HE_SKCM_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_SKCM_BPRNACanProMet_avr) - as.matrix(HE_SKCM_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(SKCM_methy_decon)), size = 4)


Macro_SKCM_BPRNACan3DProMet_avr <- rowMeans(cbind(SKCM_BPRNACan3DProMet_decon$M0 + SKCM_BPRNACan3DProMet_decon$M1 + SKCM_BPRNACan3DProMet_decon$M2 + SKCM_BPRNACan3DProMet_decon$Mono, SKCM_methy_decon$M0 + SKCM_methy_decon$M1 + SKCM_methy_decon$M2 + SKCM_methy_decon$Mono))

a <- cbind(Macro_SKCM_BPRNACan3DProMet_avr, HE_SKCM_modif$Macrophages)
colnames(a) <- c("Cancer_cell_fractions", "Macrophages")

Fig_SKCM_Macro_BPRNACan3DProMet_avrage <- ggscatter(data.frame(a), x = "Macrophages", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "SKCM") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.5)) + scale_y_continuous(name = NULL, limits = c(0, 0.5)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.23, y = 0.5, label = paste("italic(r)==", round(cor.test(as.matrix(Macro_SKCM_BPRNACan3DProMet_avr), as.matrix(HE_SKCM_modif$Macrophages))$est, 2), "~','", "~italic(P)<", "2.2e-16"), parse = TRUE, size = 4) + annotate("text", x = 0.15, y = 0.437, label = paste("RMSE =", round(sqrt(mean((as.matrix(Macro_SKCM_BPRNACan3DProMet_avr) - as.matrix(HE_SKCM_modif$Macrophages))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.1, y = 0.38, label = paste("n = ", nrow(SKCM_methy_decon)), size = 4)


#### Neutrophils

a <- cbind(rowMeans(cbind(SKCM_BPRNACan_decon$Neu, SKCM_methy_decon$Neu)), HE_SKCM_modif$Neutrophils)
colnames(a) <- c("Cancer_cell_fractions", "Neutrophils")

Fig_SKCM_Neu_BPRNACan_avrage <- ggscatter(data.frame(a), x = "Neutrophils", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "SKCM") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.4)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.012, y = 0.4, label = paste("italic(r)==", round(cor.test(as.matrix(rowMeans(cbind(SKCM_BPRNACan_decon$Neu, SKCM_methy_decon$Neu))), as.matrix(HE_SKCM_modif$Neutrophils))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(rowMeans(cbind(SKCM_BPRNACan_decon$Neu, SKCM_methy_decon$Neu))), as.matrix(HE_SKCM_modif$Neutrophils))$p.value, 9)), parse = TRUE, size = 4) + annotate("text", x = 0.008, y = 0.35, label = paste("RMSE =", round(sqrt(mean((as.matrix(rowMeans(cbind(SKCM_BPRNACan_decon$Neu, SKCM_methy_decon$Neu))) - as.matrix(HE_SKCM_modif$Neutrophils))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.0051, y = 0.3, label = paste("n = ", nrow(SKCM_methy_decon)), size = 4)

a <- cbind(rowMeans(cbind(SKCM_BPRNACanProMet_decon$Neu, SKCM_methy_decon$Neu)), HE_SKCM_modif$Neutrophils)
colnames(a) <- c("Cancer_cell_fractions", "Neutrophils")

Fig_SKCM_Neu_BPRNACanProMet_avrage <- ggscatter(data.frame(a), x = "Neutrophils", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "SKCM") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.4)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.012, y = 0.4, label = paste("italic(r)==", round(cor.test(as.matrix(rowMeans(cbind(SKCM_BPRNACanProMet_decon$Neu, SKCM_methy_decon$Neu))), as.matrix(HE_SKCM_modif$Neutrophils))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(rowMeans(cbind(SKCM_BPRNACanProMet_decon$Neu, SKCM_methy_decon$Neu))), as.matrix(HE_SKCM_modif$Neutrophils))$p.value, 9)), parse = TRUE, size = 4) + annotate("text", x = 0.008, y = 0.35, label = paste("RMSE =", round(sqrt(mean((as.matrix(rowMeans(cbind(SKCM_BPRNACanProMet_decon$Neu, SKCM_methy_decon$Neu))) - as.matrix(HE_SKCM_modif$Neutrophils))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.0051, y = 0.3, label = paste("n = ", nrow(SKCM_methy_decon)), size = 4)

a <- cbind(rowMeans(cbind(SKCM_BPRNACan3DProMet_decon$Neu, SKCM_methy_decon$Neu)), HE_SKCM_modif$Neutrophils)
colnames(a) <- c("Cancer_cell_fractions", "Neutrophils")

Fig_SKCM_Neu_BPRNACan3DProMet_avrage <- ggscatter(data.frame(a), x = "Neutrophils", y = "Cancer_cell_fractions", size = 2, add.params = list(color = "black"), color = "chocolate", title = "SKCM") + theme(plot.title = element_text(size = 14, hjust = 0.5, face = "italic")) + stat_smooth(method = lm, size = 0.2, color = "black", se = FALSE, fullrange = T) + scale_x_continuous(name = NULL, limits = c(0, 0.03)) + scale_y_continuous(name = NULL, limits = c(0, 0.4)) + font("xy.text", size = 12, color = "black") + annotate("text", x = 0.012, y = 0.4, label = paste("italic(r)==", round(cor.test(as.matrix(rowMeans(cbind(SKCM_BPRNACan3DProMet_decon$Neu, SKCM_methy_decon$Neu))), as.matrix(HE_SKCM_modif$Neutrophils))$est, 2), "~','", "~italic(P)==", round(cor.test(as.matrix(rowMeans(cbind(SKCM_BPRNACan3DProMet_decon$Neu, SKCM_methy_decon$Neu))), as.matrix(HE_SKCM_modif$Neutrophils))$p.value, 9)), parse = TRUE, size = 4) + annotate("text", x = 0.008, y = 0.35, label = paste("RMSE =", round(sqrt(mean((as.matrix(rowMeans(cbind(SKCM_BPRNACan3DProMet_decon$Neu, SKCM_methy_decon$Neu))) - as.matrix(HE_SKCM_modif$Neutrophils))^2, na.rm = T)), 2)), parse = F, size = 4) + annotate("text", x = 0.0051, y = 0.3, label = paste("n = ", nrow(SKCM_methy_decon)), size = 4)
```
```{r}
#### BPRNACan3D

Lym_SKCM_3DRNA <- cbind(lymph_SKCM_BPRNACan3DProMet, HE_SKCM_modif$Lymphocytes)
colnames(Lym_SKCM_3DRNA) <- c("Cancer_cell_fractions", "Lymphocytes")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((lymph_SKCM_BPRNACan3DProMet - HE_SKCM_modif$Lymphocytes)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Lym_SKCM_3DRNA <- ggplot(as.data.frame(Lym_SKCM_3DRNA), aes(x = Lymphocytes, y = Cancer_cell_fractions)) +
  geom_point(colour = c("darkslategrey")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"BPRNACan3D") +
  scale_x_continuous(name = NULL, limits = c(0, max(Lym_SKCM_3DRNA))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Lym_SKCM_3DRNA))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)

Macro_SKCM_3DRNA <- cbind(Macro_SKCM_BPRNACan3DProMet, HE_SKCM_modif$Macrophages)
colnames(Macro_SKCM_3DRNA) <- c("Cancer_cell_fractions", "Macrophages")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((Macro_SKCM_BPRNACan3DProMet - HE_SKCM_modif$Macrophages)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Macro_SKCM_3DRNA <- ggplot(as.data.frame(Macro_SKCM_3DRNA), aes(x = Macrophages, y = Cancer_cell_fractions)) +
  geom_point(colour = c("coral")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"BPRNACan3D") +
  scale_x_continuous(name = NULL, limits = c(0, max(Macro_SKCM_3DRNA))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Macro_SKCM_3DRNA))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)


Neu_SKCM_3DRNA <- cbind(SKCM_BPRNACan3DProMet_decon$Neu, HE_SKCM_modif$Neutrophils)
colnames(Neu_SKCM_3DRNA) <- c("Cancer_cell_fractions", "Neutrophils")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((SKCM_BPRNACan3DProMet_decon$Neu - HE_SKCM_modif$Neutrophils)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Neu_SKCM_3DRNA <- ggplot(as.data.frame(Neu_SKCM_3DRNA), aes(x = Neutrophils, y = Cancer_cell_fractions)) +
  geom_point(colour = c("green")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"BPRNACan3D") +
  scale_x_continuous(name = NULL, limits = c(0, max(Neu_SKCM_3DRNA))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Neu_SKCM_3DRNA))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)


#### BPmetCan

#### lympho

Lym_SKCM_methy <- cbind(lymph_methy, HE_SKCM_modif$Lymphocytes)
colnames(Lym_SKCM_methy) <- c("Cancer_cell_fractions", "Lymphocytes")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((Lym_SKCM_methy - HE_SKCM_modif$Lymphocytes)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Lym_SKCM_BPmetCan <- ggplot(as.data.frame(Lym_SKCM_methy), aes(x = Lymphocytes, y = Cancer_cell_fractions)) +
  geom_point(colour = c("darkslategrey")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"BPmetCan") +
  scale_x_continuous(name = NULL, limits = c(0, max(Lym_SKCM_methy))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Lym_SKCM_methy))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)

#### Macro

Macro_Methy <- SKCM_methy_decon$M0 + SKCM_methy_decon$M1 + SKCM_methy_decon$M2 + SKCM_methy_decon$Mono

Macro_SKCM_methy <- cbind(Macro_Methy, HE_SKCM_modif$Macrophages)
colnames(Macro_SKCM_methy) <- c("Cancer_cell_fractions", "Macrophages")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((Macro_SKCM_methy - HE_SKCM_modif$Macrophages)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Macro_SKCM_BPmetCan <- ggplot(as.data.frame(Macro_SKCM_methy), aes(x = Macrophages, y = Cancer_cell_fractions)) +
  geom_point(colour = c("coral")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"BPmetCan") +
  scale_x_continuous(name = NULL, limits = c(0, max(Macro_Methy))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Macro_Methy))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)


#### Neu

Neu_SKCM_methy <- cbind(SKCM_methy_decon$Neu, HE_SKCM_modif$Neutrophils)
colnames(Neu_SKCM_methy) <- c("Cancer_cell_fractions", "Neutrophils")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((SKCM_methy_decon$Neu - HE_SKCM_modif$Neutrophils)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Neu_SKCM_BPmetCan <- ggplot(as.data.frame(Neu_SKCM_methy), aes(x = Neutrophils, y = Cancer_cell_fractions)) +
  geom_point(colour = c("green")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"BPmetCan") + 
  scale_x_continuous(name = NULL, limits = c(0, max(Neu_SKCM_methy))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Neu_SKCM_methy))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)



#### avrg

Lym_SKCM_avrg <- cbind(lymph_SKCM_BPRNACan_avr, HE_SKCM_modif$Lymphocytes)
colnames(Lym_SKCM_avrg) <- c("Cancer_cell_fractions", "Lymphocytes")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((lymph_SKCM_BPRNACan_avr - HE_SKCM_modif$Lymphocytes)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Lym_SKCM_avrg <- ggplot(as.data.frame(Lym_SKCM_avrg), aes(x = Lymphocytes, y = Cancer_cell_fractions)) +
  geom_point(colour = c("darkslategrey")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"Meth + RNA") + 
  scale_x_continuous(name = NULL, limits = c(0, max(Lym_SKCM_avrg))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Lym_SKCM_avrg))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)


Macro_SKCM_avrg <- cbind(Macro_SKCM_BPRNACan_avr, HE_SKCM_modif$Macrophages)
colnames(Macro_SKCM_avrg) <- c("Cancer_cell_fractions", "Macrophages")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean((Macro_SKCM_BPRNACan_avr - HE_SKCM_modif$Macrophages)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Macro_SKCM_avrg <- ggplot(as.data.frame(Macro_SKCM_avrg), aes(x = Macrophages, y = Cancer_cell_fractions)) +
  geom_point(colour = c("coral")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"Meth + RNA") +
  scale_x_continuous(name = NULL, limits = c(0, max(Macro_SKCM_avrg))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Macro_SKCM_avrg))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)

Neu_SKCM_avrg <- cbind(rowMeans(cbind(SKCM_BPRNACan_decon$Neu, SKCM_methy_decon$Neu)), HE_SKCM_modif$Neutrophils)
colnames(Neu_SKCM_avrg) <- c("Cancer_cell_fractions", "Neutrophils")
grob <- grobTree(textGrob(paste("RMSE = ", round(sqrt(mean(rowMeans(cbind(SKCM_BPRNACan_decon$Neu, SKCM_methy_decon$Neu) - HE_SKCM_modif$Neutrophils)^2, na.rm = T)), 2)), x=0.1,  y=0.8, hjust=0,
  gp=gpar(col="black", fontsize=15)))

fig_Neu_SKCM_avrg <- ggplot(as.data.frame(Neu_SKCM_avrg), aes(x = Neutrophils, y = Cancer_cell_fractions)) +
  geom_point(colour = c("green")) +
  theme_bw() +
  stat_smooth(method = lm, color = "black") +
  facet_wrap(~"Meth + RNA") + 
  scale_x_continuous(name = NULL, limits = c(0, max(Neu_SKCM_avrg))) +
  scale_y_continuous(name = NULL, limits = c(0, max(Neu_SKCM_avrg))) +
  font("xy.text", size = 16, color = "black") +
  theme(axis.title.x = element_text(vjust = -0.5), strip.text.x = element_text(size = 18, color = "black", face = "bold"), text = element_text(size = 20)) +
  stat_cor(method = "pearson", label.x = 0, size = 6) +
  annotation_custom(grob)



lymph = ggarrange(fig_Lym_SKCM_3DRNA, fig_Lym_SKCM_BPmetCan, fig_Lym_SKCM_avrg, ncol = 3, nrow = 1, labels = "a", font.label = list(size = 20, color = "black"), align = "hv")
neutro = ggarrange(fig_Neu_SKCM_3DRNA, fig_Neu_SKCM_BPmetCan, fig_Neu_SKCM_avrg, ncol = 3, nrow = 1, labels = "b", font.label = list(size = 20, color = "black"), align = "hv")
macro = ggarrange(fig_Macro_SKCM_3DRNA, fig_Macro_SKCM_BPmetCan, fig_Macro_SKCM_avrg, ncol = 3, nrow = 1, labels = "c", font.label = list(size = 20, color = "black"), align = "hv")


All_SKCM <- ggarrange(lymph, neutro, macro, ncol = 1, nrow = 3, font.label = list(size = 20, color = "black"), align = "hv")


All_SKCM <- annotate_figure(All_SKCM,
  left = text_grob("Estimated fractions", color = "black", size = 20, rot = 90),
  bottom = text_grob("H&E estimates", color = "black", size = 20)
  
)

All_SKCM
```
RNA, methylation, and averaged values of correlation across a : lymphocytes, b: neutrophils, c : macrophages, using the BPRNACan3D and BPMetCan signatures on EpiDish.

# Table of correlation

### Lymphocytes
```{r, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
lymph <- read.csv("/mnt/SERVER-CRCT-STORAGE/CRCT21/Private/Julien/gemdecan/data/all_tcga_corr/lymph.csv")
lymph_p <- read.csv("/mnt/SERVER-CRCT-STORAGE/CRCT21/Private/Julien/gemdecan/data/all_tcga_corr/lymph_p.csv")

melt_lymph <- melt(lymph)

melt_lymph_Pvalue <- melt(lymph_p)

merge_lymph <- cbind(melt_lymph, melt_lymph_Pvalue[, 3]) # %>% .[,-3]
colnames(merge_lymph)[4] <- "value.1"

melt_merge_lymph <- merge_lymph %>%
  mutate(variable = str_replace(variable, "Avg_Met_", "Average BPmetCan & "),
         variable = str_replace(variable, "BPRNACan3D$", "BPRNACan3DProMet"))
    
melt_merge_lymph$new_Var2 <- lymph$X
melt_merge_lymph$new_Var2 <- factor(melt_merge_lymph$new_Var2, levels = unique(melt_merge_lymph$new_Var2))

lymph_order <- dplyr::filter(melt_merge_lymph, X == "Mean") %>%
  dplyr::arrange(value)

    
lymph_figure <- dplyr::mutate(melt_merge_lymph, variable = factor(variable, levels = lymph_order$variable)) %>% dplyr::arrange(factor(variable, levels = lymph_order$variable)) %>%
    ggplot( aes(new_Var2, variable, fill = value, label=round(value,2))) +
    geom_tile() +
      labs(x = NULL, y = NULL, fill = "Spearman's\nCorrelation", title= "Lymphocytes") +
    scale_fill_gradient2(mid="#FBFEF9",low="#0C6291",high="#A63446", limits=c(-1,1)) +
    geom_text() +
    theme_classic() +
    scale_x_discrete(expand=c(0,0)) +
    scale_y_discrete(expand=c(0,0)) +
    rotate_x_text(angle = 45)
  

lymph_figure
```

### Macrophages
```{r, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
macro <- read.csv("/mnt/SERVER-CRCT-STORAGE/CRCT21/Private/Julien/gemdecan/data/all_tcga_corr/macro.csv")
macro_p <- read.csv("/mnt/SERVER-CRCT-STORAGE/CRCT21/Private/Julien/gemdecan/data/all_tcga_corr/macro_p.csv")

melt_macro <- melt(macro)

melt_macro_Pvalue <- melt(macro_p)

merge_macro <- cbind(melt_macro, melt_macro_Pvalue[, 3]) # %>% .[,-3]
colnames(merge_macro)[4] <- "value.1"
melt_merge_macro <- merge_macro %>%
  mutate(text = case_when(
    is.na(value.1) & is.na(value) ~ paste("NA"),
    is.na(value.1) & (value == 0) ~ paste(value, "\n"),
    value.1 >= 0.05 ~ paste(value),
    value.1 >= 0.01 & value.1 < 0.05 ~ paste(value, "\n*"),
    value.1 >= 0.001 & value.1 < 0.01 ~ paste(value, "\n**"),
    value.1 < 0.001 ~ paste(value, "\n***")
  ))

melt_merge_macro$new_Var2 <- macro$X
melt_merge_macro$new_Var2 <- factor(melt_merge_macro$new_Var2, levels = unique(melt_merge_macro$new_Var2))

macro_figure <- ggplot(melt_merge_macro, aes(new_Var2, variable)) +
  geom_tile(aes(fill = value), colour = "grey", size = 1) +
  scale_fill_gradient2(low = "#5C5DAF", mid = "white", high = "#EA2E2D") +
  geom_text(aes(label = text), col = "black", size = 4) +
  theme_minimal() +
  theme(
    axis.title.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.y = element_blank(),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 14),
    axis.text.x = element_text(
      angle = 90, hjust = 0.5, vjust = 0.5,
      size = 14, colour = "black", face="bold"
    ),
    axis.text.y = element_text(size = 14, colour = "black", face="bold")
  ) +
  labs(fill = paste0("Correlation")) +
  ggtitle("Macrophages") +
  theme(plot.title = element_text(hjust = 0.5, size = 16))
macro_figure
```

### Neutrophils
```{r, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
neutro <- read.csv("/mnt/SERVER-CRCT-STORAGE/CRCT21/Private/Julien/gemdecan/data/all_tcga_corr/neutro.csv")
neutro_p <- read.csv("/mnt/SERVER-CRCT-STORAGE/CRCT21/Private/Julien/gemdecan/data/all_tcga_corr/neutro_p.csv")

melt_neutro <- melt(neutro)

melt_neutro_Pvalue <- melt(neutro_p)

merge_neutro <- cbind(melt_neutro, melt_neutro_Pvalue[, 3]) # %>% .[,-3]
colnames(merge_neutro)[4] <- "value.1"
melt_merge_neutro <- merge_neutro %>%
  mutate(text = case_when(
    is.na(value.1) & is.na(value) ~ paste("NA"),
    is.na(value.1) & (value == 0) ~ paste(value, "\n"),
    value.1 >= 0.05 ~ paste(value),
    value.1 >= 0.01 & value.1 < 0.05 ~ paste(value, "\n*"),
    value.1 >= 0.001 & value.1 < 0.01 ~ paste(value, "\n**"),
    value.1 < 0.001 ~ paste(value, "\n***")
  ))

melt_merge_neutro$new_Var2 <- neutro$X
melt_merge_neutro$new_Var2 <- factor(melt_merge_neutro$new_Var2, levels = unique(melt_merge_neutro$new_Var2))

neutro_figure <- ggplot(melt_merge_neutro, aes(new_Var2, variable)) +
  geom_tile(aes(fill = value), colour = "grey", size = 1) +
  scale_fill_gradient2(low = "#5C5DAF", mid = "white", high = "#EA2E2D") +
  geom_text(aes(label = text), col = "black", size = 4) +
  theme_minimal() +
  theme(
    axis.title.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.y = element_blank(),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 14),
    axis.text.x = element_text(
      angle = 90, hjust = 0.5, vjust = 0.5,
      size = 14, colour = "black", face="bold"
    ),
    axis.text.y = element_text(size = 14, colour = "black", face="bold")
  ) +
  labs(fill = paste0("Correlation")) +
  ggtitle("Neutrophils") +
  theme(plot.title = element_text(hjust = 0.5, size = 16))
neutro_figure
```
